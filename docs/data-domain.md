# Data and Domain

This module covers the persistence layer and core domain types.

## Data layer

### `Data/ApplicationDbContext.cs`
Derives from `IdentityDbContext<ApplicationUser>` and exposes tables for `Projects`, `TodoItems`, `Celebrations`, `AuthEvents`, `DailyLoginStats`, `AuditLogs` and now `Events` for the calendar. Indexes on `TodoItem` enforce fast lookups by owner and due date, while `Event` rows are filtered by `IsDeleted` and indexed on `StartUtc` and `EndUtc` for range queries. Identity tables (users, roles, claims, etc.) are provided by the base class.

### `Data/DesignTimeDbContextFactory.cs`
Provides a design-time factory so Entity Framework tooling can create the context when running migrations. It reads configuration from `appsettings.json`, `appsettings.Development.json`, or environment variables.

### `Data/IdentitySeeder.cs`
Seeds initial roles (`Project Officer`, `HoD`, `Comdt`, `Admin`, `TA`, `MCO`, `Project Office`, `Main Office`) and creates a default `admin` account with the password `ChangeMe!123` if it does not already exist. The `admin` user has `MustChangePassword` set to `false` so it can log in immediately.

## Domain model

### `Models/ApplicationUser.cs`
Extends `IdentityUser` with a `MustChangePassword` flag. New accounts are created with the flag set to `true`, forcing a password change on first login via `EnforcePasswordChangeFilter`.

### `Models/Project.cs`
Holds the master record for a project. Beyond its name/description it stores the case file reference, creator, category, active plan version and assignment metadata for the Head of Department and Lead Project Officer. `PlanApprovedAt/ByUserId` capture the latest plan approval event and the navigation properties surface related user records for UI display. `ProjectStages` now owns the execution stages collection and the obsolete `Stages` property simply proxies to it for backward compatibility.

### `Models/ProjectCategory.cs`
Allows projects to be organised in a hierarchy. Each category exposes a `ParentId` so breadcrumb trails can be built and circular references are guarded against in the overview loader.

### `Models/Execution/ProjectStage.cs`
Represents each procurement or delivery milestone for a project. Rows track planned, forecast and actual dates, completion status, auto-completion metadata and whether the stage still needs backfilling. The `StageCodes` helper enumerates canonical codes (FS, IPA, SOW, …, PAYMENT) and exposes human readable display names.

### `Models/ProjectFacts.cs`
Defines fact tables that capture procurement milestones. IPA, AON, benchmark, L1 and PNC costs, along with the supply-order date and SOW sponsoring units, derive from a shared `ProjectFactBase` that records who captured the fact and when. Each fact table carries a concurrency token so editors get reliable conflict detection when procurement numbers evolve.

### `Models/TodoItem.cs`
Represents a personal task owned by a user. Each item records a title, due date (stored in UTC), priority, pin state, order index and timestamps for creation, updates, completion and soft deletion. PostgreSQL's `xmin` concurrency token is used to detect conflicting edits. Items marked completed are soft-deleted by setting `DeletedUtc`; a background worker purges entries older than the configured retention period.

### `Models/Celebration.cs`
Stores birthdays and anniversaries with minimal fields for annual recurrence. Each row tracks the event type, name(s), day and month, optional year, creator metadata and soft-delete timestamp. Indexes on `(EventType, Month, Day)` enable fast upcoming lookups and a filtered index on `DeletedUtc` hides removed entries. Leap day events are rendered on 28 February in non-leap years.

### `Models/AuthEvent.cs`
Records successful authentication events. Each row stores the user ID, timestamp (UTC), IP address and user agent for audit and analytics. Indexed by event name and time for efficient querying.

### `Models/DailyLoginStat.cs`
Holds pre-aggregated daily login counts generated by `LoginAggregationWorker`. Aggregation reduces load on the primary `AuthEvents` table for long-range reporting.

### `Models/Event.cs`
Represents a calendar event visible to all signed-in users. Each row stores a title, optional Markdown description, category, location, UTC start/end times (exclusive end), an `IsAllDay` flag and creator/updater metadata. Soft deletion hides events without removing them from the database. Categories are restricted to **Visit**, **Insp**, **Conference** and **Other**; legacy values like "Training" or "TownHall" are mapped by `CategoryParser` and unrecognised strings fall back to `Other`.

### `Models/AuditLog.cs`
Captures structured audit entries with timestamps, action names, user metadata, IP addresses and optional payloads. Sensitive fields are scrubbed by `AuditService` before persistence.

### Timeline planning and scheduling (`Models/Plans`, `Models/Scheduling`)
Timeline expectations are stored as `PlanVersion` rows. Each project maintains at most one open version (status **Draft** or **PendingApproval**) and a history of approved versions.

* **Draft** rows are editable by the assigned Project Officer (PO) or an administrator. Edits are captured in `StagePlan` children and persisted without affecting the live `ProjectStages` table.
* When a PO selects *Save & request approval*, `PlanApprovalService.SubmitAsync` validates the stage data and transitions the record to **PendingApproval**, stamping `SubmittedByUserId`/`SubmittedOn`. The draft becomes read-only until the Head of Department (HoD) acts.
* HoDs review diffs via `PlanCompareService.GetDraftVsCurrentAsync`, with UI highlights showing the left/right comparison. Approving publishes `StagePlan` dates into `ProjectStages`, records an immutable snapshot (`ProjectPlanSnapshot` + rows), updates `Project.PlanApprovedAt/ByUserId` and marks the version **Approved**.
* Rejecting moves the status back to **Draft**, captures optional feedback in `RejectionNote` and stamps `RejectedByUserId`/`RejectedOn`. The PO immediately regains edit access.
* The new `RejectedByUserId` column is a nullable foreign key to `AspNetUsers`; the previous `Reason` column has been renamed to `RejectionNote`.
* Backfill guards are enforced both in the UI and server (`PlanApprovalService.ApproveLatestDraftAsync`) to prevent approval while earlier stages require completion.

`PlanEditorStateVm` gathers the metadata (status, submission/rejection timestamps, lock state) consumed by Razor components so that locking, banners and validation messaging stay consistent across edit and review experiences.

`ProjectScheduleSettings` lets teams compute draft schedules from durations by storing anchors, working-day preferences and stage chaining policies, while `ProjectPlanDuration` keeps the per-stage duration catalog that powers the bulk duration editor.

### `Models/ProjectComment.cs`
Supports threaded discussions around a project or a specific stage. Comments enforce minimum/maximum lengths, carry typed categorisation (Update, Risk, Blocker, Decision, Info), allow pinning and track soft deletion. Attachments and mentions are separate tables linked back to the owning comment with foreign keys and capture uploader metadata plus sanitised filenames for storage.

### Notifications (`Models/Notifications/*`)
* **`Notification`** – materialised rows that power the user-facing notification centre. Metadata columns (`Module`, `EventType`, `ScopeType`, `ScopeId`, `Route`, `Title`, `Summary`) come from the original dispatch envelope and timestamps track when a user sees or reads the item.【F:Models/Notifications/Notification.cs†L5-L40】
* **`NotificationDispatch`** – queue table processed by `NotificationDispatcher`. It stores the serialised payload, retry counters, dispatch timestamps, and optional error text so failed deliveries can be diagnosed.【F:Models/Notifications/NotificationDispatch.cs†L5-L44】
* **`UserNotificationPreference`** – per-kind opt-in/out switches evaluated before persisting new notifications.【F:Models/Notifications/UserNotificationPreference.cs†L3-L10】
* **`UserProjectMute`** – association table that hides notifications for specific projects when the user has muted them through the API.【F:Models/Notifications/UserProjectMute.cs†L3-L8】

### Project documents (`Models/ProjectDocument*.cs`)
* **`ProjectDocument`** – published artefacts with metadata (title, description, stage link, storage key, MIME type, file stamp, archival state) and a `RowVersion` concurrency token to prevent conflicting edits.【F:Models/ProjectDocument.cs†L13-L78】
* **`ProjectDocumentRequest`** – workflow table that tracks document uploads/replacements/deletions before publication. Includes request type, reviewer metadata, temporary storage keys, and audit notes for approvals or rejections.【F:Models/ProjectDocumentRequest.cs†L23-L85】

### Process templates (`Models/Stages/StageChecklistTemplate.cs`)
Stage templates drive the process designer UI and REST APIs:
* **`StageChecklistTemplate`** – versioned container per stage code with optimistic concurrency and audit trails.【F:Models/Stages/StageChecklistTemplate.cs†L8-L29】
* **`StageChecklistItemTemplate`** – ordered checklist items with per-item row versions and editor metadata.【F:Models/Stages/StageChecklistTemplate.cs†L32-L52】
* **`StageChecklistAudit`** – immutable log of checklist edits, including payload snapshots and timestamps for compliance reporting.【F:Models/Stages/StageChecklistTemplate.cs†L55-L76】

