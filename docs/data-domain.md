# Data and Domain

This module covers the persistence layer and core domain types.

## Data layer

### `Data/ApplicationDbContext.cs`
Derives from `IdentityDbContext<ApplicationUser>` and exposes tables for `Projects`, `TodoItems`, `Celebrations`, `AuthEvents`, `DailyLoginStats`, `AuditLogs` and now `Events` for the calendar. Indexes on `TodoItem` enforce fast lookups by owner and due date, while `Event` rows are filtered by `IsDeleted` and indexed on `StartUtc` and `EndUtc` for range queries. Identity tables (users, roles, claims, etc.) are provided by the base class.

### `Data/DesignTimeDbContextFactory.cs`
Provides a design-time factory so Entity Framework tooling can create the context when running migrations. It reads configuration from `appsettings.json`, `appsettings.Development.json`, or environment variables.

### `Data/IdentitySeeder.cs`
Seeds initial roles (`Project Officer`, `HoD`, `Comdt`, `Admin`, `TA`, `MCO`, `Project Office`, `Main Office`) and creates a default `admin` account with the password `ChangeMe!123` if it does not already exist. The `admin` user has `MustChangePassword` set to `false` so it can log in immediately.

## Domain model

### `Models/ApplicationUser.cs`
Extends `IdentityUser` with a `MustChangePassword` flag. New accounts are created with the flag set to `true`, forcing a password change on first login via `EnforcePasswordChangeFilter`.

### `Models/Project.cs`
Represents a simple project with a name, optional description and creation timestamp for future grouping of data.

### `Models/TodoItem.cs`
Represents a personal task owned by a user. Each item records a title, due date (stored in UTC), priority, pin state, order index and timestamps for creation, updates, completion and soft deletion. PostgreSQL's `xmin` concurrency token is used to detect conflicting edits. Items marked completed are soft-deleted by setting `DeletedUtc`; a background worker purges entries older than the configured retention period.

### `Models/Celebration.cs`
Stores birthdays and anniversaries with minimal fields for annual recurrence. Each row tracks the event type, name(s), day and month, optional year, creator metadata and soft-delete timestamp. Indexes on `(EventType, Month, Day)` enable fast upcoming lookups and a filtered index on `DeletedUtc` hides removed entries. Leap day events are rendered on 28 February in non-leap years.

### `Models/AuthEvent.cs`
Records successful authentication events. Each row stores the user ID, timestamp (UTC), IP address and user agent for audit and analytics. Indexed by event name and time for efficient querying.

### `Models/DailyLoginStat.cs`
Holds pre-aggregated daily login counts generated by `LoginAggregationWorker`. Aggregation reduces load on the primary `AuthEvents` table for long-range reporting.

### `Models/Event.cs`
Represents a calendar event visible to all signed-in users. Each row stores a title, optional Markdown description, category, location, UTC start/end times (exclusive end), an `IsAllDay` flag and creator/updater metadata. Soft deletion hides events without removing them from the database. Categories are restricted to **Visit**, **Insp**, **Conference** and **Other**; legacy values like "Training" or "TownHall" are mapped by `CategoryParser` and unrecognised strings fall back to `Other`.

### `Models/AuditLog.cs`
Captures structured audit entries with timestamps, action names, user metadata, IP addresses and optional payloads. Sensitive fields are scrubbed by `AuditService` before persistence.

