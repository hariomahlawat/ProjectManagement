@model ProjectManagement.Models.Analytics.StageTimeInsightsVm
@using System.Text.Json
@using ProjectManagement.Pages.Analytics

@{
    var jsonOptions = new JsonSerializerOptions
    {
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase
    };

    var categories = ViewData["AnalyticsCategories"] as IEnumerable<IndexModel.CategoryOption>
        ?? Array.Empty<IndexModel.CategoryOption>();
    var selectedCategoryId = Model.SelectedCategoryId;
    var filterId = "project-category-filter";
}

<!-- SECTION: Project management insights -->
<section class="analytics-panel analytics-panel--insights" aria-label="Project management insights">
    <div class="analytics-layout analytics-layout--shell">
        <div class="analytics-layout__row">
            <article class="analytics-card analytics-card--wide">
                <header class="analytics-card__header">
                    <div class="d-flex justify-content-between align-items-start gap-3">
                        <div>
                            <h2 class="analytics-card__title">Stage cycle time by Project Cost Band</h2>
                            <p class="analytics-card__meta">
                                Median days spent in each completed stage, grouped by the latest recorded procurement cost bucket.
                                Active stages from ongoing projects are excluded until those stages finish.
                            </p>
                        </div>

                        <!-- SECTION: Project category filter -->
                        <form method="get" asp-page="./Index" class="analytics-card__filters">
                            <input type="hidden" name="tab" value="Insights" />
                            <div class="analytics-card__filter-chip">
                                <label class="form-label mb-0" for="@filterId">
                                    Project category
                                </label>
                                <select
                                    id="@filterId"
                                    name="categoryId"
                                    class="form-select form-select-sm"
                                    data-auto-submit="change"
                                >
                                    <option
                                        value=""
                                        selected="@(!selectedCategoryId.HasValue ? "selected" : null)"
                                    >
                                        All
                                    </option>
                                    @foreach (var category in categories)
                                    {
                                        var isSelected = selectedCategoryId.HasValue && selectedCategoryId.Value == category.Id;
                                        <option
                                            value="@category.Id"
                                            selected="@(isSelected ? "selected" : null)"
                                        >
                                            @category.Name
                                        </option>
                                    }
                                </select>
                            </div>
                        </form>
                        <!-- END SECTION -->
                    </div>
                </header>

                <div class="analytics-card__body">
                    @if (!Model.HasData)
                    {
                        <p class="analytics-card__empty-text">
                            Not enough finished stages yet to calculate cycle times.
                        </p>
                    }
                    else
                    {
                        <div class="analytics-card__chart">
                            <canvas
                                id="stage-time-by-cost-chart"
                                role="img"
                                aria-label="Stage cycle time by project cost bucket"
                                data-series='@Html.Raw(JsonSerializer.Serialize(Model.Rows, jsonOptions))'
                                data-empty-message="Not enough finished stages yet to calculate cycle times."
                            ></canvas>
                        </div>

                        <p class="analytics-card__footnote">
                            Only stages with both actual start and completion dates are counted.
                            Stages from ongoing projects are only included once they complete.
                            Cost buckets use the latest AoN, benchmark, PNC, L1, or IPA entry available per project.
                        </p>
                    }
                </div>
            </article>
        </div>
    </div>
</section>
<!-- END SECTION -->
