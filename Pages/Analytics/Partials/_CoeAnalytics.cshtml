@model ProjectManagement.Models.Analytics.CoeAnalyticsVm
@using System.Linq
@using System.Text.Json

@{
    // SECTION: JSON serialiser options
    var jsonOptions = new JsonSerializerOptions
    {
        PropertyNamingPolicy = JsonNamingPolicy.CamelCase
    };

    var noCoeProjectsMessage = "No CoE projects to analyse yet. Create a CoE project to see analytics here.";
    var noSubcategoryMessage = "CoE sub-category breakdown will appear here once projects have sub-categories configured.";
    var noSubcategoryProjectsMessage = "No CoE projects with sub-categories configured yet.";
    // END SECTION
}

<section class="analytics-panel analytics-panel--coe" aria-label="CoE projects analytics">
    <!-- SECTION: CoE analytics layout -->
    <div class="analytics-layout analytics-layout--shell">
        <!-- SECTION: CoE stage chart -->
        <div class="analytics-layout__row">
            <article class="analytics-card analytics-card--wide">
                <header class="analytics-card__header">
                    <h2 class="analytics-card__title">Ongoing CoE projects by current stage</h2>
                    <p class="analytics-card__meta">
                        Current stage distribution for active CoE projects.
                    </p>
                </header>
                <div class="analytics-card__body">
                    @if (!Model.HasCoeProjects)
                    {
                        <p class="analytics-card__empty-text">@noCoeProjectsMessage</p>
                    }
                    else
                    {
                        <div class="analytics-card__chart">
                            <canvas id="coe-by-stage-chart"
                                    role="img"
                                    aria-label="Ongoing CoE projects by current stage"
                                    data-series='@Html.Raw(JsonSerializer.Serialize(Model.ByStage, jsonOptions))'>
                            </canvas>
                        </div>
                    }
                </div>
            </article>
        </div>
        <!-- END SECTION -->

        <!-- SECTION: CoE sub-category lifecycle chart -->
        <div class="analytics-layout__row">
            <article class="analytics-card analytics-card--wide analytics-card--coe-subcategories">
                <header class="analytics-card__header">
                    <h2 class="analytics-card__title">CoE sub-categories by lifecycle</h2>
                    <p class="analytics-card__meta">
                        Distribution of CoE sub-categories across lifecycle statuses.
                    </p>
                </header>
                <div class="analytics-card__body">
                    @if (!Model.HasSubcategoryBreakdown)
                    {
                        <p class="analytics-card__empty-text">@noSubcategoryMessage</p>
                    }
                    else
                    {
                        <div class="analytics-card__chart analytics-card__chart--scrollable">
                            <canvas id="coe-subcategories-by-lifecycle-chart"
                                    role="img"
                                    aria-label="CoE sub-categories by lifecycle status"
                                    data-series='@Html.Raw(JsonSerializer.Serialize(Model.SubcategoriesByLifecycle, jsonOptions))'>
                            </canvas>
                        </div>
                        <p class="analytics-card__footnote">Only CoE sub-categories with at least one project are shown.</p>
                    }
                </div>
            </article>
        </div>
        <!-- END SECTION -->

        <!-- SECTION: CoE projects by sub-category -->
        <section class="analytics-roadmap analytics-roadmap--coe-subcategories"
                 aria-label="CoE projects by sub-category">
            @if (!(Model.SubcategoryProjects?.Any() ?? false))
            {
                <div class="analytics-roadmap__column">
                    <h3 class="analytics-roadmap__heading">CoE sub-categories</h3>
                    <p class="analytics-roadmap__empty">
                        @noSubcategoryProjectsMessage
                    </p>
                </div>
            }
            else
            {
                @foreach (var bucket in Model.SubcategoryProjects)
                {
                    <div class="analytics-roadmap__column">
                        <h3 class="analytics-roadmap__heading">@bucket.SubcategoryName</h3>
                        <ul class="analytics-roadmap__list">
                            @foreach (var project in bucket.Projects)
                            {
                                <li class="analytics-roadmap__item">
                                    <span class="analytics-roadmap__project-name">@project.Name</span>
                                    <span class="analytics-roadmap__project-meta">
                                        @project.LifecycleStatus Â· @project.CurrentStage
                                    </span>
                                </li>
                            }
                        </ul>
                    </div>
                }
            }
        </section>
        <!-- END SECTION -->
    </div>
    <!-- END SECTION -->
</section>
