@page
@model ProjectManagement.Pages.Analytics.IndexModel
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using ProjectManagement.Services.Projects
@using ProjectManagement.Pages.Analytics
@{
    ViewData["Title"] = "Analytics";
    ViewData["UseFullWidth"] = true;
    var lifecycleOptions = new[]
    {
        ProjectLifecycleFilter.Active,
        ProjectLifecycleFilter.Completed,
        ProjectLifecycleFilter.Cancelled,
        ProjectLifecycleFilter.All
    };
    var categories = Model.Categories ?? Array.Empty<ProjectManagement.Pages.Analytics.IndexModel.CategoryOption>();
    var technicalCategories = Model.TechnicalCategories ?? Array.Empty<ProjectManagement.Pages.Analytics.IndexModel.TechnicalCategoryOption>();
    var categoryCount = categories.Count;
    var technicalCount = technicalCategories.Count;
}

<section class="analytics-page">
  <!-- Hero section: summary metrics -->
  <header class="analytics-hero pm-shadow">
    <div class="analytics-hero__text">
      <h1 class="analytics-title">Project analytics</h1>
      <p class="analytics-subtitle">
        Explore project trends and delivery health at a glance. Each visualization can be filtered independently to uncover the next best action.
      </p>
    </div>
    <dl class="analytics-hero__stats">
      <div class="analytics-hero__stat">
        <dt class="analytics-hero__stat-label">Lifecycle views</dt>
        <dd class="analytics-hero__stat-value">@lifecycleOptions.Length</dd>
      </div>
      <div class="analytics-hero__stat">
        <dt class="analytics-hero__stat-label">Categories tracked</dt>
        <dd class="analytics-hero__stat-value">@categoryCount</dd>
      </div>
      <div class="analytics-hero__stat">
        <dt class="analytics-hero__stat-label">Technical groups</dt>
        <dd class="analytics-hero__stat-value">@technicalCount</dd>
      </div>
    </dl>
  </header>

  <!-- Analytics layout: mode navigation and chart canvas -->
  <div
    id="analytics-root"
    data-default-lifecycle="@Model.DefaultLifecycle"
    data-projects-index-url="@Url.Page("/Projects/Index")"
    data-project-overview-url="@Url.Page("/Projects/Overview")"
  >
    <section class="analytics-layout" aria-label="Project analytics views">
      <aside class="analytics-left-rail" aria-label="Analytics modes">
        <!-- Left navigation for analytics modes -->
        <nav class="analytics-left-nav" aria-label="Analytics views">
          <a
            asp-page="./Index"
            asp-route-tab="Completed"
            class="analytics-left-nav__item @(Model.ActiveTab == IndexModel.AnalyticsViewTab.Completed ? "is-active" : null)"
          >
            <div class="analytics-left-nav__title">Completed projects</div>
            <div class="analytics-left-nav__meta">@Model.CompletedCount projects</div>
          </a>

          <a
            asp-page="./Index"
            asp-route-tab="Ongoing"
            class="analytics-left-nav__item @(Model.ActiveTab == IndexModel.AnalyticsViewTab.Ongoing ? "is-active" : null)"
          >
            <div class="analytics-left-nav__title">Ongoing projects</div>
            <div class="analytics-left-nav__meta">@Model.OngoingCount projects</div>
          </a>

          <a
            asp-page="./Index"
            asp-route-tab="Coe"
            class="analytics-left-nav__item @(Model.ActiveTab == IndexModel.AnalyticsViewTab.Coe ? "is-active" : null)"
          >
            <div class="analytics-left-nav__title">CoE projects</div>
            <div class="analytics-left-nav__meta">@Model.CoeCount projects</div>
          </a>
        </nav>
      </aside>

      <div class="analytics-main" data-role="analytics-main">
        <!-- Analytics content panel -->
        <div class="analytics-main-panel">
          @if (Model.ActiveTab == IndexModel.AnalyticsViewTab.Completed)
          {
            @await Html.PartialAsync("_CompletedProjectsAnalytics", Model)
          }
          else if (Model.ActiveTab == IndexModel.AnalyticsViewTab.Ongoing)
          {
            @await Html.PartialAsync("_OngoingProjectsAnalytics", Model)
          }
          else if (Model.ActiveTab == IndexModel.AnalyticsViewTab.Coe)
          {
            @await Html.PartialAsync("_CoeProjectsAnalytics", Model)
          }
        </div>
      </div>
    </section>
  </div>
</section>

@section Scripts {
  <script src="~/lib/chart.js/chart.umd.js" asp-append-version="true"></script>
  <script type="module" src="~/js/analytics-projects.js" asp-append-version="true"></script>
}
