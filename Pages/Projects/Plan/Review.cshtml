@page
@model ProjectManagement.Pages.Projects.Plan.ReviewModel
@{
    ViewData["Title"] = "Project Timeline Review";
}

<h1 class="mb-3">Project Timeline Review</h1>
<p class="text-muted">Project: <strong>@Model.ProjectName</strong></p>
@if (Model.Plan is not null)
{
    <dl class="row">
        <dt class="col-sm-3">Version</dt>
        <dd class="col-sm-9">@Model.Plan.VersionNo (@Model.Plan.Status)</dd>

        <dt class="col-sm-3">Submitted On</dt>
        <dd class="col-sm-9">
            @if (Model.Plan.SubmittedOn.HasValue)
            {
                @Model.Plan.SubmittedOn.Value.ToLocalTime().ToString("dd MMM yyyy HH:mm")
            }
            else
            {
                <span class="text-muted">Not available</span>
            }
        </dd>

        <dt class="col-sm-3">Submitted By</dt>
        <dd class="col-sm-9">
            @if (Model.Plan.SubmittedByUser is not null)
            {
                @($"{Model.Plan.SubmittedByUser.Rank} {Model.Plan.SubmittedByUser.FullName}")
            }
            else
            {
                @Model.Plan.SubmittedByUserId
            }
        </dd>
    </dl>
}

<div asp-validation-summary="ModelOnly" class="text-danger"></div>

<div class="table-responsive mb-4">
    <table class="table table-sm align-middle">
        <thead>
            <tr>
                <th scope="col" style="width: 6rem;">Stage</th>
                <th scope="col">Description</th>
                <th scope="col" style="width: 12rem;">Planned Start</th>
                <th scope="col" style="width: 12rem;">Planned Due</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var stage in Model.Stages)
        {
            <tr>
                <td>
                    <div class="fw-semibold">@stage.Code</div>
                </td>
                <td>
                    <div class="fw-semibold">@stage.Name</div>
                </td>
                <td>@stage.PlannedStart?.ToString("dd MMM yyyy")</td>
                <td>@stage.PlannedDue?.ToString("dd MMM yyyy")</td>
            </tr>
        }
        </tbody>
    </table>
</div>

@if (Model.CanAct)
{
    <div class="d-flex flex-column flex-md-row gap-3">
        <form method="post" asp-page-handler="Approve" asp-route-id="@Model.ProjectId" class="d-flex align-items-end gap-2">
            <button type="submit" class="btn btn-success">Approve</button>
        </form>
        <form method="post" asp-page-handler="Reject" asp-route-id="@Model.ProjectId" class="flex-fill">
            <div class="mb-2">
                <label asp-for="Note" class="form-label">Rejection Note</label>
                <textarea asp-for="Note" class="form-control" rows="3"></textarea>
                <span asp-validation-for="Note" class="text-danger"></span>
            </div>
            <button type="submit" class="btn btn-danger">Reject</button>
        </form>
    </div>
}
else
{
    <div class="alert alert-info" role="alert">
        This plan is no longer pending approval.
    </div>
}

<a class="btn btn-outline-secondary mt-3" asp-page="/Projects/View" asp-route-id="@Model.ProjectId">Back to Project</a>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
