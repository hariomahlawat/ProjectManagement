@model IReadOnlyList<ProjectManagement.Services.Stages.PlanCompareService.PlanDiffRow>
@using System.Linq
@using ProjectManagement.Models.Stages

@if (Model is null || Model.Count == 0)
{
    <div class="alert alert-secondary">No draft plan found to review.</div>
    <div class="text-end">
        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="offcanvas">Close</button>
    </div>
}
else
{
    var hasChanges = Model.Any(row => row.NewStart != row.OldStart || row.NewDue != row.OldDue);
    var requiresBackfill = ViewBag.HasBackfill is bool hb && hb;
    <div class="small text-muted mb-2">
        <span>Draft plan compared against the current timeline.</span>
    </div>

    if (requiresBackfill)
    {
        <div class="alert alert-warning">Backfill required data before approval.</div>
    }

    @if (!hasChanges)
    {
        <div class="alert alert-info">The draft plan matches the current timeline.</div>
    }

    <div class="table-responsive">
        <table class="table table-sm align-middle">
            <thead>
                <tr>
                    <th>Stage</th>
                    <th class="text-center">Current timeline</th>
                    <th class="text-center">Draft plan</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var row in Model)
            {
                var changed = row.OldStart != row.NewStart || row.OldDue != row.NewDue;
                <tr class="@(changed ? "table-warning" : "table-secondary")">
                    <td>
                        <span class="fw-semibold">@StageCodes.DisplayNameOf(row.Code)</span>
                        <div class="text-muted small">@row.Code</div>
                    </td>
                    <td class="text-center">
                        @((row.OldStart?.ToString("yyyy-MM-dd") ?? "—") + " → " + (row.OldDue?.ToString("yyyy-MM-dd") ?? "—"))
                    </td>
                    <td class="text-center">
                        @((row.NewStart?.ToString("yyyy-MM-dd") ?? "—") + " → " + (row.NewDue?.ToString("yyyy-MM-dd") ?? "—"))
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    <form method="post" asp-page="/Projects/Timeline/Review" asp-route-id="@ViewBag.ProjectId" class="d-flex gap-2 justify-content-end mt-3">
        @Html.AntiForgeryToken()
        <input type="hidden" name="Input.ProjectId" value="@ViewBag.ProjectId" />
        <button name="Input.Decision" value="Reject" class="btn btn-outline-secondary">Reject</button>
        <button name="Input.Decision" value="Approve" class="btn btn-primary" @(requiresBackfill ? "disabled" : null)>Approve plan</button>
    </form>
}
