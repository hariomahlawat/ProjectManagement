@model IReadOnlyList<ProjectManagement.Services.Stages.PlanDiffRow>
@inject ProjectManagement.Models.Stages.IWorkflowStageMetadataProvider WorkflowStageMetadataProvider

@{
    var workflowVersion = ViewBag.WorkflowVersion as string;
}
@using System.Linq
@using ProjectManagement.Models.Plans
@using ProjectManagement.Models.Stages
@using ProjectManagement.ViewModels

@{
    var planState = ViewBag.PlanState as PlanEditorStateVm;
    var status = planState?.Status;
    var isPending = status == PlanVersionStatus.PendingApproval;
    var requiresBackfill = ViewBag.HasBackfill is bool hb && hb;
    var submittedOn = planState?.SubmittedOn;
    var submittedBy = planState?.SubmittedBy;
}

@if (Model is null || Model.Count == 0)
{
    <div class="alert alert-secondary">No draft plan found to review.</div>
    <div class="text-end">
        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="offcanvas">Close</button>
    </div>
}
else
{
    <div class="small text-muted mb-2">
        <span>Draft plan compared against the current timeline.</span>
    </div>

    @* show reason if this draft was auto created due to late completion *@
    @if (TempData["RealignmentInfo"] is string ri)
    {
        <div class="alert alert-info mb-2">
            @ri
        </div>
    }

    if (submittedOn is DateTimeOffset submitted)
    {
        <div class="mb-2 text-muted small">
            Submitted on @submitted.ToLocalTime().ToString("dd MMM yyyy")
            @if (!string.IsNullOrWhiteSpace(submittedBy))
            {
                <text>by @submittedBy</text>
            }
        </div>
    }

    if (!isPending)
    {
        <div class="alert alert-info">No draft has been submitted for approval.</div>
    }
    if (requiresBackfill)
    {
        <div class="alert alert-warning">Some earlier stages were auto-completed and still need dates or costs (procurement backfill pending). This does not block approval of the timeline, but should be addressed separately in the procurement details.</div>
    }

    var hasChanges = Model.Any(row => row.NewStart != row.OldStart || row.NewDue != row.OldDue);

    @if (!hasChanges)
    {
        <div class="alert alert-info">No differences between current plan and draft. You can still approve to stamp and snapshot.</div>
    }

    <div class="table-responsive">
        <table class="table table-sm align-middle">
            <thead>
                <tr>
                    <th>Stage</th>
                    <th class="text-center">Current timeline</th>
                    <th class="text-center">Draft plan</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var row in Model)
                {
                    var changed = row.OldStart != row.NewStart || row.OldDue != row.NewDue;
                    <tr class="@(changed ? "table-warning" : "table-secondary")">
                        <td>
                            <span class="fw-semibold">@WorkflowStageMetadataProvider.GetDisplayName(workflowVersion, row.StageCode)</span>
                            <div class="text-muted small">@row.StageCode</div>
                        </td>
                        <td class="text-center">
                            @((row.OldStart?.ToString("dd MMM yyyy") ?? "—") + " → " + (row.OldDue?.ToString("dd MMM yyyy") ?? "—"))
                        </td>
                        <td class="text-center">
                            @((row.NewStart?.ToString("dd MMM yyyy") ?? "—") + " → " + (row.NewDue?.ToString("dd MMM yyyy") ?? "—"))
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    if (planState?.ApprovalHistory is { Count: > 0 })
    {
        <div class="mt-3">
            <h6 class="fw-semibold">Recent approval activity</h6>
            <ul class="list-unstyled mb-0">
                @foreach (var entry in planState.ApprovalHistory)
                {
                    <li class="small mb-1">
                        <strong>@entry.Action</strong>
                        <span class="text-muted">on @entry.PerformedOn.ToLocalTime().ToString("dd MMM yyyy HH:mm")</span>
                        @if (!string.IsNullOrWhiteSpace(entry.PerformedBy))
                        {
                            <span>by @entry.PerformedBy</span>
                        }
                        @if (!string.IsNullOrWhiteSpace(entry.Note))
                        {
                            <div class="text-muted">Note: @entry.Note</div>
                        }
                    </li>
                }
            </ul>
        </div>
    }

    <form method="post"
          asp-page="/Projects/Timeline/Review"
          asp-route-id="@ViewBag.ProjectId"
          class="d-flex flex-column gap-3 mt-3"
          data-plan-review-form="true">
        @Html.AntiForgeryToken()
        <input type="hidden" name="Input.ProjectId" value="@ViewBag.ProjectId" />
        <div class="d-flex gap-2 justify-content-end">
            <button name="Input.Decision" value="Reject" class="btn btn-outline-secondary" @(isPending ? null : "disabled") data-plan-review-reject="true">Reject</button>
            <button name="Input.Decision" value="Approve" class="btn btn-primary" @(!isPending ? "disabled" : null)>Approve plan</button>
        </div>
        <div class="mt-1" data-plan-review-note hidden>
            <label class="form-label" for="plan-review-reject-note">Reason (optional)</label>
            <textarea class="form-control" id="plan-review-reject-note" name="Input.Note" rows="3" placeholder="Share feedback for the project officer."></textarea>
        </div>
    </form>
}
