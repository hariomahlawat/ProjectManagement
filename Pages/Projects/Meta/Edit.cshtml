@page "{id:int}"
@model ProjectManagement.Pages.Projects.Meta.EditModel
@{
    ViewData["Title"] = "Edit Project Details";
}

<h1 class="mb-4">Edit Project Details</h1>

<form method="post">
    <input asp-for="Input.ProjectId" type="hidden" />
    <input asp-for="Input.RowVersion" type="hidden" />
    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
    <div class="mb-3">
        <label asp-for="Input.Name" class="form-label"></label>
        <input asp-for="Input.Name" class="form-control" />
        <span asp-validation-for="Input.Name" class="text-danger"></span>
    </div>
    @* SECTION: Markdown description editor with preview *@
    <div class="mb-3" data-description-preview-root data-preview-url='@Url.Page("/Projects/Meta/Edit", new { id = Model.Input.ProjectId, handler = "Preview" })'>
        <label asp-for="Input.Description" class="form-label"></label>
        <ul class="nav nav-tabs" id="descriptionEditorTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="description-write-tab" data-bs-toggle="tab" data-bs-target="#description-write" type="button" role="tab" aria-controls="description-write" aria-selected="true">
                    Write
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="description-preview-tab" data-bs-toggle="tab" data-bs-target="#description-preview" type="button" role="tab" aria-controls="description-preview" aria-selected="false" data-description-preview-trigger>
                    Preview
                </button>
            </li>
        </ul>
        <div class="tab-content border border-top-0 rounded-bottom p-3" id="descriptionEditorTabContent">
            <div class="tab-pane fade show active" id="description-write" role="tabpanel" aria-labelledby="description-write-tab" tabindex="0">
                <textarea asp-for="Input.Description" class="form-control" rows="7" maxlength="1000" data-description-markdown-input></textarea>
                <div class="form-text" data-char-count-for="Input_Description">0/1000</div>
                <span asp-validation-for="Input.Description" class="text-danger"></span>
            </div>
            <div class="tab-pane fade" id="description-preview" role="tabpanel" aria-labelledby="description-preview-tab" tabindex="0">
                <div class="small text-muted mb-2">Rendered preview (safe markdown)</div>
                <div class="project-overview__description pm-markdown border rounded p-3 bg-light" data-description-preview-content>Loading previewâ€¦</div>
                <div class="text-danger small mt-2 d-none" data-description-preview-error></div>
            </div>
        </div>

        @* SECTION: Formatting quick help *@
        <details class="mt-2">
            <summary class="small">Formatting help</summary>
            <ul class="small mb-0 mt-2">
                <li><code>**bold**</code></li>
                <li><code>_italic_</code></li>
                <li><code># Heading</code></li>
                <li><code>- bullet</code></li>
                <li><code>1. numbered</code></li>
                <li><code>[text](https://...)</code></li>
            </ul>
        </details>

        <div class="d-none" data-description-preview-token>
            @Html.AntiForgeryToken()
        </div>
    </div>
    <div class="mb-3">
        <label asp-for="Input.CategoryId" class="form-label">Category</label>
        <select asp-for="Input.CategoryId" class="form-select" asp-items="Model.CategoryOptions"></select>
        <span asp-validation-for="Input.CategoryId" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Input.TechnicalCategoryId" class="form-label">Technical Category</label>
        <select asp-for="Input.TechnicalCategoryId" class="form-select" asp-items="Model.TechnicalCategoryOptions"></select>
        <span asp-validation-for="Input.TechnicalCategoryId" class="text-danger"></span>
    </div>
    @* SECTION: Project type and build flag *@
    <div class="mb-3">
        <label asp-for="Input.ProjectTypeId" class="form-label">Project type</label>
        <select asp-for="Input.ProjectTypeId" class="form-select" asp-items="Model.ProjectTypeOptions"></select>
        <span asp-validation-for="Input.ProjectTypeId" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" asp-for="Input.IsBuild" />
            <label class="form-check-label" asp-for="Input.IsBuild">Build (repeat / re-manufacture)</label>
        </div>
    </div>
    <div class="mb-3">
        <label asp-for="Input.SponsoringUnitId" class="form-label">Sponsoring Unit</label>
        <select asp-for="Input.SponsoringUnitId" class="form-select js-async-select" asp-items="Model.SponsoringUnitOptions" data-source="/api/lookups/sponsoring-units" data-search-placeholder="Search sponsoring units"></select>
        <span asp-validation-for="Input.SponsoringUnitId" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Input.SponsoringLineDirectorateId" class="form-label">Sponsoring Line Dte</label>
        <select asp-for="Input.SponsoringLineDirectorateId" class="form-select js-async-select" asp-items="Model.LineDirectorateOptions" data-source="/api/lookups/line-directorates" data-search-placeholder="Search line directorates"></select>
        <span asp-validation-for="Input.SponsoringLineDirectorateId" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Input.CaseFileNumber" class="form-label"></label>
        <input asp-for="Input.CaseFileNumber" class="form-control" />
        <span asp-validation-for="Input.CaseFileNumber" class="text-danger"></span>
    </div>
    @* SECTION: Legacy cost fields *@
    @if (Model.IsLegacyProject)
    {
        <div class="mb-3">
            <label asp-for="Input.RdCostLakhs" class="form-label">R&amp;D / L1 cost (lakh)</label>
            <input asp-for="Input.RdCostLakhs" class="form-control" type="number" step="0.01" inputmode="decimal" />
            <span asp-validation-for="Input.RdCostLakhs" class="text-danger"></span>
        </div>
        <div class="mb-3">
            <label asp-for="Input.ApproxProductionCost" class="form-label">Approx Prod cost (lakh)</label>
            <input asp-for="Input.ApproxProductionCost" class="form-control" type="number" step="0.01" inputmode="decimal" />
            <span asp-validation-for="Input.ApproxProductionCost" class="text-danger"></span>
        </div>
    }
    <button type="submit" class="btn btn-primary">Save changes</button>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/widgets/async-select.js" asp-append-version="true" defer></script>
    <script src="~/js/widgets/char-count.js" asp-append-version="true" defer></script>
    <script src="~/js/pages/projects-meta-edit-description-preview.js" asp-append-version="true" defer></script>
}
