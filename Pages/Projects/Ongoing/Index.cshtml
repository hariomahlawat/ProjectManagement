@page
@using System.Text.RegularExpressions
@using ProjectManagement.Models.Execution
@using ProjectManagement.Models.Stages
@using ProjectManagement.Models.Remarks
@model ProjectManagement.Pages.Projects.Ongoing.IndexModel
@{
    ViewData["Title"] = "Ongoing projects";
    ViewData["UseFullWidth"] = true;

    // SECTION: View state
    var isTableView = string.Equals(Model.View, "table", StringComparison.OrdinalIgnoreCase);
    var isTotalActive = !Model.ProjectCategoryId.HasValue;
    var isCoeActive = Model.ProjectCategoryId.HasValue
        && Model.ProjectCategoryId == Model.ChipCoECategoryId;
    var isDcdActive = Model.ProjectCategoryId.HasValue
        && Model.ProjectCategoryId == Model.ChipDcdCategoryId;
    var isOtherActive = Model.ProjectCategoryId.HasValue
        && Model.ProjectCategoryId == Model.ChipOtherRdCategoryId;
    // SECTION: Filter state
    var hasFilters = Model.ProjectCategoryId.HasValue
        || !string.IsNullOrWhiteSpace(Model.ProjectOfficerId)
        || !string.IsNullOrWhiteSpace(Model.Search);

    // SECTION: Inline remark defaults
    var remarkType = RemarkType.External.ToString();
    var actorRole = Model.CanInlineEditExternalRemarks
        ? RemarkActorRole.HeadOfDepartment.ToString()
        : RemarkActorRole.ProjectOfficer.ToString();

    // turn <span class="remark-mention">…</span> into a small pill
    string RenderRemark(string? text)
    {
        if (string.IsNullOrWhiteSpace(text))
        {
            return string.Empty;
        }

        const string pattern = "<span class=\"remark-mention\"[^>]*>(.*?)</span>";

        var replaced = Regex.Replace(
            text,
            pattern,
            m => $"<span class=\"badge remark-pill\">{m.Groups[1].Value}</span>");

        return replaced;
    }

    // SECTION: Table helpers
    string FormatDate(DateOnly? date)
        => date.HasValue ? date.Value.ToString("dd-MMM-yy") : "N/A";

    string FormatMilestoneDate(DateOnly? date)
        => date.HasValue ? date.Value.ToString("dd-MMM-yy") : "NA";

    string FormatValue(string? value)
        => string.IsNullOrWhiteSpace(value) ? "N/A" : value;

    // SECTION: Category accent helper
    string GetCategoryAccentClass(int? categoryId)
    {
        if (!categoryId.HasValue)
        {
            return "ongoing-card--other";
        }

        if (Model.ChipCoECategoryId.HasValue && categoryId == Model.ChipCoECategoryId)
        {
            return "ongoing-card--coe";
        }

        if (Model.ChipDcdCategoryId.HasValue && categoryId == Model.ChipDcdCategoryId)
        {
            return "ongoing-card--dcd";
        }

        return "ongoing-card--other";
    }

}

<!-- SECTION: Ongoing projects top area -->
<div class="ongoing-top">
    <!-- SECTION: Page header + KPI chips -->
    <div class="ongoing-top__header">
        <!-- SECTION: Page title -->
        <h1 class="ongoing-top__title">Ongoing projects</h1>

        <!-- SECTION: Stage pipeline -->
        <div class="ongoing-top__pipeline" aria-label="Stage bucket distribution">
            @if (Model.FilteredTotal > 0)
            {
                <div class="stage-pipeline-wrap" aria-label="Stage distribution">
                    <div class="stage-pipeline-wrap__caption">Stage distribution</div>

                    <div class="stage-pipeline" role="group" aria-label="Stage pipeline">
                        <div class="stage-pipeline__seg stage-pipeline__seg--apvl"
                             style="--grow:@Model.BucketApvlCount"
                             title="Apvl: FS, SOW, IPA">
                            <span class="stage-pipeline__label">Apvl</span>
                            <span class="stage-pipeline__count">@Model.BucketApvlCount</span>
                        </div>

                        <div class="stage-pipeline__seg stage-pipeline__seg--aon"
                             style="--grow:@Model.BucketAonCount"
                             title="AoN: AON">
                            <span class="stage-pipeline__label">AoN</span>
                            <span class="stage-pipeline__count">@Model.BucketAonCount</span>
                        </div>

                        <div class="stage-pipeline__seg stage-pipeline__seg--proc"
                             style="--grow:@Model.BucketProcCount"
                             title="Tendering (GeM/Proc): BID, TEC, BM, COB, PNC, EAS, SO">
                            <span class="stage-pipeline__label">Tender</span>
                            <span class="stage-pipeline__count">@Model.BucketProcCount</span>
                        </div>

                        <div class="stage-pipeline__seg stage-pipeline__seg--devp"
                             style="--grow:@Model.BucketDevpCount"
                             title="Devp: DEVP, ATP, PAYMENT, TOT">
                            <span class="stage-pipeline__label">Devp</span>
                            <span class="stage-pipeline__count">@Model.BucketDevpCount</span>
                        </div>
                    </div>

                    @if (Model.BucketUnknownCount > 0)
                    {
                        <div class="stage-pipeline-wrap__meta">
                            <span class="stage-pipeline__unknown"
                                  title="Unknown current stage code found">
                                Unknown: @Model.BucketUnknownCount
                            </span>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="stage-pipeline stage-pipeline--empty" aria-label="No projects">
                    <span class="stage-pipeline__empty-text">No ongoing projects</span>
                </div>
            }
        </div>

        <!-- SECTION: KPI chip filters -->
        <div class="ongoing-top__kpis" aria-label="Project counts">
            <button type="button"
                    class="kpi-chip js-kpi-chip @(isTotalActive ? "is-active" : string.Empty)"
                    data-category-id=""
                    aria-pressed="@isTotalActive">
                <span class="kpi-chip__label">Total</span>
                <span class="kpi-chip__count">@Model.ChipTotalCount</span>
                @if (isTotalActive)
                {
                    <span class="kpi-chip__close" aria-hidden="true">×</span>
                }
            </button>
            <button type="button"
                    class="kpi-chip js-kpi-chip @(isCoeActive ? "is-active" : string.Empty)"
                    data-category-id="@(Model.ChipCoECategoryId?.ToString() ?? string.Empty)"
                    aria-pressed="@isCoeActive">
                <span class="kpi-chip__label">CoE</span>
                <span class="kpi-chip__count">@Model.ChipCoECount</span>
                @if (isCoeActive)
                {
                    <span class="kpi-chip__close" aria-hidden="true">×</span>
                }
            </button>
            <button type="button"
                    class="kpi-chip js-kpi-chip @(isDcdActive ? "is-active" : string.Empty)"
                    data-category-id="@(Model.ChipDcdCategoryId?.ToString() ?? string.Empty)"
                    aria-pressed="@isDcdActive">
                <span class="kpi-chip__label">DCD</span>
                <span class="kpi-chip__count">@Model.ChipDcdCount</span>
                @if (isDcdActive)
                {
                    <span class="kpi-chip__close" aria-hidden="true">×</span>
                }
            </button>
            <button type="button"
                    class="kpi-chip js-kpi-chip @(isOtherActive ? "is-active" : string.Empty)"
                    data-category-id="@(Model.ChipOtherRdCategoryId?.ToString() ?? string.Empty)"
                    aria-pressed="@isOtherActive">
                <span class="kpi-chip__label">Other R&amp;D</span>
                <span class="kpi-chip__count">@Model.ChipOtherRdCount</span>
                @if (isOtherActive)
                {
                    <span class="kpi-chip__close" aria-hidden="true">×</span>
                }
            </button>
        </div>
    </div>

    <!-- SECTION: Command bar -->
    <form id="ongoingProjectsFilterForm"
          method="get"
          class="cmdbar"
          novalidate>
        <!-- SECTION: Persist view selection -->
        <input type="hidden" asp-for="View" />

        <!-- SECTION: Filters row -->
        <div class="cmdbar__filters">
            <div class="cmdbar__field cmdbar__field--category">
                <label asp-for="ProjectCategoryId" class="cmdbar__label">Project category</label>
                <select asp-for="ProjectCategoryId"
                        asp-items="Model.ProjectCategoryOptions"
                        class="form-select form-select-sm"></select>
            </div>
            <div class="cmdbar__field cmdbar__field--officer">
                <label asp-for="ProjectOfficerId" class="cmdbar__label">Project officer</label>
                <select asp-for="ProjectOfficerId"
                        asp-items="Model.ProjectOfficerOptions"
                        class="form-select form-select-sm"></select>
            </div>
            <div class="cmdbar__field cmdbar__field--search">
                <label asp-for="Search" class="cmdbar__label">Search by project name</label>
                <input asp-for="Search" class="form-control form-control-sm" />
            </div>
        </div>

        <!-- SECTION: Actions row -->
        <div class="cmdbar__actions">
            <div class="segmented" role="tablist" aria-label="View">
                <a asp-page="./Index"
                   asp-route-ProjectCategoryId="@Model.ProjectCategoryId"
                   asp-route-ProjectOfficerId="@Model.ProjectOfficerId"
                   asp-route-Search="@Model.Search"
                   asp-route-View="timeline"
                   class="segmented__item @(isTableView ? string.Empty : "is-active")"
                   role="tab"
                   aria-selected="@(!isTableView)"
                   aria-current="@(isTableView ? null : "page")">
                    Timeline view
                </a>
                <a asp-page="./Index"
                   asp-route-ProjectCategoryId="@Model.ProjectCategoryId"
                   asp-route-ProjectOfficerId="@Model.ProjectOfficerId"
                   asp-route-Search="@Model.Search"
                   asp-route-View="table"
                   class="segmented__item @(isTableView ? "is-active" : string.Empty)"
                   role="tab"
                   aria-selected="@isTableView"
                   aria-current="@(isTableView ? "page" : null)">
                    Table view
                </a>
            </div>
            @if (hasFilters)
            {
                <!-- SECTION: Clear filters -->
                <a asp-page="./Index"
                   asp-route-ProjectCategoryId=""
                   asp-route-ProjectOfficerId=""
                   asp-route-Search=""
                   class="cmdbar__link-button">
                    Clear filters
                </a>
            }
            <button type="submit" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-funnel" aria-hidden="true"></i>
                <span>Filter</span>
            </button>
            <a asp-page="./Index"
               asp-page-handler="Export"
               asp-route-ProjectCategoryId="@Model.ProjectCategoryId"
               asp-route-ProjectOfficerId="@Model.ProjectOfficerId"
               asp-route-Search="@Model.Search"
               asp-route-View="@Model.View"
               class="btn btn-sm btn-outline-secondary">
                Export
            </a>
        </div>
    </form>
</div>

@if (Model.Items.Count == 0)
{
    <p class="text-muted">No ongoing projects matched the selected filters.</p>
}
else
{
    <!-- SECTION: Timeline view -->
    <section class="row g-3" @(isTableView ? "hidden" : string.Empty)>
        @foreach (var item in Model.Items)
        {
            // SECTION: Identify current stage index using the present snapshot first
            var currentIdx = -1;
            if (!string.IsNullOrWhiteSpace(item.PresentStage.CurrentStageCode))
            {
                currentIdx = item.Stages
                    .Select((stage, idx) => new { stage, idx })
                    .FirstOrDefault(x => string.Equals(
                        x.stage.Code,
                        item.PresentStage.CurrentStageCode,
                        StringComparison.OrdinalIgnoreCase))?.idx ?? -1;
            }

            if (currentIdx == -1)
            {
                for (var i = 0; i < item.Stages.Count; i++)
                {
                    if (item.Stages[i].IsCurrent)
                    {
                        currentIdx = i;
                        break;
                    }
                }
            }

            if (currentIdx == -1)
            {
                currentIdx = 0;
            }

            <div class="col-12">
                <article class="ongoing-card @GetCategoryAccentClass(item.ProjectCategoryId) card border-0 shadow-sm h-100">
                    <div class="card-body p-0">
                        @{
                            // SECTION: Timeline helper values
                            var today = DateOnly.FromDateTime(DateTime.UtcNow.Date);
                            var cur = item.Stages[currentIdx];
                            var presentStage = item.PresentStage;

                            // SECTION: Days to PDC / overdue
                            int? daysToPdc = null;
                            bool isOverdue = false;
                            if (cur.PlannedDue.HasValue)
                            {
                                daysToPdc = (cur.PlannedDue.Value.ToDateTime(TimeOnly.MinValue) -
                                today.ToDateTime(TimeOnly.MinValue)).Days;
                                if (daysToPdc < 0)
                                {
                                    isOverdue = true;
                                    daysToPdc = Math.Abs(daysToPdc.Value);
                                }
                            }
                        }

                        <!-- SECTION: Timeline card header -->
                        <header class="ongoing-card__header">
                            <!-- SECTION: Header thumbnail -->
                            <div class="ongoing-card__thumb" aria-hidden="true">
                                @if (item.CoverPhotoId.HasValue)
                                {
                                    <img src="@Url.Page("/Projects/Photos/View", new { id = item.ProjectId, photoId = item.CoverPhotoId.Value, size = "sm", v = item.CoverPhotoVersion })"
                                         loading="lazy"
                                         alt=""
                                         class="ongoing-card__thumb-img" />
                                }
                                else
                                {
                                    <div class="ongoing-card__thumb-placeholder" aria-hidden="true">
                                        <i class="bi bi-image" aria-hidden="true"></i>
                                    </div>
                                }
                            </div>

                            <!-- SECTION: Header main content -->
                            <div class="ongoing-card__main">
                                <h2 class="ongoing-card__title mb-1">
                                    <a asp-page="/Projects/Overview"
                                       asp-route-id="@item.ProjectId"
                                       class="text-decoration-none">
                                        @item.ProjectName
                                    </a>
                                </h2>
                                <p class="ongoing-card__meta mb-1">
                                    @FormatValue(item.ProjectCategoryName)
                                    <span class="ongoing-card__meta-divider">•</span>
                                    Cost: @item.CostLakhsText
                                </p>
                                <div class="ongoing-card__stage-summary">
                                    <p class="mb-0">
                                        <span class="ongoing-card__current-label">Current stage</span>
                                        @if (cur.Status == StageStatus.Completed)
                                        {
                                            <span class="ongoing-card__current-value">@cur.Name</span>
                                            @if (cur.ActualCompletedOn.HasValue)
                                            {
                                                @: (@cur.ActualCompletedOn.Value.ToString("dd-MMM-yyyy"))
                                            }
                                            else
                                            {
                                                <span class="text-muted">date not available</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="ongoing-card__current-value">@cur.Name</span>
                                            @if (cur.PlannedDue.HasValue)
                                            {
                                                @: (PDC: @cur.PlannedDue.Value.ToString("dd-MMM-yyyy"))
                                            }
                                            else
                                            {
                                                <span class="text-muted">PDC: N/A</span>
                                            }
                                        }

                                        <!-- SECTION: Stage age -->
                                        <span class="ms-2 text-muted ongoing-card__stage-chip">
                                            @if (presentStage.DaysSinceStartOrLastCompletion.HasValue)
                                            {
                                                var daysInCurrent = presentStage.DaysSinceStartOrLastCompletion.Value;
                                                @: • @daysInCurrent day@(daysInCurrent == 1 ? "" : "s") in this stage
                                            }
                                        </span>

                                        @if (cur.Status != StageStatus.Completed)
                                        {
                                            if (cur.PlannedDue.HasValue)
                                            {
                                                if (!isOverdue)
                                                {
                                                    <span class="ms-2 text-success ongoing-card__stage-chip">
                                                        @daysToPdc day@(daysToPdc == 1 ? "" : "s") to PDC
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="ms-2 oc-pill oc-pill--danger">
                                                        overdue by @daysToPdc day@(daysToPdc == 1 ? "" : "s")
                                                    </span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="ms-2 oc-pill oc-pill--neutral">
                                                    no PDC set
                                                </span>
                                            }
                                        }
                                    </p>
                                </div>
                            </div>

                            <!-- SECTION: Header right meta -->
                            <div class="ongoing-card__right">
                                <p class="ongoing-card__lc-label mb-0">Last completed</p>
                                <p class="ongoing-card__last mb-0">
                                    @if (!string.IsNullOrEmpty(item.LastCompletedStageName))
                                    {
                                        <span class="ongoing-card__lc-value">@item.LastCompletedStageName</span>
                                        if (item.LastCompletedStageDate.HasValue)
                                        {
                                            @: (@item.LastCompletedStageDate.Value.ToString("dd-MMM-yy"))
                                        }
                                        else
                                        {
                                            <span class="text-muted">date NA</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">None</span>
                                    }
                                </p>
                            </div>
                        </header>


                        <!-- SECTION: Timeline -->
                        <div class="d-flex align-items-center flex-wrap gap-2 px-4 py-3 border-top">
                            @{
                                // show stages from start up to current stage
                                for (var i = 0; i <= currentIdx; i++)
                                {
                                    var stage = item.Stages[i];
                                    var isCompleted = stage.Status == StageStatus.Completed;
                                    var isCurrent = i == currentIdx;

                                    if (isCompleted)
                                    {
                                        <div class="d-flex align-items-center gap-1">
                                            <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center ongoing-timeline__stage-node">
                                                @stage.Code
                                            </div>
                                            <div class="small">
                                                @if (stage.ActualCompletedOn.HasValue)
                                                {
                                                    @stage.ActualCompletedOn.Value.ToString("dd-MMM-yyyy")
                                                }
                                                else
                                                {
                                                    <span class="text-muted">—</span>
                                                }
                                            </div>
                                        </div>
                                    }
                                    else if (isCurrent)
                                    {
                                        <div class="d-flex align-items-center gap-1">
                                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center ongoing-timeline__stage-node">
                                                @stage.Code
                                            </div>
                                            <div class="small">
                                                @if (stage.PlannedDue.HasValue)
                                                {
                                                    <span>PDC: @stage.PlannedDue.Value.ToString("dd-MMM-yyyy")</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">PDC: N/A</span>
                                                }
                                            </div>
                                        </div>
                                    }

                                    // connector + days between completed stages
                                    if (i < currentIdx)
                                    {
                                        var durationDays = stage.ActualDurationDays;

                                        <div class="d-flex align-items-center gap-1 ongoing-timeline__connector">
                                            <div class="ongoing-timeline__line"></div>
                                            <div class="badge bg-light text-muted border small">
                                                @(durationDays.HasValue ? $"{durationDays.Value} day{(durationDays.Value == 1 ? "" : "s")}" : "—")
                                            </div>
                                            <div class="ongoing-timeline__connector-gap"></div>
                                        </div>
                                    }
                                }

                                if (currentIdx < item.Stages.Count - 1)
                                {
                                    <span class="text-muted small ms-1">… more stages</span>
                                }
                            }
                        </div>

                        <!-- SECTION: Remarks -->
                        <section class="ongoing-remarks border-top">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="ongoing-remarks__title">Recent internal remarks (last 10 days)</span>
                                @if (!string.IsNullOrWhiteSpace(item.LatestExternalRemark?.Body))
                                {
                                    <span class="oc-pill oc-pill--neutral">has external note</span>
                                }
                            </div>

                            @if (item.RecentInternalRemarks.Count == 0)
                            {
                                <p class="small text-muted mb-0">No internal remarks in the last 10 days.</p>
                            }
                            else
                            {
                                <ul class="ongoing-remarks__list">
                                    @foreach (var r in item.RecentInternalRemarks)
                                    {
                                        <li class="ongoing-remarks__item">
                                            <div class="ongoing-remarks__meta">
                                                @r.CreatedAtUtc.ToLocalTime().ToString("dd-MMM-yyyy HH:mm")
                                                @if (r.ActorRole != RemarkActorRole.Unknown)
                                                {
                                                    @: • @r.ActorRole
                                                }
                                            </div>
                                            <div class="ongoing-remarks__body">
                                                @Html.Raw(RenderRemark(r.Text))
                                            </div>
                                        </li>
                                    }
                                </ul>
                            }
                        </section>
                    </div>
                </article>
            </div>
        }
    </section>

    <!-- SECTION: Table view -->
    <section @(isTableView ? string.Empty : "hidden")>
        @{
            var orderedCategories = Model.ProjectCategoryOptions
                .Where(option => !string.IsNullOrWhiteSpace(option.Value))
                .Select(option => new
                {
                    Id = int.TryParse(option.Value, out var id) ? id : 0,
                    option.Text
                })
                .Where(option => option.Id > 0)
                .ToList();

            // SECTION: Group categorized and uncategorized items
            var itemsByCategory = Model.Items
                .Where(item => item.ProjectCategoryId.HasValue)
                .GroupBy(item => item.ProjectCategoryId!.Value)
                .ToDictionary(group => group.Key, group => group.OrderBy(x => x.ProjectName).ToList());

            var uncategorizedItems = Model.Items
                .Where(item => !item.ProjectCategoryId.HasValue)
                .OrderBy(item => item.ProjectName)
                .ToList();
        }

        <!-- SECTION: Table inline remark metadata -->
        <div id="oprTableRoot"
             data-today-ist="@Model.TodayIstIso"
             data-can-edit="@(Model.CanInlineEditExternalRemarks ? "1" : "0")">
            @if (Model.CanInlineEditExternalRemarks)
            {
                <div id="oprInlineRemarkToken" class="d-none">
                    @Html.AntiForgeryToken()
                </div>
            }
        </div>

        <div class="pm-card-table shadow-sm border-0">
            <div class="pm-table-wrap table-responsive ongoing-table-wrap">
                <table class="table pm-table pm-table-sm align-middle mb-0 ongoing-table">
                    <colgroup>
                        <col class="col-project" />
                        <col class="col-category" />
                        <col class="col-cost" />
                        <col class="col-date" />
                        <col class="col-date" />
                        <col class="col-stage" />
                        <col class="col-pdc" />
                        <col class="col-remarks" />
                    </colgroup>
                    <thead>
                        <tr>
                            <th class="col-project">Project name</th>
                            <th class="col-category">Category</th>
                            <th class="col-cost">Cost (In Lakhs)</th>
                            <th class="col-date">IPA date</th>
                            <th class="col-date">AoN date</th>
                            <th class="col-stage">Present stage</th>
                            <th class="col-pdc">Present stage PDC</th>
                            <th class="col-remarks">Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var category in orderedCategories)
                        {
                            if (!itemsByCategory.TryGetValue(category.Id, out var rows) || rows.Count == 0)
                            {
                                continue;
                            }

                            <tr class="table-light">
                                <td colspan="8" class="fw-semibold text-uppercase text-muted small">
                                    @category.Text (@rows.Count)
                                </td>
                            </tr>

                            @foreach (var row in rows)
                            {
                                // SECTION: Latest external remark metadata
                                var latestExternal = row.LatestExternalRemark;
                                var remarkBody = latestExternal?.Body ?? string.Empty;
                                var remarkEventDate = latestExternal?.EventDate.ToString("yyyy-MM-dd") ?? Model.TodayIstIso;
                                var remarkScope = latestExternal?.Scope.ToString() ?? RemarkScope.General.ToString();
                                var remarkRowVersion = latestExternal?.RowVersion ?? string.Empty;
                                var remarkId = latestExternal?.Id ?? 0;
                                var hasRemarkBody = !string.IsNullOrWhiteSpace(remarkBody);

                                <tr>
                                    <td class="col-project">
                                        <!-- SECTION: Project name cell (thumbnail + link) -->
                                        <div class="projcell">
                                            @if (row.CoverPhotoId.HasValue)
                                            {
                                                <img class="projcell__thumb"
                                                     src="@Url.Page("/Projects/Photos/View", new { id = row.ProjectId, photoId = row.CoverPhotoId.Value, size = "xs", v = row.CoverPhotoVersion })"
                                                     alt=""
                                                     loading="lazy" />
                                            }
                                            else
                                            {
                                                <div class="projcell__thumb projcell__thumb--placeholder" aria-hidden="true">
                                                    <span class="bi bi-image" aria-hidden="true"></span>
                                                </div>
                                            }
                                            <div class="projcell__text">
                                                <a asp-page="/Projects/Overview"
                                                   asp-route-id="@row.ProjectId"
                                                   class="project-link text-decoration-none fw-semibold">
                                                    @row.ProjectName
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="col-category">@FormatValue(row.ProjectCategoryName)</td>
                                    <td class="col-cost" title="@row.CostLakhsFull">@row.CostLakhsShort</td>
                                    <td class="col-date">@FormatMilestoneDate(row.IpaDate)</td>
                                    <td class="col-date">@FormatMilestoneDate(row.AonDate)</td>
                                    <td class="col-stage">@FormatValue(row.PresentStage.CurrentStageName)</td>
                                    <td class="col-pdc">@FormatDate(row.PresentStagePdc)</td>
                                    <td class="col-remarks js-ongoing-remark-cell"
                                        data-project-id="@row.ProjectId"
                                        data-remark-id="@remarkId"
                                        data-row-version="@remarkRowVersion"
                                        data-event-date="@remarkEventDate"
                                        data-scope="@remarkScope"
                                        data-type="@remarkType"
                                        data-actor-role="@actorRole"
                                        data-remark-body="@remarkBody"
                                        data-current-text="@remarkBody"
                                        data-empty-text="N/A"
                                        data-can-edit="@(Model.CanInlineEditExternalRemarks ? "1" : "0")">
                                        @if (Model.CanInlineEditExternalRemarks)
                                        {
                                            <div class="pm-remark-text @(hasRemarkBody ? string.Empty : "text-muted fst-italic")"
                                                 title="Double-click to edit">
                                                @FormatValue(remarkBody)
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="pm-remark-text @(hasRemarkBody ? string.Empty : "text-muted fst-italic")">
                                                @FormatValue(remarkBody)
                                            </div>
                                        }
                                    </td>
                                </tr>
                            }
                        }

                        @if (uncategorizedItems is { Count: > 0 })
                        {
                            <tr class="table-light">
                                <td colspan="8" class="fw-semibold text-uppercase text-muted small">
                                    Uncategorized (@uncategorizedItems.Count)
                                </td>
                            </tr>

                            foreach (var row in uncategorizedItems)
                            {
                                // SECTION: Latest external remark metadata
                                var latestExternal = row.LatestExternalRemark;
                                var remarkBody = latestExternal?.Body ?? string.Empty;
                                var remarkEventDate = latestExternal?.EventDate.ToString("yyyy-MM-dd") ?? Model.TodayIstIso;
                                var remarkScope = latestExternal?.Scope.ToString() ?? RemarkScope.General.ToString();
                                var remarkRowVersion = latestExternal?.RowVersion ?? string.Empty;
                                var remarkId = latestExternal?.Id ?? 0;
                                var hasRemarkBody = !string.IsNullOrWhiteSpace(remarkBody);

                                <tr>
                                    <td class="col-project">
                                        <!-- SECTION: Project name cell (thumbnail + link) -->
                                        <div class="projcell">
                                            @if (row.CoverPhotoId.HasValue)
                                            {
                                                <img class="projcell__thumb"
                                                     src="@Url.Page("/Projects/Photos/View", new { id = row.ProjectId, photoId = row.CoverPhotoId.Value, size = "xs", v = row.CoverPhotoVersion })"
                                                     alt=""
                                                     loading="lazy" />
                                            }
                                            else
                                            {
                                                <div class="projcell__thumb projcell__thumb--placeholder" aria-hidden="true">
                                                    <span class="bi bi-image" aria-hidden="true"></span>
                                                </div>
                                            }
                                            <div class="projcell__text">
                                                <a asp-page="/Projects/Overview"
                                                   asp-route-id="@row.ProjectId"
                                                   class="project-link text-decoration-none fw-semibold">
                                                    @row.ProjectName
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="col-category">@FormatValue(row.ProjectCategoryName)</td>
                                    <td class="col-cost" title="@row.CostLakhsFull">@row.CostLakhsShort</td>
                                    <td class="col-date">@FormatMilestoneDate(row.IpaDate)</td>
                                    <td class="col-date">@FormatMilestoneDate(row.AonDate)</td>
                                    <td class="col-stage">@FormatValue(row.PresentStage.CurrentStageName)</td>
                                    <td class="col-pdc">@FormatDate(row.PresentStagePdc)</td>
                                    <td class="col-remarks js-ongoing-remark-cell"
                                        data-project-id="@row.ProjectId"
                                        data-remark-id="@remarkId"
                                        data-row-version="@remarkRowVersion"
                                        data-event-date="@remarkEventDate"
                                        data-scope="@remarkScope"
                                        data-type="@remarkType"
                                        data-actor-role="@actorRole"
                                        data-remark-body="@remarkBody"
                                        data-current-text="@remarkBody"
                                        data-empty-text="N/A"
                                        data-can-edit="@(Model.CanInlineEditExternalRemarks ? "1" : "0")">
                                        @if (Model.CanInlineEditExternalRemarks)
                                        {
                                            <div class="pm-remark-text @(hasRemarkBody ? string.Empty : "text-muted fst-italic")"
                                                 title="Double-click to edit">
                                                @FormatValue(remarkBody)
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="pm-remark-text @(hasRemarkBody ? string.Empty : "text-muted fst-italic")">
                                                @FormatValue(remarkBody)
                                            </div>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </section>
}

@section Styles {
    <link rel="stylesheet" href="~/css/components/pm-table.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/projects/ongoing.js"
            asp-append-version="true"
            defer></script>
    <script src="~/js/projects/ongoing-remarks-inline.js"
            asp-append-version="true"
            defer></script>
}
