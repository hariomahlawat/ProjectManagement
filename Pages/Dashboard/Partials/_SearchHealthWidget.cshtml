@using System.Linq
@using System.Text.Json
@model ProjectManagement.ViewModels.Dashboard.SearchHealthVm

@{
    // SECTION: Header tokens
    var hasCorpus = Model?.HasSearchableCorpus == true;

    // Worker status: neutral pill always; color via dot + text.
    var workerIsActive = Model?.WorkerActive == true;

    // Amber for inactive (state), green for active (healthy).
    var workerBadgeClass = "bg-light text-muted border";
    var workerTextClass = workerIsActive ? "text-success" : "text-warning";
    var workerDotClass = workerIsActive ? "dot-success" : "dot-warning";
    var workerBadgeLabel = workerIsActive ? "Worker active" : "Worker offline";
    // END SECTION

    // SECTION: Trend serialization
    var trendValues = Model?.OcrCompletionsTrend ?? Array.Empty<int>();
    var trendJson = JsonSerializer.Serialize(trendValues);
    var hasTrendValues = trendValues.Any();
    var trendHasActivity = trendValues.Any(value => value > 0);
    // END SECTION
}

<div class="card shadow-sm search-health-card">
    <div class="card-body p-3 p-lg-4 search-health-card__body">

        @* SECTION: Header *@
        <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap mb-3">
            <div class="d-flex flex-column gap-1">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <h2 class="h6 mb-0 fw-semibold">Search and OCR Health</h2>
                    <span class="badge rounded-pill search-health__worker @workerBadgeClass @workerTextClass">
                        <span class="search-health__dot @workerDotClass"></span>
                        @workerBadgeLabel
                    </span>
                </div>
            </div>

            <div class="d-flex align-items-center gap-2 flex-shrink-0">
                <a asp-area="Common"
                   asp-page="/Search/Index"
                   class="btn btn-sm btn-primary">
                    Open global search
                </a>
            </div>
        </div>
        @* END SECTION *@

        @if (!hasCorpus)
        {
            @* SECTION: Empty state *@
            <div class="search-health-empty text-center py-4">
                <p class="fw-semibold mb-1">No searchable documents yet.</p>
                <p class="text-muted small mb-3">Upload files to start OCR and full-text indexing.</p>
                <a asp-area="DocumentRepository"
                   asp-page="/Documents/Upload"
                   class="btn btn-outline-primary btn-sm">
                    Upload a document
                </a>
            </div>
            @* END SECTION *@
        }
        else
        {
            <div class="d-flex flex-column gap-3">

                @* SECTION: Searchable corpus *@
                <section aria-label="Searchable corpus" class="search-health__section">
                    <div class="text-muted small fw-semibold mb-1">Searchable corpus</div>

                    <div class="d-flex align-items-baseline gap-3 flex-wrap">
                        <div class="d-flex align-items-baseline gap-2">
                            <span class="search-health__hero-number fw-bold lh-1">@Model!.TotalSearchable</span>
                            <span class="text-muted">documents</span>
                        </div>
                        <div class="text-muted small">
                            Project documents <strong>@Model.ProjectDocumentsSearchable</strong>
                            <span class="mx-1">·</span>
                            Document repository <strong>@Model.DocRepoSearchable</strong>
                            @if (Model.IncludeProjectReports)
                            {
                                <span class="mx-1">·</span>
                                <span>Project reports <strong>@Model.ProjectReportsSearchable</strong></span>
                            }
                        </div>
                    </div>
                </section>
                @* END SECTION *@

                <hr class="search-health__divider my-0" />

                @* SECTION: OCR status *@
                <section aria-label="OCR status" class="search-health__section">
                    <div class="text-muted small fw-semibold mb-2">OCR status</div>

                    <div class="d-flex flex-wrap align-items-center gap-3 small">
                        <div class="d-flex align-items-center gap-2">
                            <span class="search-health__dot dot-success"></span>
                            <span class="text-muted">Succeeded</span>
                            <strong>@Model.Ocr.Succeeded</strong>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="search-health__dot dot-warning"></span>
                            <span class="text-muted">Pending</span>
                            <strong>@Model.Ocr.Pending</strong>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="search-health__dot dot-danger"></span>
                            <span class="text-muted">Failed</span>
                            @if (Model.Ocr.Failed > 0)
                            {
                                <a asp-area="DocumentRepository"
                                   asp-page="/Admin/OCRFailures/OcrFailures"
                                   class="fw-semibold text-danger text-decoration-none">
                                    @Model.Ocr.Failed
                                </a>
                            }
                            else
                            {
                                <strong>@Model.Ocr.Failed</strong>
                            }
                        </div>
                    </div>
                </section>
                @* END SECTION *@

                <hr class="search-health__divider my-0" />

                @* SECTION: OCR completions trend *@
                <section aria-label="Recent OCR completions" class="search-health__section">
                    <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
                        <div class="text-muted small fw-semibold">OCR completions (7 days)</div>
                    </div>

                    @if (hasTrendValues && trendHasActivity)
                    {
                        <div class="search-health__sparkline-wrap mt-2" data-ocr-trend='@trendJson'>
                            <canvas class="search-health__sparkline" role="img" aria-label="Seven day OCR completion sparkline"></canvas>
                        </div>
                    }
                    else
                    {
                        <div class="text-muted small mt-2">
                            No OCR completions in the last 7 days.
                        </div>
                    }
                </section>
                @* END SECTION *@

                <hr class="search-health__divider my-0" />

                @* SECTION: Queue health *@
                <section aria-label="Queue health" class="search-health__section">
                    <div class="text-muted small fw-semibold mb-1">Queue health</div>

                    @if (Model.Ocr.Pending == 0)
                    {
                        <div class="small">
                            Queue clear <span class="text-muted">· Oldest pending: 0h</span>
                        </div>
                    }
                    else
                    {
                        <div class="small">
                            Queue backlog
                            <span class="text-muted">· Oldest pending: <strong>@(Model.OldestPendingLabel ?? "–")</strong></span>
                            <a class="ms-2 small" asp-area="DocumentRepository" asp-page="/Documents/Index">Open documents</a>
                        </div>
                    }
                </section>
                @* END SECTION *@

                @* SECTION: Footer *@
                <div class="text-muted small search-health__section">
                    Ranking blends metadata, tags, and OCR body.
                    <a asp-area="DocumentRepository"
                       asp-page="/Documents/Index"
                       class="small text-decoration-none ms-1">
                        Search docus repository →
                    </a>
                </div>
                @* END SECTION *@
            </div>
        }
    </div>
</div>
