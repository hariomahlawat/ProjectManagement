@page
@model ProjectManagement.Pages.Calendar.IndexModel
@{
    ViewData["Title"] = "Calendar";
}

@section Styles {
    <link rel="stylesheet" href="~/css/calendar.css" asp-append-version="true" />
}

<div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
  <div class="d-flex align-items-center gap-2 flex-wrap">
    <div class="btn-group btn-group-sm" role="group" aria-label="View">
      <button class="btn btn-outline-secondary" data-view="dayGridMonth">Month</button>
      <button class="btn btn-outline-secondary" data-view="timeGridWeek">Week</button>
      <button class="btn btn-outline-secondary" data-view="timeGridDay">Day</button>
      <button class="btn btn-outline-secondary" data-view="listMonth">List</button>
    </div>

    @* <div class="vr mx-1 d-none d-md-block"></div>

    <!-- Category pills in the top line -->
    <div class="btn-group btn-group-sm" id="categoryFilters" role="group" aria-label="Filter">
      <button class="btn btn-outline-secondary active" data-cat="">All</button>
      <button class="btn btn-outline-secondary" data-cat="Visit">Visit</button>
      <button class="btn btn-outline-secondary" data-cat="Insp">Insp</button>
      <button class="btn btn-outline-secondary" data-cat="Conference">Conference</button>
      <button class="btn btn-outline-secondary" data-cat="Other">Other</button>
    </div> *@

    <div class="vr mx-1 d-none d-md-block"></div>

    <!-- Month title + prev/next -->
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-light btn-sm" id="btnPrev" aria-label="Previous"><span aria-hidden="true">‹</span></button>
      <div id="calTitle" class="h5 mb-0 fw-semibold"></div>
      <button class="btn btn-light btn-sm" id="btnNext" aria-label="Next"><span aria-hidden="true">›</span></button>
    </div>
  </div>

  @if (Model.CanEdit)
  {
    <button class="btn btn-success btn-sm"
            id="btnNewEvent"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#eventFormCanvas"
            aria-controls="eventFormCanvas">New Event</button>
  }
</div>

<div id="calendar"
     class="shadow-sm border rounded-3 bg-white"
     data-can-edit="@Model.CanEdit.ToString().ToLowerInvariant()"></div>

<div id="categoryLegend" class="small text-muted mt-2"></div>

@if (Model.CanEdit)
{
  <!-- Offcanvas: Create/Edit -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="eventFormCanvas" aria-labelledby="eventFormLabel">
    <div class="offcanvas-header">
      <h5 id="eventFormLabel" class="offcanvas-title">New event</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <form id="eventForm" class="vstack gap-3">
        <input type="hidden" name="id" />
        <div>
          <label class="form-label">Title</label>
          <input class="form-control" name="title" maxlength="160" required />
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">Category</label>
            <select class="form-select" name="category">
              <option>Visit</option>
              <option>Insp</option>
              <option>Conference</option>
              <option selected>Other</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label">Location</label>
            <input class="form-control" name="location" maxlength="160" />
          </div>
        </div>

        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="toggleAllDay" name="isAllDay">
          <label class="form-check-label" for="toggleAllDay">All-day</label>
        </div>

        <div class="row g-2" id="timePickers">
          <div class="col-6">
            <label class="form-label">Start</label>
            <input type="datetime-local" class="form-control" name="start" />
          </div>
          <div class="col-6">
            <label class="form-label">End</label>
            <input type="datetime-local" class="form-control" name="end" />
          </div>
        </div>

        <div class="row g-2 d-none" id="datePickers">
          <div class="col-6">
            <label class="form-label">Start date</label>
            <input type="date" class="form-control" name="startDate" />
          </div>
          <div class="col-6">
            <label class="form-label">End date</label>
            <input type="date" class="form-control" name="endDate" />
          </div>
        </div>

        <hr class="my-2" />
        <label class="form-label">Repeats</label>
        <select class="form-select form-select-sm" id="repeatFreq">
          <option value="">Does not repeat</option>
          <option value="WEEKLY">Weekly</option>
          <option value="MONTHLY">Monthly</option>
        </select>

        <div id="repeatWeekly" class="mt-2 d-none">
          <div class="form-text mb-1">On</div>
          <div class="d-flex gap-2 flex-wrap">
            <label class="form-check"><input class="form-check-input" type="checkbox" value="MO"> Mon</label>
            <label class="form-check"><input class="form-check-input" type="checkbox" value="TU"> Tue</label>
            <label class="form-check"><input class="form-check-input" type="checkbox" value="WE"> Wed</label>
            <label class="form-check"><input class="form-check-input" type="checkbox" value="TH"> Thu</label>
            <label class="form-check"><input class="form-check-input" type="checkbox" value="FR"> Fri</label>
            <label class="form-check"><input class="form-check-input" type="checkbox" value="SA"> Sat</label>
            <label class="form-check"><input class="form-check-input" type="checkbox" value="SU"> Sun</label>
          </div>
        </div>

        <div id="repeatMonthly" class="mt-2 d-none">
          <div class="input-group input-group-sm">
            <span class="input-group-text">Day</span>
            <input type="number" min="1" max="31" class="form-control" id="repeatMonthDay" />
          </div>
        </div>

        <div class="mt-2">
          <div class="form-text mb-1">Ends</div>
          <div class="d-flex gap-3 align-items-center flex-wrap">
            <label class="form-check"><input class="form-check-input" type="radio" name="repeatEnd" value="never" checked> Never</label>
            <label class="form-check d-flex align-items-center gap-2">
              <input class="form-check-input" type="radio" name="repeatEnd" value="on"> On
              <input type="date" class="form-control form-control-sm" id="repeatUntil">
            </label>
          </div>
        </div>

        <div>
          <label class="form-label">Description (Markdown)</label>
          <textarea class="form-control" rows="4" name="description"></textarea>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-primary" id="btnSaveEvent" type="submit">Save</button>
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="offcanvas">Cancel</button>
          <button class="btn btn-outline-danger ms-auto d-none" id="btnDeleteEvent" type="button">Delete</button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Offcanvas: View Details -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="eventDetailsCanvas" aria-labelledby="eventDetailsLabel">
  <div class="offcanvas-header">
    <h5 id="eventDetailsLabel" class="offcanvas-title"></h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div class="small text-muted mb-2" id="eventDetailsTime"></div>
    <div class="mb-2"><span class="badge bg-secondary" id="eventDetailsCategory"></span></div>
    <div class="mb-2" id="eventDetailsLocation"></div>
    <div class="mb-3" id="eventDetailsDescription"></div>
    <button class="btn btn-outline-primary btn-sm" id="btnAddToTasks" type="button">Add to My Tasks</button>
  </div>
</div>

<!-- Undo toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="undoToast" class="toast" role="status" aria-live="polite" aria-atomic="true">
    <div class="d-flex">
      <div id="undoMessage" class="toast-body"></div>
      <button id="btnUndo" type="button" class="btn btn-link btn-sm ms-auto">Undo</button>
      <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

@section Scripts {
  <!-- Order matters: Bootstrap JS → FullCalendar → page script -->
  <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

  <!-- EITHER: single bundle -->
  <script src="~/lib/fullcalendar/bundle/index.global.min.js"></script>

  <!-- OR: individual globals (if you didn’t add the bundle):
  <script src="~/lib/fullcalendar/core/index.global.min.js"></script>
  <script src="~/lib/fullcalendar/daygrid/index.global.min.js"></script>
  <script src="~/lib/fullcalendar/timegrid/index.global.min.js"></script>
  <script src="~/lib/fullcalendar/list/index.global.min.js"></script>
  <script src="~/lib/fullcalendar/interaction/index.global.min.js"></script>
  -->

  <script src="~/js/calendar.js" asp-append-version="true"></script>
}
