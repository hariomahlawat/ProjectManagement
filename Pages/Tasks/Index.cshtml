@page
@model ProjectManagement.Pages.Tasks.IndexModel
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@{
    ViewData["Title"] = "My Tasks";
}

@section Styles {
  <link rel="stylesheet" href="~/css/tasks.css" asp-append-version="true" />
}

<nav aria-label="breadcrumb" class="mb-2">
  <ol class="breadcrumb small mb-0">
    <li class="breadcrumb-item"><a asp-page="/Dashboard/Index">Dashboard</a></li>
    <li class="breadcrumb-item active" aria-current="page">My Tasks</li>
  </ol>
</nav>

<h4 class="mb-3">My Tasks</h4>

@if (TempData["Error"] is string err && !string.IsNullOrWhiteSpace(err))
{
  <div class="alert alert-warning py-2"><i class="bi bi-exclamation-triangle-fill me-2"></i>@err</div>
}

@if (TempData["UndoId"] is string undo && Guid.TryParse(undo, out var undoId))
{
  <form method="post" asp-page-handler="Undo" class="alert alert-success py-2 d-flex justify-content-between align-items-center">
    @Html.AntiForgeryToken()
    <input type="hidden" name="id" value="@undoId" />
    <div><i class="bi bi-check2-circle me-2"></i>Task marked done.</div>
    <button class="btn btn-sm btn-outline-success">Undo</button>
  </form>
}

<form method="get" class="d-flex flex-wrap gap-2 align-items-center mb-3">
  <select class="form-select form-select-sm w-auto" name="tab">
    <option value="all" selected="@(Model.Tab=="all")">All</option>
    <option value="today" selected="@(Model.Tab=="today")">Today</option>
    <option value="upcoming" selected="@(Model.Tab=="upcoming")">Upcoming</option>
    <option value="completed" selected="@(Model.Tab=="completed")">Completed</option>
  </select>
  <input class="form-control form-control-sm w-auto" name="q" value="@Model.Q" placeholder="Search">
  <select class="form-select form-select-sm w-auto" name="PageSize">
    <option value="10" selected="@(Model.PageSize==10)">10</option>
    <option value="25" selected="@(Model.PageSize==25)">25</option>
    <option value="50" selected="@(Model.PageSize==50)">50</option>
  </select>
  <button class="btn btn-sm btn-primary">Apply</button>
  <a class="btn btn-sm btn-outline-secondary" asp-page="Index">Reset</a>
</form>

<form method="post" asp-page-handler="Add" class="input-group input-group-sm mb-2" style="max-width:520px">
  @Html.AntiForgeryToken()
  <input class="form-control" name="NewTitle" placeholder="Add a taskâ€¦" maxlength="160" required />
  <button class="btn btn-primary">Add</button>
</form>

@if (Model.Tab=="completed" && Model.Groups.Length > 0 && Model.Groups[0].Items.Length > 0)
{
    <form method="post" asp-page-handler="ClearCompleted" class="mb-2">
      @Html.AntiForgeryToken()
      <button class="btn btn-sm btn-outline-danger" data-confirm="Clear all completed tasks?">Clear all completed</button>
    </form>
}

<div id="taskListContainer">
  <partial name="_TaskList" model="Model" />
</div>

@if (Model.TotalPages > 1)
{
  <nav class="mt-2">
    <ul class="pagination pagination-sm mb-0">
      @for (var p = 1; p <= Model.TotalPages; p++)
      {
        <li class="page-item @(p==Model.Page ? "active" : "")">
          <a class="page-link" href="@Url.Page(null, new { tab = Model.Tab, q = Model.Q, page = p, pageSize = Model.PageSize })">@p</a>
        </li>
      }
    </ul>
  </nav>

}

@section Scripts {
  <script src="~/js/tasks-page.js" asp-append-version="true" defer></script>
}

