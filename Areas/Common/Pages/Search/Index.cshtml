@page
@model ProjectManagement.Areas.Common.Pages.Search.IndexModel
@{
    ViewData["Title"] = "Global Search";
    var hasQuery = !string.IsNullOrWhiteSpace(Model.Q);

    // helpers to build querystring links for “tabs”
    string BuildUrl(string? q, IEnumerable<string>? sources)
    {
        var qp = System.Web.HttpUtility.ParseQueryString(string.Empty);
        if (!string.IsNullOrWhiteSpace(q)) qp["q"] = q;

        if (sources != null)
        {
            foreach (var s in sources)
                qp.Add("Source", s);
        }

        return $"?{qp}";
    }

    // work with distinct, case-insensitive sources
    var allSources = Model.AvailableSources
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .ToList();

    var selectedSources = (Model.Source ?? Array.Empty<string>())
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .ToList();

    bool IsSelected(string s) => selectedSources.Contains(s, StringComparer.OrdinalIgnoreCase);
}

// ==============================
// HERO (no query)
// ==============================
@if (!hasQuery)
{
    <section class="pm-gs-hero">
        <div class="pm-gs-hero__logo">Project<span>Management</span></div>
        <div class="pm-gs-hero__tag">Search across documents, projects, FFC/IPR, and trackers.</div>

        <form method="get" asp-area="Common" asp-page="/Search/Index" class="pm-gs-search">
            <i class="bi bi-search pm-gs-search__icon" aria-hidden="true"></i>
            <input type="text"
                   name="q"
                   value="@Model.Q"
                   class="pm-gs-search__input"
                   placeholder="Search anything…"
                   autocomplete="off" />
            <button class="pm-gs-search__clear" type="reset" aria-label="Clear">×</button>
            <button class="pm-gs-search__btn" type="submit">Search</button>
        </form>
    </section>
}
else
{
    // ==============================
    // TOP BAR (edge-to-edge)
    // ==============================
    <header class="pm-gs-top">
        <div class="pm-gs-top__inner">
            <form method="get" asp-area="Common" asp-page="/Search/Index" class="pm-gs-top__form">
                <div class="pm-gs-top__search">
                    <i class="bi bi-search pm-gs-top__icon" aria-hidden="true"></i>
                    <input type="text"
                           name="q"
                           value="@Model.Q"
                           class="pm-gs-top__input"
                           placeholder="Search anything…" />
                    <button class="pm-gs-top__clear" type="reset" aria-label="Clear">×</button>
                </div>
                <button class="pm-gs-top__button" type="submit">Search</button>
            </form>

            @if (allSources.Count > 0)
            {
                <nav class="pm-gs-tabs" aria-label="Result sources">
                    <a class="pm-gs-tab @(selectedSources.Count == 0 ? "is-active" : "")"
                       href="@BuildUrl(Model.Q, Enumerable.Empty<string>())">
                        All
                    </a>

                    @foreach (var s in allSources)
                    {
                        var active = IsSelected(s);
                        var newSelection = active
                        ? selectedSources.Where(x => !string.Equals(x, s, StringComparison.OrdinalIgnoreCase))
                        : selectedSources.Append(s);

                        <a class="pm-gs-tab @(active ? "is-active" : "")"
                           href="@BuildUrl(Model.Q, newSelection)">
                            @s
                        </a>
                    }
                </nav>
            }
        </div>
    </header>

    // ==============================
    // RESULTS
    // ==============================
    <main class="pm-gs-body" role="main">
        <div class="pm-gs-body__inner">
            <div class="pm-gs-meta">@Model.Results.Count result@(Model.Results.Count == 1 ? "" : "s")</div>

            @if (Model.Results.Count > 0)
            {
                <section class="pm-gs-results" aria-label="Search results">
                    @foreach (var hit in Model.Results)
                    {
                        <article class="pm-gs-hit">
                            <a class="pm-gs-hit__title" href="@hit.Url">@hit.Title</a>

                            <div class="pm-gs-hit__meta">
                                @if (!string.IsNullOrWhiteSpace(hit.Source))
                                {
                                    <span class="pm-gs-hit__source">@hit.Source</span>
                                }
                                @if (hit.Date.HasValue)
                                {
                                    <span class="pm-gs-hit__sep">·</span>
                                    <time datetime="@hit.Date.Value.ToUniversalTime().ToString("u")">
                                        @hit.Date.Value.ToLocalTime().ToString("dd MMM yyyy HH:mm")
                                    </time>
                                }
                                @if (!string.IsNullOrWhiteSpace(hit.FileType))
                                {
                                    <span class="pm-gs-hit__sep">·</span>
                                    <span>@hit.FileType</span>
                                }
                            </div>

                            @if (!string.IsNullOrWhiteSpace(hit.Snippet))
                            {
                                var hasMarkup = hit.Snippet.Contains("<mark>", StringComparison.OrdinalIgnoreCase);
                                if (hasMarkup)
                                {
                                    <p class="pm-gs-hit__snippet">@Html.Raw(hit.Snippet)</p>
                                }
                                else
                                {
                                    <p class="pm-gs-hit__snippet">@hit.Snippet</p>
                                }
                            }
                        </article>
                    }
                </section>
            }
            else
            {
                <section class="pm-gs-nores">
                    <div class="pm-gs-nores__box">
                        <div class="pm-gs-nores__title">No results for “@Model.Q”.</div>
                        <ul class="pm-gs-nores__tips">
                            <li>Check spelling.</li>
                            <li>Try fewer or different keywords.</li>
                            <li>Switch or clear source tabs above.</li>
                        </ul>
                    </div>
                </section>
            }
        </div>
    </main>
}

@section Styles {
    <link rel="stylesheet" href="~/css/search.css" asp-append-version="true" />
}
