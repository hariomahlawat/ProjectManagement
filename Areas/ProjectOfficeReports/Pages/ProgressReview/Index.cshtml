@page
@using System
@using System.Collections.Generic
@using System.Net
@using System.Globalization
@using System.Text.RegularExpressions
@using ProjectManagement.Models.Remarks
@using ProjectManagement.Services.Reports.ProgressReview
@model ProjectManagement.Areas.ProjectOfficeReports.Pages.ProgressReview.IndexModel
@{
    ViewData["Title"] = "Progress Review";
    ViewData["UseFullWidth"] = true;
    var vm = Model.Report;

    string RenderRemarkHtml(string? text)
    {
        if (string.IsNullOrWhiteSpace(text))
        {
            return string.Empty;
        }

        var encoded = WebUtility.HtmlEncode(text)
            .Replace("\r\n", "<br>")
            .Replace("\n", "<br>");
        // Match any encoded <span class="remark-mention" ...>...</span> regardless of extra attributes.
        const string mentionPattern =
            "&lt;span\\s+class=&quot;remark-mention&quot;.*?&gt;(.*?)&lt;/span&gt;";
        return Regex.Replace(
            encoded,
            mentionPattern,
            match => $"<span class=\"badge remark-pill\">{match.Groups[1].Value}</span>",
            RegexOptions.IgnoreCase | RegexOptions.CultureInvariant | RegexOptions.Singleline);
    }

    string FormatDateIso(DateOnly d) => d.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture);

    string FormatDay(DateOnly d)
    {
        if (vm is null)
        {
            return d.ToString("dd MMM yyyy");
        }

        return d.Year == vm.Range.To.Year
            ? d.ToString("dd MMM")
            : d.ToString("dd MMM yyyy");
    }



    string? FormatRemarkRole(RemarkActorRole? role) => role switch
    {
        RemarkActorRole.ProjectOfficer => "PO",
        RemarkActorRole.HeadOfDepartment => "HoD",
        RemarkActorRole.Commandant => "Comdt",
        RemarkActorRole.Administrator => "Admin",
        RemarkActorRole.Mco => "MCO",
        RemarkActorRole.ProjectOffice => "Project Office",
        RemarkActorRole.MainOffice => "Main Office",
        RemarkActorRole.Ta => "TA",
        _ => null
    };

    string? BuildRemarkTooltip(ProjectRemarkSummaryVm summary)
    {
        if (!summary.LatestRemarkDate.HasValue && string.IsNullOrWhiteSpace(summary.LatestRemarkSummary))
        {
            return null;
        }

        var parts = new List<string>();
        if (summary.LatestRemarkDate.HasValue)
        {
            parts.Add(summary.LatestRemarkDate.Value.ToString("dd MMM yyyy"));
        }

        var roleLabel = FormatRemarkRole(summary.LatestRemarkAuthorRole);
        if (!string.IsNullOrWhiteSpace(roleLabel))
        {
            parts.Add(roleLabel!);
        }

        if (!string.IsNullOrWhiteSpace(summary.LatestRemarkSummary))
        {
            parts.Add(summary.LatestRemarkSummary!);
        }

        return parts.Count == 0 ? null : WebUtility.HtmlEncode(string.Join(" — ", parts));
    }

    DateOnly? GetMovementDate(ProjectStageMovementVm movement) => movement.IsOngoing ? movement.StartedOn : movement.CompletedOn;

    string? BuildVisitPhotoUrl(Guid visitId, Guid? photoId)
    {
        if (!photoId.HasValue)
        {
            return null;
        }

        return Url.Page(
            "/Visits/ViewPhoto",
            new { area = "ProjectOfficeReports", id = visitId, photoId = photoId.Value, size = "xs" });
    }

    string? BuildSocialPhotoUrl(Guid eventId, Guid? photoId)
    {
        if (!photoId.HasValue)
        {
            return null;
        }

        return Url.Page(
            "/SocialMedia/ViewPhoto",
            new { area = "ProjectOfficeReports", id = eventId, photoId = photoId.Value, size = "thumb" });
    }

    string? BuildActivityPhotoUrl(int activityId, Guid? photoId)
    {
        if (!photoId.HasValue)
        {
            return null;
        }

        return Url.Page(
            "/Activities/ViewPhoto",
            new { area = "ProjectOfficeReports", id = activityId, photoId = photoId.Value, size = "thumb" });
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/progress-review.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/progress-review.print.css" asp-append-version="true" />
}

<div class="progress-review-shell" data-page-id="progress-review">
    <div class="container-xxl">
        <div class="progress-review__toolbar">
            <div class="progress-review__title-block">
                <p class="progress-review__eyebrow text-muted">Project office reports</p>
                <h1 class="h4 mb-0">Progress Review</h1>
            </div>
            <div class="progress-review__toolbar-actions">
                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#progress-review-range">Date range</button>
                <button class="btn btn-primary btn-sm" type="button" data-action="print">
                    <i class="bi bi-printer me-1"></i>
                    <span class="d-none d-md-inline">Print</span>
                </button>
            </div>
        </div>
    </div>

    <div class="container-xxl">
        @if (vm is null)
        {
            <div class="alert alert-info">Unable to load progress data for the selected range.</div>
        }
        else
        {
            <article class="progress-review__canvas">
                <header class="progress-review__document-header">
                    <div>
                        <p class="text-uppercase text-muted small fw-semibold mb-0">Reporting period</p>
                        <h2 class="h6 mb-0">@vm.Range.From.ToString("dd MMM yyyy") – @vm.Range.To.ToString("dd MMM yyyy")</h2>
                    </div>
                    
                </header>

                @* SECTION: Project progress buckets *@
                <section class="progress-review__section pr-section" id="project-progress">
                    <header class="progress-review__section-header">
                        <div>
                            <span class="progress-review__section-label pr-section-label" aria-hidden="true">Section 01</span>
                            <h2 class="progress-review__section-title pr-section-title">Ongoing projects progress</h2>
                            <div class="pr-section-divider"></div>
                        </div>
                        <p class="progress-review__section-meta pr-meta">@vm.Projects.SummaryRows.Count projects in scope</p>
                    </header>

                    @if (!vm.Projects.CategoryGroups.Any())
                    {
                        <p class="text-muted small mb-0">No qualifying projects for the selected range.</p>
                    }
                    else
                    {
                        <div class="pr-category-stack">
                            @foreach (var group in vm.Projects.CategoryGroups)
                            {
                                <section class="pr-category-block" aria-label="@group.CategoryName">
                                    <div class="pr-category-header">
                                        <span>@group.CategoryName</span>
                                        <span class="pr-category-count">@group.Projects.Count projects</span>
                                    </div>
                                    <div class="pr-project-list">
                                        @foreach (var row in group.Projects)
                                        {
                                            var stageMovements = row.StageMovements ?? Array.Empty<ProjectStageMovementVm>();
                                            var projectDetailsUrl = Url.Page("/Projects/Overview", new { id = row.ProjectId });
                                            var stageName = string.IsNullOrWhiteSpace(row.PresentStage.CurrentStageName) ? "Stage pending" : row.PresentStage.CurrentStageName;
                                            <article class="pr-project-row">
                                                <div>
                                                    <a class="progress-review__link pr-project-name" href="@projectDetailsUrl">@row.ProjectName</a>
                                                    @if (!string.IsNullOrWhiteSpace(row.ProjectCategoryName))
                                                    {
                                                        <div class="pr-meta">@row.ProjectCategoryName</div>
                                                    }
                                                </div>
                                                <div class="pr-stage-line">Present stage — <span class="fw-semibold">@stageName</span></div>
                                                <div class="pr-meta">@((row.PresentStage.DaysSinceStartOrLastCompletion ?? 0)) days passed</div>
                                                @if (stageMovements.Any())
                                                {
                                                    @foreach (var movement in stageMovements)
                                                    {
                                                        var movementDate = GetMovementDate(movement);
                                                        var actionText = movement.IsOngoing ? "started on" : "completed on";
                                                        <div class="pr-movement-line">
                                                            <strong>@movement.StageName</strong> @actionText
                                                            @if (movementDate.HasValue)
                                                            {
                                                                <time datetime="@FormatDateIso(movementDate.Value)">@FormatDay(movementDate.Value)</time>
                                                            }
                                                            else
                                                            {
                                                                <span>date N/A</span>
                                                            }
                                                        </div>
                                                    }
                                                    @if (row.StageMovementOverflowCount > 0)
                                                    {
                                                        <div class="pr-meta">Showing top @stageMovements.Count of @(stageMovements.Count + row.StageMovementOverflowCount) movements</div>
                                                    }
                                                }
                                                else
                                                {
                                                    <div class="pr-meta">No stage movements recorded in this range.</div>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(row.RemarkSummary.LatestRemarkSummary))
                                                {
                                                    var remarkHtml = RenderRemarkHtml(row.RemarkSummary.LatestRemarkSummary);
                                                    var tooltip = BuildRemarkTooltip(row.RemarkSummary);
                                                    <div class="pr-remark-line" title="@tooltip">
                                                        <span class="pr-meta">@((row.RemarkSummary.LatestRemarkDate.HasValue ? FormatDay(row.RemarkSummary.LatestRemarkDate.Value) : "Date N/A"))</span>
                                                        <span class="pr-meta">·</span>
                                                        <span class="pr-body">@Html.Raw(remarkHtml)</span>
                                                    </div>
                                                    @if (row.RemarkSummary.MoreRemarkCount > 0)
                                                    {
                                                        <div class="pr-meta">Latest external remark shown</div>
                                                    }
                                                }
                                                else
                                                {
                                                    <div class="pr-meta fst-italic">No external remarks in range.</div>
                                                }
                                            </article>
                                        }
                                    </div>
                                </section>
                            }
                        </div>
                    }
                </section>

                @* SECTION: Visits and Social media outreach *@
                <section class="progress-review__section pr-section" id="field-engagement">
                    <header class="progress-review__section-header">
                        <div>
                            <span class="progress-review__section-label pr-section-label" aria-hidden="true">Section 02</span>
                            <h2 class="progress-review__section-title pr-section-title">Visits to SDD & social media outreach</h2>
                            <p class="progress-review__section-subtitle pr-meta">Visits to SDD and social narratives captured for documentation.</p>
                            <div class="pr-section-divider"></div>
                        </div>
                    </header>
                    <div class="pr-category-stack">
                        <section class="pr-category-block" aria-label="Visits log">
                            <div class="pr-category-header">
                                <span>Visits log</span>
                                <span class="pr-category-count">@vm.Visits.TotalCount entries</span>
                            </div>
                            @if (!vm.Visits.Items.Any())
                            {
                                <p class="pr-meta mb-0 px-3 py-2">No visits recorded in this range.</p>
                            }
                            else
                            {
                                var visitLimit = 6;
                                <ul class="list-unstyled mb-0 px-3">
                                    @foreach (var visit in vm.Visits.Items.Take(visitLimit))
                                    {
                                        var visitPhotoUrl = BuildVisitPhotoUrl(visit.Id, visit.DisplayPhotoId);
                                        var visitDetailsUrl = Url.Page(
                                            "/Visits/Details",
                                            new { area = "ProjectOfficeReports", id = visit.Id });
                                        var visitPhotoAlt = string.IsNullOrWhiteSpace(visit.VisitorName)
                                            ? "Visit photo"
                                            : $"{visit.VisitorName} visit photo";
                                        <li class="pr-media-item">
                                            <div class="pr-media-thumb">
                                                @if (!string.IsNullOrWhiteSpace(visitPhotoUrl))
                                                {
                                                    <img role="img" src="@visitPhotoUrl" alt="@visitPhotoAlt" loading="lazy" width="72" height="72" />
                                                }
                                            </div>
                                            <div class="pr-media-content">
                                                <a class="progress-review__link progress-review__link--block" href="@visitDetailsUrl">
                                                    <div class="pr-media-title">@visit.VisitorName <span class="pr-meta">(@visit.VisitType)</span></div>
                                                    <div class="pr-media-sub"><time datetime="@FormatDateIso(visit.Date)">@FormatDay(visit.Date)</time> · Strength @visit.Strength</div>
                                                    @if (!string.IsNullOrWhiteSpace(visit.Remarks))
                                                    {
                                                        <div class="pr-media-text">@visit.Remarks</div>
                                                    }
                                                    else
                                                    {
                                                        <div class="pr-meta">No remarks shared.</div>
                                                    }
                                                </a>
                                            </div>
                                        </li>
                                    }
                                </ul>
                                @if (vm.Visits.TotalCount > visitLimit)
                                {
                                    <p class="pr-meta px-3 pb-2">Showing top @visitLimit of @vm.Visits.TotalCount visits.</p>
                                }
                            }
                        </section>
                        <section class="pr-category-block" aria-label="Social media">
                            <div class="pr-category-header">
                                <span>Social media</span>
                                <span class="pr-category-count">@vm.SocialMedia.TotalCount posts</span>
                            </div>
                            @if (!vm.SocialMedia.Items.Any())
                            {
                                <p class="pr-meta mb-0 px-3 py-2">No social media updates in this range.</p>
                            }
                            else
                            {
                                var socialLimit = 6;
                                <ul class="list-unstyled mb-0 px-3">
                                    @foreach (var post in vm.SocialMedia.Items.Take(socialLimit))
                                    {
                                        var postPhotoUrl = BuildSocialPhotoUrl(post.Id, post.DisplayPhotoId);
                                        var postDetailsUrl = Url.Page(
                                            "/SocialMedia/Details",
                                            new { area = "ProjectOfficeReports", id = post.Id });
                                        var postPhotoAlt = string.IsNullOrWhiteSpace(post.Title)
                                            ? "Social post photo"
                                            : $"{post.Title} social post";
                                        <li class="pr-media-item">
                                            <div class="pr-media-thumb">
                                                @if (!string.IsNullOrWhiteSpace(postPhotoUrl))
                                                {
                                                    <img role="img" src="@postPhotoUrl" alt="@postPhotoAlt" loading="lazy" width="72" height="72" />
                                                }
                                            </div>
                                            <div class="pr-media-content">
                                                <a class="progress-review__link progress-review__link--block" href="@postDetailsUrl">
                                                    <div class="pr-media-title">@post.Title</div>
                                                    <div class="pr-media-sub"><time datetime="@FormatDateIso(post.Date)">@FormatDay(post.Date)</time> · @post.Platform</div>
                                                    @if (!string.IsNullOrWhiteSpace(post.Description))
                                                    {
                                                        <div class="pr-media-text">@post.Description</div>
                                                    }
                                                    else
                                                    {
                                                        <div class="pr-meta">No caption provided.</div>
                                                    }
                                                </a>
                                            </div>
                                        </li>
                                    }
                                </ul>
                                @if (vm.SocialMedia.TotalCount > socialLimit)
                                {
                                    <p class="pr-meta px-3 pb-2">Showing top @socialLimit of @vm.SocialMedia.TotalCount posts.</p>
                                }
                            }
                        </section>
                    </div>
                </section>

                @* SECTION: Technology transfer & IPR *@
                <section class="progress-review__section pr-section" id="tech-transfer">
                    <header class="progress-review__section-header">
                        <div>
                            <span class="progress-review__section-label pr-section-label" aria-hidden="true">Section 03</span>
                            <h2 class="progress-review__section-title pr-section-title">Transfer of technology & Patent/ Copyrights</h2>
                            <div class="pr-section-divider"></div>
                        </div>
                    </header>
                    <div class="progress-review__stack">
                        <div class="progress-review__block">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h3 class="progress-review__subheading mb-0">Transfer of Technology</h3>
                                <span class="text-muted small">@vm.Tot.StageChanges.Count stage changes</span>
                            </div>
                            <div class="progress-review__mini-section">
                                <h4 class="progress-review__mini-heading">Stage changes</h4>
                                <ul class="list-unstyled small progress-review__list">
                                    @foreach (var entry in vm.Tot.StageChanges.Take(8))
                                    {
                                        var projectLink = Url.Page("/Projects/Overview", new { id = entry.ProjectId });
                                        <li>
                                            <strong><a class="progress-review__link" href="@projectLink">@entry.ProjectName</a></strong>
                                            <span class="text-muted">(<time datetime="@FormatDateIso(entry.ChangeDate)">@FormatDay(entry.ChangeDate)</time>)</span>
                                            <div>@entry.StageName: @entry.FromStatus → @entry.ToStatus</div>
                                        </li>
                                    }
                                    @if (!vm.Tot.StageChanges.Any())
                                    {
                                        <li class="text-muted">No stage changes recorded.</li>
                                    }
                                </ul>
                                @if (vm.Tot.StageChanges.Count > 8)
                                {
                                    <p class="text-muted small mt-2">Showing top 8 of @vm.Tot.StageChanges.Count changes.</p>
                                }
                            </div>
                            <div class="progress-review__mini-section">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <h4 class="progress-review__mini-heading mb-0">Remarks</h4>
                                    <span class="text-muted small">@vm.Tot.Remarks.Count remarks</span>
                                </div>
                                <ul class="list-unstyled small progress-review__list">
                                    @foreach (var entry in vm.Tot.Remarks.Take(8))
                                    {
                                        var projectLink = Url.Page("/Projects/Overview", new { id = entry.ProjectId });
                                        <li>
                                            <strong><a class="progress-review__link" href="@projectLink">@entry.ProjectName</a></strong>
                                            <span class="text-muted">(<time datetime="@FormatDateIso(entry.Date)">@FormatDay(entry.Date)</time>)</span>
                                            <div>@entry.Summary</div>
                                        </li>
                                    }
                                    @if (!vm.Tot.Remarks.Any())
                                    {
                                        <li class="text-muted">No remarks captured.</li>
                                    }
                                </ul>
                                @if (vm.Tot.Remarks.Count > 8)
                                {
                                    <p class="text-muted small mt-2">Showing top 8 of @vm.Tot.Remarks.Count remarks.</p>
                                }
                            </div>
                        </div>
                        <div class="progress-review__block mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h3 class="progress-review__subheading mb-0">Patents/ Copyrights updates</h3>
                                <span class="text-muted small">@vm.Ipr.StatusChanges.Count status changes</span>
                            </div>
                            <div class="progress-review__mini-section">
                                <h4 class="progress-review__mini-heading">Status changes</h4>
                                <ul class="list-unstyled small progress-review__list">
                                    @foreach (var entry in vm.Ipr.StatusChanges.Take(8))
                                    {
                                        var iprRecordUrl = Url.Page(
                                            "/ProjectOfficeReports/Ipr/Manage",
                                            new { area = "ProjectOfficeReports", EditId = entry.IprId });
                                        <li>
                                            <strong><a class="progress-review__link" href="@iprRecordUrl">@entry.Title</a></strong>
                                            <span class="text-muted">(<time datetime="@FormatDateIso(entry.EventDate)">@FormatDay(entry.EventDate)</time>)</span>
                                            <div>@entry.Status — @entry.Notes</div>
                                        </li>
                                    }
                                    @if (!vm.Ipr.StatusChanges.Any())
                                    {
                                        <li class="text-muted">No status transitions this period.</li>
                                    }
                                </ul>
                                @if (vm.Ipr.StatusChanges.Count > 8)
                                {
                                    <p class="text-muted small mt-2">Showing top 8 of @vm.Ipr.StatusChanges.Count changes.</p>
                                }
                            </div>
                            <div class="progress-review__mini-section">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <h4 class="progress-review__mini-heading mb-0">Remarks</h4>
                                    <span class="text-muted small">@vm.Ipr.Remarks.Count remarks</span>
                                </div>
                                <ul class="list-unstyled small progress-review__list">
                                    @foreach (var entry in vm.Ipr.Remarks.Take(8))
                                    {
                                        var iprRecordUrl = Url.Page(
                                            "/ProjectOfficeReports/Ipr/Manage",
                                            new { area = "ProjectOfficeReports", EditId = entry.IprId });
                                        <li>
                                            <strong><a class="progress-review__link" href="@iprRecordUrl">@entry.Title</a></strong>
                                            <span class="text-muted">(<time datetime="@FormatDateIso(entry.EventDate)">@FormatDay(entry.EventDate)</time>)</span>
                                            <div>@entry.Summary</div>
                                        </li>
                                    }
                                    @if (!vm.Ipr.Remarks.Any())
                                    {
                                        <li class="text-muted">No remarks captured.</li>
                                    }
                                </ul>
                                @if (vm.Ipr.Remarks.Count > 8)
                                {
                                    <p class="text-muted small mt-2">Showing top 8 of @vm.Ipr.Remarks.Count remarks.</p>
                                }
                            </div>
                        </div>
                    </div>
                </section>

                @* SECTION: Training *@
                <section class="progress-review__section pr-section" id="training">
                    <header class="progress-review__section-header">
                        <div>
                            <span class="progress-review__section-label pr-section-label" aria-hidden="true">Section 04</span>
                            <h2 class="progress-review__section-title pr-section-title">Training conducted by SDD</h2>
                            <p class="progress-review__section-subtitle pr-meta">Simulator and drone training efforts for the period.</p>
                            <div class="pr-section-divider"></div>
                        </div>
                    </header>
                    <div class="progress-review__stack">
                        <div class="progress-review__block">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h3 class="progress-review__subheading mb-0">Simulator training (@vm.Training.Simulator.TotalPersons participants)</h3>
                                <span class="text-muted small">@vm.Training.Simulator.Rows.Count sessions</span>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm mb-0 progress-review__table">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col">Date</th>
                                            <th scope="col">Title</th>
                                            <th scope="col">Unit / Org</th>
                                            <th scope="col">Persons</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var row in vm.Training.Simulator.Rows.Take(8))
                                        {
                                            <tr>
                                                <td><time datetime="@FormatDateIso(row.Date)">@FormatDay(row.Date)</time></td>
                                                <td>@row.Title</td>
                                                <td>@row.UnitOrOrg</td>
                                                <td>@row.Persons</td>
                                            </tr>
                                        }
                                        @if (!vm.Training.Simulator.Rows.Any())
                                        {
                                            <tr>
                                                <td colspan="4" class="text-muted text-center small">No simulator trainings recorded.</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                                @if (vm.Training.Simulator.Rows.Count > 8)
                                {
                                    <p class="text-muted small mt-2">Showing top 8 of @vm.Training.Simulator.Rows.Count sessions.</p>
                                }
                            </div>
                        </div>
                        <div class="progress-review__block mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h3 class="progress-review__subheading mb-0">Drone training (@vm.Training.Drone.TotalPersons participants)</h3>
                                <span class="text-muted small">@vm.Training.Drone.Rows.Count sessions</span>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm mb-0 progress-review__table">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col">Date</th>
                                            <th scope="col">Title</th>
                                            <th scope="col">Unit / Org</th>
                                            <th scope="col">Persons</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var row in vm.Training.Drone.Rows.Take(8))
                                        {
                                            <tr>
                                                <td><time datetime="@FormatDateIso(row.Date)">@FormatDay(row.Date)</time></td>
                                                <td>@row.Title</td>
                                                <td>@row.UnitOrOrg</td>
                                                <td>@row.Persons</td>
                                            </tr>
                                        }
                                        @if (!vm.Training.Drone.Rows.Any())
                                        {
                                            <tr>
                                                <td colspan="4" class="text-muted text-center small">No drone trainings recorded.</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                                @if (vm.Training.Drone.Rows.Count > 8)
                                {
                                    <p class="text-muted small mt-2">Showing top 8 of @vm.Training.Drone.Rows.Count sessions.</p>
                                }
                            </div>
                        </div>
                    </div>
                </section>

                @* SECTION: Proliferation & FFC *@
                <section class="progress-review__section" id="proliferation">
                    <header class="progress-review__section-header">
                        <div>
                            <span class="progress-review__section-label" aria-hidden="true">Section 05</span>
                            <h2 class="progress-review__section-title">Proliferation & FFC simulators</h2>
                            <p class="progress-review__section-subtitle">Proloferation of simulators to units and to friendly foreign counteries.</p>
                        </div>
                    </header>
                    <div class="progress-review__stack">
                        <div class="progress-review__block">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h3 class="progress-review__subheading mb-0">Proliferation (@vm.Proliferation.Rows.Count records)</h3>
                                <span class="text-muted small">@vm.Proliferation.Rows.Count entries</span>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm mb-0 progress-review__table">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col">Date</th>
                                            <th scope="col">Project</th>
                                            <th scope="col">Unit</th>
                                            <th scope="col">Qty</th>
                                            <th scope="col">Source</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var row in vm.Proliferation.Rows.Take(10))
                                        {
                                            var projectLink = Url.Page("/Projects/Overview", new { id = row.ProjectId });
                                            <tr>
                                                <td><time datetime="@FormatDateIso(row.Date)">@FormatDay(row.Date)</time></td>
                                                <td><a class="progress-review__link" href="@projectLink">@row.ProjectName</a></td>
                                                <td>@row.UnitOrCountry</td>
                                                <td>@row.Quantity</td>
                                                <td>@row.Source</td>
                                            </tr>
                                        }
                                        @if (!vm.Proliferation.Rows.Any())
                                        {
                                            <tr>
                                                <td colspan="5" class="text-muted text-center small">No proliferation entries for this range.</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                                @if (vm.Proliferation.Rows.Count > 10)
                                {
                                    <p class="text-muted small mt-2">Showing top 10 of @vm.Proliferation.Rows.Count proliferation entries.</p>
                                }
                            </div>
                        </div>
                        <div class="progress-review__block mt-3">
                            @{
                                var gCount = vm.FfcDetailedIncompleteGroups.Length;
                                var gLabel = gCount == 1 ? "group" : "groups";
                            }
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h3 class="progress-review__subheading mb-0">FFC simulators - detailed (in progress only)</h3>
                                <span class="text-muted small">@gCount in progress @gLabel</span>
                            </div>
                            @if (vm.FfcDetailedIncompleteGroups.Any())
                            {
                                <partial name="~/Areas/ProjectOfficeReports/Pages/FFC/_DetailedTablePartial.cshtml"
                                         model="vm.FfcDetailedIncompleteGroups" />
                            }
                            else
                            {
                                <p class="text-muted mb-0">No in-progress FFC country-year records right now.</p>
                            }
                        </div>
                    </div>
                </section>

                @* SECTION: Miscellaneous activities *@
                <section class="progress-review__section" id="miscellaneous">
                    <header class="progress-review__section-header">
                        <div>
                            <span class="progress-review__section-label" aria-hidden="true">Section 06</span>
                            <h2 class="progress-review__section-title">Miscellaneous activities</h2>
                            <p class="progress-review__section-subtitle">Additional highlights requiring documentation.</p>
                        </div>
                        <p class="progress-review__section-meta text-muted">@vm.Misc.Rows.Count activities</p>
                    </header>
                    @if (!vm.Misc.Rows.Any())
                    {
                        <p class="text-muted mb-0">No activities captured in this range.</p>
                    }
                    else
                    {
                        var miscLimit = 10;
                        <div class="progress-review__stack">
                            @foreach (var act in vm.Misc.Rows.Take(miscLimit))
                            {
                                var photoUrl = BuildActivityPhotoUrl(act.ActivityId, act.DisplayPhotoId) ?? act.PhotoUrl;
                                <div class="pr-media-item">
                                    <div class="pr-media-thumb">
                                        @if (!string.IsNullOrWhiteSpace(photoUrl))
                                        {
                                            <img src="@photoUrl" alt="Activity photo" />
                                        }
                                    </div>

                                    <div class="pr-media-content">
                                        <div class="pr-media-title">@act.Title</div>
                                        <div class="pr-media-sub">
                                            @act.Date.ToString("dd MMM yyyy")
                                            @if (!string.IsNullOrWhiteSpace(act.Location))
                                            {
                                                <span class="pr-meta"> · @act.Location</span>
                                            }
                                        </div>

                                        @if (!string.IsNullOrWhiteSpace(act.Summary))
                                        {
                                            <div class="pr-media-text pr-line-clamp-3">
                                                @act.Summary
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            @if (vm.Misc.Rows.Count > miscLimit)
                            {
                                <div class="pr-meta fst-italic mt-1">
                                    Showing top @miscLimit of @vm.Misc.Rows.Count activities.
                                </div>
                            }
                        </div>
                    }
                </section>
            </article>
        }
    </div>
</div>

<div class="modal fade" id="progress-review-range" tabindex="-1" aria-labelledby="progress-review-range-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progress-review-range-label">Select date range</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="progress-review-filter" method="get">
                <div class="modal-body">
                    <div class="row gy-3">
                        <div class="col-12 col-sm-6">
                            <label class="form-label form-label-sm text-muted" for="from">From</label>
                            <input class="form-control" id="from" name="from" type="date" value="@(Model.From?.ToString("yyyy-MM-dd"))" />
                        </div>
                        <div class="col-12 col-sm-6">
                            <label class="form-label form-label-sm text-muted" for="to">To</label>
                            <input class="form-control" id="to" name="to" type="date" value="@(Model.To?.ToString("yyyy-MM-dd"))" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" type="submit">Show report</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/pages/project-office-reports/progress-review.js" asp-append-version="true"></script>
}
