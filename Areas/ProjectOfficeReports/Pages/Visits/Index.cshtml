@page
@model ProjectManagement.Areas.ProjectOfficeReports.Pages.Visits.IndexModel
@using System.Linq
@{
    ViewData["Title"] = "Visits";

    // normalize incoming dates for inputs
    string? fromValue = Model.From;
    DateOnly? parsedFrom = null;
    if (!string.IsNullOrWhiteSpace(fromValue) && DateOnly.TryParse(fromValue, out var parsed))
    {
        parsedFrom = parsed;
        fromValue = parsedFrom.Value.ToString("yyyy-MM-dd");
    }

    string? toValue = Model.To;
    DateOnly? parsedTo = null;
    if (!string.IsNullOrWhiteSpace(toValue) && DateOnly.TryParse(toValue, out var parsedEnd))
    {
        parsedTo = parsedEnd;
        toValue = parsedTo.Value.ToString("yyyy-MM-dd");
    }

    // base data
    var latestVisitItem = Model.Items
        .OrderByDescending(item => item.DateOfVisit)
        .ThenByDescending(item => item.PhotoCount)
        .FirstOrDefault();
    
    var totalPeopleInView = Model.Items.Sum(item => item.Strength);


    // filter state
    var hasFilters = Model.VisitTypeId.HasValue
                     || !string.IsNullOrWhiteSpace(Model.From)
                     || !string.IsNullOrWhiteSpace(Model.To)
                     || !string.IsNullOrWhiteSpace(Model.Q);

    string? selectedTypeLabel = null;
    if (Model.VisitTypeId.HasValue)
    {
        selectedTypeLabel = Model.VisitTypeOptions.FirstOrDefault(option => option.Value == Model.VisitTypeId.Value.ToString())?.Text;
    }

    // time-based metrics you wanted
    var today = DateOnly.FromDateTime(DateTime.Today);
    var last30From = today.AddDays(-30);
    var lastYearFrom = today.AddYears(-1);

    var visitsLastYear = Model.Items.Count(item => item.DateOfVisit >= lastYearFrom);
    var peopleLastYear = Model.Items.Where(item => item.DateOfVisit >= lastYearFrom).Sum(item => item.Strength);

    var visitsLast30 = Model.Items.Count(item => item.DateOfVisit >= last30From);
    var peopleLast30 = Model.Items.Where(item => item.DateOfVisit >= last30From).Sum(item => item.Strength);

    // toasts
    var toastMessages = new List<VisitToastMessage>();
    if (TempData.TryGetValue("ToastMessage", out var toastMessageValue) && toastMessageValue is string toastMessage && !string.IsNullOrWhiteSpace(toastMessage))
    {
        toastMessages.Add(new VisitToastMessage(toastMessage, "success"));
    }
    if (TempData.TryGetValue("ToastError", out var toastErrorValue) && toastErrorValue is string toastError && !string.IsNullOrWhiteSpace(toastError))
    {
        toastMessages.Add(new VisitToastMessage(toastError, "danger"));
    }

    // ===== chart data =====
    // monthly: last 12 months including current month
    var firstOfThisMonth = new DateOnly(today.Year, today.Month, 1);
    var startMonth = firstOfThisMonth.AddMonths(-11); // 12 months window

    var monthlyPoints = Enumerable.Range(0, 12)
        .Select(i => startMonth.AddMonths(i))
        .Select(month =>
        {
            var visitsInMonth = Model.Items
                .Where(v => v.DateOfVisit.Year == month.Year && v.DateOfVisit.Month == month.Month)
                .ToList();

            return new
            {
                label = month.ToString("MMM yy"),   // e.g. "Nov 25"
                visits = visitsInMonth.Count,
                strength = visitsInMonth.Sum(v => v.Strength)
            };
        })
        .ToList();

    // pie: visit types (we'll filter on client for lastYear/all)
    var allVisitTypes = Model.Items
        .GroupBy(v => v.VisitTypeName ?? "Unspecified")
        .OrderByDescending(g => g.Count())
        .Select(g => new
        {
            name = g.Key,
            count = g.Count(),
            countLastYear = g.Count(v => v.DateOfVisit >= lastYearFrom)
        })
        .ToList();

}

<partial name="_ToastMessages" model="toastMessages" />

<div class="visit-shell visit-tracker visit-shell--tight">
    <!-- top bar -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3 mt-1">
        <div>
            <nav aria-label="Breadcrumb" class="visit-breadcrumb mb-1">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a asp-area="" asp-page="/Dashboard/Index">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Visit tracker</li>
                </ol>
            </nav>
            <div class="d-flex align-items-center gap-3">
                <h2 class="h2 mb-1">Visits to SDD</h2>
            </div>
            <p class="text-muted small mb-0 mt-2">
                Track SDD visits by civilian/military dignitaries and officer courses, with dates, strength and photos.
            </p>

        </div>
        <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-outline-secondary d-inline-flex align-items-center gap-1" data-bs-toggle="modal" data-bs-target="#visitsFiltersModal">
                <i class="bi bi-sliders"></i>
                <span>Filters</span>
                @if (hasFilters)
                {
                    <span class="badge bg-primary rounded-pill ms-1">
                        !
                        <span class="visually-hidden">Filters applied</span>
                    </span>
                }
            </button>
            @if (Model.Items.Count > 0)
            {
                <button type="button" class="btn btn-outline-secondary d-inline-flex align-items-center gap-1" data-bs-toggle="modal" data-bs-target="#exportVisitsModal">
                    <i class="bi bi-file-earmark-spreadsheet"></i>
                    <span>Export</span>
                </button>
            }
            @if (Model.CanManage)
            {
                <a asp-page="New" class="btn btn-primary d-inline-flex align-items-center gap-1">
                    <i class="bi bi-plus-circle"></i>
                    <span>Record a visit</span>
                </a>
            }
        </div>
    </div>

    <!-- meta line -->
    <div class="d-flex flex-wrap gap-3 mb-2">
        @if (latestVisitItem is not null)
        {
            <span class="text-muted small d-inline-flex align-items-center gap-1">
                <i class="bi bi-clock-history" aria-hidden="true"></i>
                Latest: @latestVisitItem.DateOfVisit.ToString("dd MMM yyyy") (@latestVisitItem.VisitorName)
            </span>
        }

        @if (hasFilters)
        {
            <a asp-page="Index" class="text-decoration-none small d-inline-flex align-items-center gap-1 text-secondary">
                <i class="bi bi-x-circle" aria-hidden="true"></i>
                Clear filters
            </a>
        }
    </div>

    <!-- KPI strip -->
    <section class="kpi-strip mb-3">
        <div class="kpi-card kpi-card--blue">
            <div class="kpi-card__top">
                <i class="bi bi-calendar3-week"></i>
                <span>Visits in last 12 months</span>
            </div>
            <div class="kpi-card__value">@visitsLastYear</div>
            @if (hasFilters)
            {
                <div class="kpi-card__hint">based on filtered set</div>
            }
        </div>
        <div class="kpi-card kpi-card--teal">
            <div class="kpi-card__top">
                <i class="bi bi-person-fill-check"></i>
                <span>People in last 12 months</span>
            </div>
            <div class="kpi-card__value">@peopleLastYear</div>
            @if (hasFilters)
            {
                <div class="kpi-card__hint">sum of strength</div>
            }
        </div>
        <div class="kpi-card kpi-card--green">
            <div class="kpi-card__top">
                <i class="bi bi-calendar2"></i>
                <span>Visits in last 30 days</span>
            </div>
            <div class="kpi-card__value">@visitsLast30</div>
        </div>
        <div class="kpi-card kpi-card--amber">
            <div class="kpi-card__top">
                <i class="bi bi-people-fill"></i>
                <span>People in last 30 days</span>
            </div>
            <div class="kpi-card__value">@peopleLast30</div>
        </div>
    </section>

    <!-- charts -->
    <section class="row g-3 mb-3 align-items-stretch">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h3 class="h6 mb-0">Visits &amp; strength – last 12 months</h3>
                            <p class="text-muted small mb-0">Bars show visits, line shows people (strength).</p>
                        </div>
                    </div>
                    <div id="visits-monthly-chart"
                         data-monthly='@System.Text.Json.JsonSerializer.Serialize(monthlyPoints, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase })'
                         class="position-relative" style="min-height: 260px;">
                        <canvas id="visits-monthly-canvas" class="w-100 h-100"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h3 class="h6 mb-0">Visits by type</h3>
                            <p class="text-muted small mb-0">Distribution of visit categories.</p>
                        </div>
                        <select id="visits-type-range" class="form-select form-select-sm w-auto">
                            <option value="lastYear" selected>Last 12 months</option>
                            <option value="all">All time</option>
                        </select>
                    </div>
                    <div id="visits-type-chart"
                         data-types='@System.Text.Json.JsonSerializer.Serialize(allVisitTypes, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase })'
                         class="flex-grow-1" style="min-height: 240px;">
                        <canvas id="visits-type-canvas" class="w-100 h-100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- active filter chips (tiny, inline) -->
    @if (hasFilters)
    {
        <div class="d-flex flex-wrap gap-2 mb-2">
            @if (!string.IsNullOrWhiteSpace(selectedTypeLabel))
            {
                <span class="visit-pill"><i class="bi bi-funnel"></i> @selectedTypeLabel</span>
            }
            @if (parsedFrom.HasValue)
            {
                <span class="visit-pill"><i class="bi bi-calendar-event"></i> From: @parsedFrom.Value.ToString("dd MMM yyyy")</span>
            }
            @if (parsedTo.HasValue)
            {
                <span class="visit-pill"><i class="bi bi-calendar2-event"></i> To: @parsedTo.Value.ToString("dd MMM yyyy")</span>
            }
            @if (!string.IsNullOrWhiteSpace(Model.Q))
            {
                <span class="visit-pill"><i class="bi bi-search"></i> "@Model.Q"</span>
            }
        </div>
    }

    <!-- table -->
    <section>
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h2 class="h6 mb-0">Visit log</h2>
                <p class="text-muted small mb-0">Chronological list of recent visits.</p>
            </div>
            <div class="d-flex align-items-center gap-2">
                @if (!hasFilters && Model.TotalItems > ProjectManagement.Areas.ProjectOfficeReports.Pages.Visits.IndexModel.DashboardRowLimit)
                {
                    <span class="text-muted small">
                        Showing latest @Model.Items.Count of @Model.TotalItems
                    </span>
                    <a asp-page="All" class="btn btn-link btn-sm text-decoration-none">
                        View all
                    </a>
                }
                else if (hasFilters)
                {
                    <span class="text-muted small">@Model.Items.Count item@(Model.Items.Count == 1 ? "" : "s")</span>
                }
            </div>
        </div>

        @if (Model.Items.Count == 0)
        {
            <div class="visit-empty visit-empty--subtle text-center py-5">
                <div class="visit-empty__icon" aria-hidden="true"><i class="bi bi-clipboard2-minus"></i></div>
                <h2 class="visit-empty__title">No visits found</h2>
                <p class="visit-empty__subtitle">
                    @((hasFilters ? "Your filters are too narrow. Try widening the date range or clearing the search." : "Start by recording your first visit."))
                </p>
            </div>
        }
        else
        {
            <div class="card border-0 shadow-sm">
                <div class="table-responsive">
                    <table class="table align-middle mb-0 visit-table">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Date</th>
                                <th scope="col">Visit type</th>
                                <th scope="col">Visitor</th>
                                <th scope="col">Strength</th>
                                <th scope="col">Photos</th>
                                <th scope="col" class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Items)
                            {
                                <tr>
                                    <td>
                                        <div class="fw-semibold">@item.DateOfVisit.ToString("dd MMM yyyy")</div>
                                        <div class="text-muted small">@item.DateOfVisit.ToString("dddd")</div>
                                    </td>
                                    <td>
                                        <div>@item.VisitTypeName</div>
                                        @if (!item.VisitTypeIsActive)
                                        {
                                            <span class="badge bg-warning-subtle text-warning-emphasis mt-1">Type inactive</span>
                                        }
                                    </td>
                                    <td>@item.VisitorName</td>
                                    <td>
                                        <div class="fw-semibold">@item.Strength</div>
                                        <div class="text-muted small">people</div>
                                    </td>
                                    <td>@item.PhotoCount</td>
                                    <td class="text-end">
                                        <div class="btn-group" role="group">
                                            <a asp-page="Details" asp-route-id="@item.Id" class="btn btn-outline-secondary btn-sm">View</a>
                                            @if (Model.CanManage)
                                            {
                                                <a asp-page="Edit" asp-route-id="@item.Id" class="btn btn-outline-primary btn-sm">Edit</a>
                                                <form method="post" asp-page-handler="Delete" class="d-inline" data-visits-disable-on-submit data-confirm="Delete this visit?">
                                                    <input type="hidden" name="id" value="@item.Id" />
                                                    <input type="hidden" name="rowVersion" value="@Convert.ToBase64String(item.RowVersion)" />
                                                    <input type="hidden" name="VisitTypeId" value="@(Model.VisitTypeId.HasValue? Model.VisitTypeId.ToString() : string.Empty)" />
                                                    <input type="hidden" name="From" value="@Model.From" />
                                                    <input type="hidden" name="To" value="@Model.To" />
                                                    <input type="hidden" name="Q" value="@Model.Q" />
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" data-visits-busy-label="Deleting…">Delete</button>
                                                </form>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </section>
</div>

<!-- FILTER MODAL -->
<div class="modal fade" id="visitsFiltersModal" tabindex="-1" aria-labelledby="visitsFiltersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <form method="get">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="visitsFiltersModalLabel">Filter visits</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-3">Refine visits by type, date range, or visitor/remarks text.</p>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label asp-for="VisitTypeId" class="form-label">Visit type</label>
                            <select asp-for="VisitTypeId" asp-items="Model.VisitTypeOptions" class="form-select"></select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" for="from-date-modal">From</label>
                            <input id="from-date-modal" name="From" type="date" value="@(fromValue ?? string.Empty)" class="form-control" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" for="to-date-modal">To</label>
                            <input id="to-date-modal" name="To" type="date" value="@(toValue ?? string.Empty)" class="form-control" />
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="search-modal">Visitor or remarks</label>
                            <input id="search-modal" name="Q" value="@Model.Q" class="form-control" placeholder="Search visitor or remarks" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a asp-page="Index" class="btn btn-link text-decoration-none">Clear</a>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary d-inline-flex align-items-center gap-1">
                        <i class="bi bi-funnel"></i>
                        <span>Apply filters</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- EXPORT MODAL (same as before) -->
<div class="modal fade" id="exportVisitsModal" tabindex="-1" aria-labelledby="exportVisitsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <form method="post" class="needs-validation" novalidate>
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exportVisitsModalLabel">Export visits</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Reuse current filters or narrow them further for this export.</p>
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" for="export-visit-type">Visit type</label>
                            <select id="export-visit-type" name="VisitTypeId" class="form-select">
                                @foreach (var option in Model.VisitTypeOptions)
                                {
                                    <option value="@option.Value" selected="@option.Selected">@option.Text</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="export-search">Visitor or remarks</label>
                            <input id="export-search" name="Q" value="@Model.Q" class="form-control" placeholder="Search visitor or remarks" />
                            <div class="form-text">Leave blank to include everything.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="export-from-date">From</label>
                            <input id="export-from-date" name="From" type="date" value="@(fromValue ?? string.Empty)" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="export-to-date">To</label>
                            <input id="export-to-date" name="To" type="date" value="@(toValue ?? string.Empty)" class="form-control" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-outline-primary d-inline-flex align-items-center gap-2" asp-page-handler="ExportPdf">
                        <i class="bi bi-filetype-pdf"></i>
                        <span>Export PDF</span>
                    </button>
                    <button type="submit" class="btn btn-primary d-inline-flex align-items-center gap-2" asp-page-handler="Export">
                        <i class="bi bi-file-earmark-spreadsheet"></i>
                        <span>Export Excel</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/project-office-reports/visits.css" asp-append-version="true" />
}

@section Scripts {
    <!-- Chart.js already in layout? If not, add this line. If it's already there, remove this line. -->
    <script src="~/lib/chart.js/chart.umd.js"></script>
    <script type="module" src="~/js/pages/project-office-reports/visits.js" asp-append-version="true"></script>
}
