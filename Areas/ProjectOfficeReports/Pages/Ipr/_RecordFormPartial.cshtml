@using System.Globalization
@model ProjectManagement.Areas.ProjectOfficeReports.Pages.Ipr.IndexModel
@{
    var isCreateMode = string.Equals(Model.Mode, "create", StringComparison.OrdinalIgnoreCase);
    var isEditMode = string.Equals(Model.Mode, "edit", StringComparison.OrdinalIgnoreCase);
}

@if (isCreateMode)
{
    <form method="post" asp-page-handler="Create" asp-all-route-data="@Model.GetRouteValuesForLinks(new { mode = "create" }, includeModeAndId: false)" class="row g-3" id="iprCreateForm">
        <div class="col-12 d-flex justify-content-end">
            <a class="btn btn-outline-secondary" asp-page="./Index" asp-all-route-data="@Model.GetRouteValuesForLinks(includeModeAndId: false)">
                Cancel
            </a>
        </div>
        <div class="col-12">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>
        </div>
        <div class="col-12 col-md-6">
            <label asp-for="Input.FilingNumber" class="form-label"></label>
            <input asp-for="Input.FilingNumber" class="form-control" />
            <span asp-validation-for="Input.FilingNumber" class="text-danger"></span>
        </div>
        <div class="col-12 col-md-6">
            <label asp-for="Input.Title" class="form-label"></label>
            <input asp-for="Input.Title" class="form-control" />
            <span asp-validation-for="Input.Title" class="text-danger"></span>
        </div>
        <div class="col-12 col-md-6">
            <label asp-for="Input.FiledBy" class="form-label"></label>
            <input asp-for="Input.FiledBy" class="form-control" />
            <span asp-validation-for="Input.FiledBy" class="text-danger"></span>
        </div>
        <div class="col-12 col-md-4">
            <label asp-for="Input.Type" class="form-label"></label>
            <select asp-for="Input.Type" asp-items="Model.TypeFormOptions" class="form-select" required>
                <option value="" disabled selected="@(Model.Input?.Type is null ? "selected" : null)">Select type</option>
            </select>
            <span asp-validation-for="Input.Type" class="text-danger"></span>
        </div>
        <div class="col-12 col-md-4">
            <label asp-for="Input.Status" class="form-label"></label>
            <select asp-for="Input.Status" asp-items="Model.StatusFormOptions" class="form-select" required>
                <option value="" disabled selected="@(Model.Input?.Status is null ? "selected" : null)">Select status</option>
            </select>
            <span asp-validation-for="Input.Status" class="text-danger"></span>
        </div>
        <div class="col-12 col-md-4">
            <label asp-for="Input.FiledOn" class="form-label"></label>
            <input asp-for="Input.FiledOn" class="form-control" type="date" />
            <span asp-validation-for="Input.FiledOn" class="text-danger"></span>
        </div>
        <div class="col-12 col-md-4">
            <label asp-for="Input.GrantedOn" class="form-label"></label>
            <input asp-for="Input.GrantedOn" class="form-control" type="date" />
            <span asp-validation-for="Input.GrantedOn" class="text-danger"></span>
        </div>
        <div class="col-12 col-md-6">
            <label asp-for="Input.ProjectId" class="form-label"></label>
            <select asp-for="Input.ProjectId" asp-items="Model.ProjectFormOptions" class="form-select"></select>
            <span asp-validation-for="Input.ProjectId" class="text-danger"></span>
        </div>
        <div class="col-12">
            <label asp-for="Input.Notes" class="form-label"></label>
            <textarea asp-for="Input.Notes" class="form-control" rows="4"></textarea>
            <span asp-validation-for="Input.Notes" class="text-danger"></span>
        </div>
        <div class="col-12 d-flex gap-2">
            <button type="submit" class="btn btn-primary">Create record</button>
        </div>
    </form>
}
else if (isEditMode)
{
    <form method="post" asp-page-handler="Edit" asp-all-route-data="@Model.GetRouteValuesForLinks(new { mode = "edit", id = Model.Input.Id }, includeModeAndId: false)" class="row g-3" id="iprEditForm">
        <div class="col-12 d-flex justify-content-end">
            <a class="btn btn-outline-secondary" asp-page="./Index" asp-all-route-data="@Model.GetRouteValuesForLinks(includeModeAndId: false)">
                Cancel
            </a>
        </div>
        <div class="col-12">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>
        </div>
        <input type="hidden" asp-for="Input.Id" />
        <input type="hidden" asp-for="Input.RowVersion" />
        <div class="col-12 col-md-6">
            <label asp-for="Input.FilingNumber" class="form-label"></label>
            <input asp-for="Input.FilingNumber" class="form-control" />
            <span asp-validation-for="Input.FilingNumber" class="text-danger"></span>
        </div>
        <div class="col-12 col-md-6">
            <label asp-for="Input.Title" class="form-label"></label>
            <input asp-for="Input.Title" class="form-control" />
            <span asp-validation-for="Input.Title" class="text-danger"></span>
        </div>
        <div class="col-12 col-md-6">
            <label asp-for="Input.FiledBy" class="form-label"></label>
            <input asp-for="Input.FiledBy" class="form-control" />
            <span asp-validation-for="Input.FiledBy" class="text-danger"></span>
        </div>
        <div class="col-12 col-md-4">
            <label asp-for="Input.Type" class="form-label"></label>
            <select asp-for="Input.Type" asp-items="Model.TypeFormOptions" class="form-select" required>
                <option value="" disabled selected="@(Model.Input?.Type is null ? "selected" : null)">Select type</option>
            </select>
            <span asp-validation-for="Input.Type" class="text-danger"></span>
        </div>
        <div class="col-12 col-md-4">
            <label asp-for="Input.Status" class="form-label"></label>
            <select asp-for="Input.Status" asp-items="Model.StatusFormOptions" class="form-select" required>
                <option value="" disabled selected="@(Model.Input?.Status is null ? "selected" : null)">Select status</option>
            </select>
            <span asp-validation-for="Input.Status" class="text-danger"></span>
        </div>
        <div class="col-12 col-md-4">
            <label asp-for="Input.FiledOn" class="form-label"></label>
            <input asp-for="Input.FiledOn" class="form-control" type="date" />
            <span asp-validation-for="Input.FiledOn" class="text-danger"></span>
        </div>
        <div class="col-12 col-md-4">
            <label asp-for="Input.GrantedOn" class="form-label"></label>
            <input asp-for="Input.GrantedOn" class="form-control" type="date" />
            <span asp-validation-for="Input.GrantedOn" class="text-danger"></span>
        </div>
        <div class="col-12 col-md-6">
            <label asp-for="Input.ProjectId" class="form-label"></label>
            <select asp-for="Input.ProjectId" asp-items="Model.ProjectFormOptions" class="form-select"></select>
            <span asp-validation-for="Input.ProjectId" class="text-danger"></span>
        </div>
        <div class="col-12">
            <label asp-for="Input.Notes" class="form-label"></label>
            <textarea asp-for="Input.Notes" class="form-control" rows="4"></textarea>
            <span asp-validation-for="Input.Notes" class="text-danger"></span>
        </div>
        <div class="col-12 d-flex gap-2">
            <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
    </form>

    <hr class="my-4" />

    <section aria-label="IPR attachments">
        <header class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h3 class="h6 mb-1">Attachments</h3>
                <p class="text-muted mb-0">Upload supporting documents or remove outdated files.</p>
            </div>
        </header>

        <div class="mb-4">
            @if (Model.Attachments.Count == 0)
            {
                <p class="text-muted mb-0">No attachments yet.</p>
            }
            else
            {
                <ul class="list-group">
                    @foreach (var attachment in Model.Attachments)
                    {
                        <li class="list-group-item d-flex flex-column flex-md-row align-items-md-center gap-2">
                            <div class="flex-fill">
                                <div class="fw-semibold">
                                    <a asp-page="Download" asp-route-iprRecordId="@Model.Input.Id" asp-route-attachmentId="@attachment.Id" target="_blank" rel="noopener noreferrer">
                                        @attachment.FileName
                                    </a>
                                </div>
                                <div class="text-muted small">
                                    @Model.FormatFileSize(attachment.FileSize)
                                    &middot; Uploaded by @attachment.UploadedBy on @FormatAttachmentTimestamp(attachment.UploadedAtUtc)
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <form method="post" asp-page-handler="RemoveAttachment" asp-all-route-data="@Model.GetRouteValuesForLinks(new { mode = "edit", id = Model.Input.Id }, includeModeAndId: false)">
                                    <input type="hidden" name="RemoveAttachment.AttachmentId" value="@attachment.Id" />
                                    <input type="hidden" name="RemoveAttachment.RecordId" value="@Model.Input.Id" />
                                    <input type="hidden" name="RemoveAttachment.RowVersion" value="@attachment.RowVersion" />
                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                        <i class="bi bi-trash" aria-hidden="true"></i>
                                        <span class="visually-hidden">Remove attachment</span>
                                    </button>
                                </form>
                            </div>
                        </li>
                    }
                </ul>
            }
        </div>

        <form method="post" asp-page-handler="Attach" asp-all-route-data="@Model.GetRouteValuesForLinks(new { mode = "edit", id = Model.Input.Id }, includeModeAndId: false)" enctype="multipart/form-data" class="row g-3 align-items-end" novalidate id="iprAttachmentForm">
            <input type="hidden" asp-for="UploadInput.RecordId" />
            <div class="col-12 col-md-8">
                <label asp-for="UploadInput.File" class="form-label">Add attachment</label>
                <input asp-for="UploadInput.File" class="form-control" type="file" />
                <span asp-validation-for="UploadInput.File" class="text-danger"></span>
            </div>
            <div class="col-12 col-md-4">
                <button type="submit" class="btn btn-outline-primary w-100">Upload</button>
            </div>
        </form>

        <form method="post" asp-page-handler="Delete" asp-all-route-data="@Model.GetRouteValuesForLinks(includeModeAndId: false)" class="mt-4" id="iprDeleteForm" data-ipr-confirm="This will permanently delete the IPR record and its attachments. Continue?">
            <input type="hidden" asp-for="DeleteRequest.Id" />
            <input type="hidden" asp-for="DeleteRequest.RowVersion" />
            <button type="submit" class="btn btn-outline-danger">
                Delete record
            </button>
        </form>
    </section>
}
else
{
    <div class="text-muted small">
        Select "Add IPR record" or "Manage" to begin.
    </div>
}

@functions {
    private static string FormatAttachmentTimestamp(DateTimeOffset value)
    {
        var istZone = ProjectManagement.Utilities.TimeZoneHelper.GetIst();
        var converted = TimeZoneInfo.ConvertTimeFromUtc(value.UtcDateTime, istZone);
        return converted.ToString("dd MMM yyyy 'at' HH:mm 'IST'", CultureInfo.InvariantCulture);
    }
}
