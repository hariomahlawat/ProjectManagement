@page
@model ProjectManagement.Areas.ProjectOfficeReports.Pages.Training.RecordsModel
@using System.Globalization
@{
    ViewData["Title"] = "Training records";
    ViewData["UseFullWidth"] = true;

    var activeFilters = 0;
    if (Model.Filter.TypeId.HasValue && Model.Filter.TypeId.Value != Guid.Empty) activeFilters++;
    if (Model.Filter.ProjectTechnicalCategoryId.HasValue) activeFilters++;
    if (Model.Filter.Category.HasValue) activeFilters++;
    if (Model.Filter.From.HasValue || Model.Filter.To.HasValue) activeFilters++;
    if (!string.IsNullOrWhiteSpace(Model.Filter.Search)) activeFilters++;

    var totalPages = (int)Math.Ceiling(Model.TotalCount / (double)Model.PageSize);
}

<!-- ============================================================
     BREADCRUMB
     ============================================================ -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb mb-0 small">
        <li class="breadcrumb-item"><a asp-area="" asp-page="/Dashboard/Index">Dashboard</a></li>
        <li class="breadcrumb-item">
            <a asp-area="ProjectOfficeReports" asp-page="/Training/Index">Training tracker</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            Training records
        </li>
    </ol>
</nav>

<!-- ============================================================
     PAGE HEADER
     ============================================================ -->
<div class="card shadow-sm border-0 mb-4">
    <div class="card-body d-flex flex-column flex-lg-row gap-3 align-items-start align-items-lg-center justify-content-between">
        <div>
            <h1 class="h4 mb-2">Training records</h1>
            <p class="text-muted mb-0">Full list of training entries matching your filters.</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button"
                    class="btn btn-outline-secondary d-inline-flex align-items-center gap-2"
                    data-bs-toggle="modal"
                    data-bs-target="#trainingFiltersModal">
                <i class="bi bi-funnel"></i>
                <span>Filters</span>
                @if (activeFilters > 0)
                {
                    <span class="badge bg-primary-subtle text-primary">@activeFilters</span>
                }
            </button>
            <a asp-page="./Index" class="btn btn-light d-inline-flex align-items-center gap-2">
                <i class="bi bi-arrow-left"></i>
                <span>Back to tracker</span>
            </a>
        </div>
    </div>
</div>

<!-- ============================================================
     TABLE
     ============================================================ -->
@if (!Model.HasResults)
{
    <div class="card shadow-sm border-0">
        <div class="card-body py-5 text-center text-muted">
            No trainings found for the selected filters.
        </div>
    </div>
}
else
{
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Training type</th>
                            <th>Period</th>
                            <th>Source</th>
                            <th>Total</th>
                            <th>Strength</th>
                            <th>Projects</th>
                            <th>Notes / Remarks</th>
                            @if (Model.CanManageTrainingTracker)
                            {
                                <th class="text-end">Actions</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var training in Model.Trainings)
                        {
                            var extraProjects = training.ProjectNames.Count > 2 ? training.ProjectNames.Count - 2 : 0;
                            <tr>
                                <td>
                                    <div class="fw-semibold">@training.TrainingTypeName</div>
                                </td>
                                <td class="text-muted small">
                                    @training.Period
                                    @if (!string.IsNullOrWhiteSpace(training.PeriodDayCount))
                                    {
                                        <text> (@training.PeriodDayCount)</text>
                                    }
                                </td>
                                <td>
                                    @if (training.Source == ProjectManagement.Areas.ProjectOfficeReports.Domain.TrainingCounterSource.Legacy)
                                    {
                                        <span class="badge bg-secondary">Legacy</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-info text-dark">Roster</span>
                                    }
                                </td>
                                <td class="fw-semibold">@training.Total.ToString("N0", CultureInfo.CurrentCulture)</td>
                                <td>
                                    <span class="badge bg-light text-dark fw-normal">@training.Strength</span>
                                </td>
                                <td style="min-width: 180px;">
                                    @if (training.ProjectNames.Count == 0)
                                    {
                                        <span class="text-muted">None linked</span>
                                    }
                                    else
                                    {
                                        <ul class="list-unstyled mb-0 small text-truncate-2">
                                            @foreach (var project in training.ProjectNames.Take(2))
                                            {
                                                <li>@project</li>
                                            }
                                        </ul>
                                        @if (extraProjects > 0)
                                        {
                                            <div class="small text-secondary">+ @extraProjects more</div>
                                        }
                                    }
                                </td>
                                <td class="small text-truncate" style="max-width: 200px;">
                                    @if (string.IsNullOrWhiteSpace(training.Notes))
                                    {
                                        <span class="text-muted">None</span>
                                    }
                                    else
                                    {
                                        @training.Notes
                                    }
                                </td>
                                @if (Model.CanManageTrainingTracker)
                                {
                                    <td class="text-end">
                                        <a asp-page="./Manage" asp-route-id="@training.Id" class="btn btn-sm btn-outline-primary">Manage</a>
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- pagination -->
        <div class="card-footer d-flex justify-content-between align-items-center gap-3 flex-wrap">
            <span class="text-muted small">
                Showing page @Model.PageNumber of @totalPages.
                Total records: @Model.TotalCount.
            </span>
            <div class="d-flex gap-2">
                @if (Model.PageNumber > 1)
                {
                    <a asp-page="./Records"
                       asp-route-TypeId="@(Model.Filter.TypeId)"
                       asp-route-ProjectTechnicalCategoryId="@(Model.Filter.ProjectTechnicalCategoryId)"
                       asp-route-Category="@(Model.Filter.Category)"
                       asp-route-From="@(Model.Filter.From?.ToString("yyyy-MM-dd"))"
                       asp-route-To="@(Model.Filter.To?.ToString("yyyy-MM-dd"))"
                       asp-route-Search="@(Model.Filter.Search)"
                       asp-route-PageNumber="@(Model.PageNumber - 1)"
                       class="btn btn-outline-secondary btn-sm">Previous</a>
                }
                @if (Model.PageNumber < totalPages)
                {
                    <a asp-page="./Records"
                       asp-route-TypeId="@(Model.Filter.TypeId)"
                       asp-route-ProjectTechnicalCategoryId="@(Model.Filter.ProjectTechnicalCategoryId)"
                       asp-route-Category="@(Model.Filter.Category)"
                       asp-route-From="@(Model.Filter.From?.ToString("yyyy-MM-dd"))"
                       asp-route-To="@(Model.Filter.To?.ToString("yyyy-MM-dd"))"
                       asp-route-Search="@(Model.Filter.Search)"
                       asp-route-PageNumber="@(Model.PageNumber + 1)"
                       class="btn btn-outline-secondary btn-sm">Next</a>
                }
            </div>
        </div>
    </div>
}

<!-- ============================================================
     FILTERS MODAL (same fields as dashboard)
     ============================================================ -->
<div class="modal fade"
     id="trainingFiltersModal"
     tabindex="-1"
     aria-labelledby="trainingFiltersModalLabel"
     aria-hidden="true"
     data-bs-focus="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg modal-fullscreen-sm-down">
        <div class="modal-content">
            <form method="get" class="w-100">
                <div class="modal-header">
                    <h2 class="modal-title h5" id="trainingFiltersModalLabel">Filters</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-lg-4">
                            <label asp-for="Filter.TypeId" class="form-label small text-uppercase text-secondary fw-semibold"></label>
                            <select asp-for="Filter.TypeId" asp-items="Model.TrainingTypes" class="form-select"></select>
                        </div>
                        <div class="col-lg-4">
                            <label asp-for="Filter.ProjectTechnicalCategoryId" class="form-label small text-uppercase text-secondary fw-semibold"></label>
                            <select asp-for="Filter.ProjectTechnicalCategoryId" asp-items="Model.ProjectTechnicalCategoryOptions" class="form-select"></select>
                        </div>
                        <div class="col-lg-4">
                            <label asp-for="Filter.Category" class="form-label small text-uppercase text-secondary fw-semibold"></label>
                            <select asp-for="Filter.Category" asp-items="Model.CategoryOptions" class="form-select"></select>
                        </div>
                        <div class="col-md-3">
                            <label asp-for="Filter.From" class="form-label small text-uppercase text-secondary fw-semibold"></label>
                            <input asp-for="Filter.From" class="form-control" />
                        </div>
                        <div class="col-md-3">
                            <label asp-for="Filter.To" class="form-label small text-uppercase text-secondary fw-semibold"></label>
                            <input asp-for="Filter.To" class="form-control" />
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <label asp-for="Filter.Search" class="form-label small text-uppercase text-secondary fw-semibold"></label>
                            <input asp-for="Filter.Search" class="form-control" placeholder="Search notes or projects" />
                        </div>
                        <input type="hidden" name="PageNumber" value="1" />
                    </div>
                </div>
                <div class="modal-footer gap-2 justify-content-between">
                    <a asp-page="./Records" class="btn btn-link btn-sm px-0">Reset filters</a>
                    <button type="submit" class="btn btn-primary btn-sm">Apply filters</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Styles
{
    <style>
        .text-truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
}
