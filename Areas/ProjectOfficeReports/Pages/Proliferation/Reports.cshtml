@page
@model ProjectManagement.Areas.ProjectOfficeReports.Pages.Proliferation.ReportsModel
@{
    ViewData["Title"] = "Proliferation reports";
}

<div class="container-fluid mt-3"
     data-page="proliferation-reports"
     data-can-manage-records="@(Model.CanManageRecords ? "true" : "false")">
    <!-- SECTION: Header -->
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <div class="text-muted small">
                <a asp-area="" asp-page="/Index">Dashboard</a> /
                <a asp-area="ProjectOfficeReports" asp-page="/Proliferation/Summary">Proliferation tracker</a> /
                Reports
            </div>
            <h2 class="mb-0">Proliferation reports</h2>
            <div class="text-muted">Generate unit-wise and project-wise reports from granular proliferation data.</div>
        </div>
        <div class="d-flex gap-2">
            @if (Model.CanManageRecords)
            {
                <!-- SECTION: Manage -->
                <a class="btn btn-outline-primary" asp-area="ProjectOfficeReports" asp-page="/Proliferation/Manage">Manage proliferation</a>
            }
            <a class="btn btn-outline-secondary" asp-area="ProjectOfficeReports" asp-page="/Proliferation/Summary">Back to summary</a>
        </div>
    </div>

    <!-- SECTION: Filters -->
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Report</label>
                    <select class="form-select" id="rep-kind">
                        <option value="ProjectToUnits">Project to units (detail)</option>
                        <option value="UnitToProjects">Unit to projects (detail)</option>
                        <option value="ProjectCoverageSummary">Project coverage summary</option>
                        <option value="GranularLedger">Granular ledger</option>
                        <option value="YearlyReconciliation">Yearly reconciliation</option>
                    </select>
                </div>

                <div class="col-md-3 position-relative" id="rep-project-wrap">
                    <label class="form-label">Project</label>
                    <input class="form-control" id="rep-project" placeholder="Search project name or code" autocomplete="off" />
                    <div class="list-group position-absolute w-100 d-none" id="rep-project-suggest" style="z-index: 2000;"></div>
                </div>

                <div class="col-md-3 d-none" id="rep-unit-wrap">
                    <label class="form-label">Unit</label>
                    <input class="form-control" id="rep-unit" placeholder="Type unit name" list="rep-unit-list" />
                    <datalist id="rep-unit-list"></datalist>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Project category</label>
                    <select class="form-select" id="rep-project-category">
                        <option value="">All categories</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Technical category</label>
                    <select class="form-select" id="rep-technical-category">
                        <option value="">All categories</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Source</label>
                    <select class="form-select" id="rep-source">
                        <option value="">All sources</option>
                        <option value="1">SDD</option>
                        <option value="2">515 ABW</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Approval status</label>
                    <select class="form-select" id="rep-status">
                        <option value="Approved" selected>Approved</option>
                        <option value="All">All</option>
                        <option value="Pending">Pending</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">From date</label>
                    <input class="form-control" type="date" id="rep-from" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">To date</label>
                    <input class="form-control" type="date" id="rep-to" />
                </div>

                <div class="col-md-2">
                    <label class="form-label">Page size</label>
                    <select class="form-select" id="rep-pagesize">
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                    </select>
                </div>

                <div class="col-md-4 d-flex flex-wrap gap-2">
                    <button class="btn btn-primary" id="rep-run">Run report</button>
                    <button class="btn btn-outline-success" id="rep-export" disabled>Export Excel</button>
                    <button class="btn btn-outline-secondary" id="rep-columns"
                            data-bs-toggle="modal"
                            data-bs-target="#rep-columns-modal">
                        Columns
                    </button>
                </div>

                <!-- SECTION: Presets -->
                <div class="col-md-4">
                    <label class="form-label">Presets</label>
                    <div class="d-flex gap-2">
                        <select class="form-select" id="rep-presets"></select>
                        <button class="btn btn-outline-secondary" id="rep-preset-load" disabled>Load</button>
                    </div>
                </div>

                <div class="col-md-4 d-flex flex-wrap gap-2 align-items-end">
                    <button class="btn btn-outline-primary" id="rep-preset-save"
                            data-bs-toggle="modal"
                            data-bs-target="#rep-preset-modal">
                        Save preset
                    </button>
                    <button class="btn btn-outline-danger" id="rep-preset-delete" disabled>Delete</button>
                </div>
            </div>

            <div class="mt-2 text-muted small" id="rep-hint"></div>

            <!-- SECTION: Context + Chips -->
            <div class="mt-3">
                <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
                    <div class="text-muted small" id="reportContext">Not run yet.</div>
                    <button class="btn btn-outline-secondary btn-sm" id="rep-clear">Clear filters</button>
                </div>
                <div class="d-flex flex-wrap gap-2 mt-2" id="reportChips"></div>
            </div>
        </div>
    </div>

    <!-- SECTION: Results -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="text-muted" id="rep-count">No data loaded.</div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="rep-prev" disabled>Prev</button>
                    <button class="btn btn-outline-secondary btn-sm" id="rep-next" disabled>Next</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-sm table-hover align-middle" id="rep-table">
                    <thead><tr id="rep-head"></tr></thead>
                    <tbody id="rep-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- SECTION: Column chooser modal -->
<div class="modal fade" id="rep-columns-modal" tabindex="-1" aria-labelledby="rep-columns-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fs-5" id="rep-columns-modal-label">Choose columns</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-muted small mb-2">Select the columns you want to see for this report.</div>
                <div class="row g-2" id="rep-columns-list"></div>
                <div class="text-danger small mt-2 d-none" id="rep-columns-warning">Select at least one column.</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="rep-columns-reset">Reset to default</button>
                <button type="button" class="btn btn-primary" id="rep-columns-apply">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- SECTION: Preset modal -->
<div class="modal fade" id="rep-preset-modal" tabindex="-1" aria-labelledby="rep-preset-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fs-5" id="rep-preset-modal-label">Save preset</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label class="form-label" for="rep-preset-name">Preset name</label>
                <input class="form-control" id="rep-preset-name" placeholder="Example: Approved SDD last 12 months" />
                <div class="text-muted small mt-2" id="rep-preset-help">Saved presets are stored in this browser only.</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="rep-preset-save-confirm">Save preset</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/pages/proliferation-reports.js" asp-append-version="true"></script>
}
