@page
@model ProjectManagement.Areas.ProjectOfficeReports.Pages.Proliferation.SummaryModel
@using System
@using System.Collections.Generic
@using System.Linq
@using ProjectManagement.Areas.ProjectOfficeReports.Proliferation.ViewModels
@using System.Text.Json
@{ 
    ViewData["Title"] = "Proliferation Dashboard";
}

<div class="container-xxl my-4" data-page="proliferation-summary">
    <nav aria-label="Breadcrumb" class="visit-breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a asp-area="" asp-page="/Dashboard/Index">Dashboard</a></li>
            <li class="breadcrumb-item"><a asp-area="ProjectOfficeReports" asp-page="/Proliferation/Index">Proliferation tracker</a></li>
            <li class="breadcrumb-item active" aria-current="page">Proliferation dashboard</li>
        </ol>
    </nav>

    <h1 class="h3 mb-3">Proliferation summary</h1>
    <p class="text-muted">@Model.Lede</p>

    <section class="prol-card">
        <h2 class="h5 prol-heading">Totals</h2>
        <dl class="totals-dl">
            <div class="totals-dl__item">
                <dt>Projects</dt>
                <dd class="prol-total">@Model.ProjectsTotal.ToString("N0")</dd>
            </div>
            <div class="totals-dl__item">
                <dt>Years</dt>
                <dd class="prol-total">@Model.YearsTotal.ToString("N0")</dd>
            </div>
            <div class="totals-dl__item">
                <dt>Proliferations</dt>
                <dd class="prol-total">@Model.GrandTotal.ToString("N0")</dd>
            </div>
            <div class="totals-dl__item">
                <dt>515 ABW totals</dt>
                <dd class="prol-total">@Model.GrandAbw.ToString("N0")</dd>
            </div>
            <div class="totals-dl__item">
                <dt>SDD totals</dt>
                <dd class="prol-total">@Model.GrandSdd.ToString("N0")</dd>
            </div>
        </dl>
    </section>

    <section class="mt-6">
        <h2 class="text-lg font-semibold mb-3">Yearly proliferation trend</h2>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4">
            <p class="text-sm text-slate-500 mb-4">
                Bars show SDD vs 515 ABW for every year. Line shows total proliferations for that year.
            </p>

            <!-- we don’t put any script here: only data for JS -->
            <div id="proliferation-yearly-chart"
                 data-yearly='@JsonSerializer.Serialize(Model.Summary.ByYear, new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase })'
                 class="w-full overflow-x-auto">


                <canvas id="proliferation-yearly-chart-canvas" class="min-w-[520px] h-72"></canvas>
            </div>
        </div>
    </section>

    <div class="prol-grid">
        <section class="prol-card">
            <h2 class="h5 prol-heading">Projects ranked by proliferations</h2>
            @{
                var projectsByTotals = Model.Summary.ByProject
                    .OrderByDescending(row => row.Totals.Total)
                    .ThenBy(row => row.ProjectName, StringComparer.OrdinalIgnoreCase)
                    .ToList();
            }
            <ol class="prol-ol">
                @foreach (var project in projectsByTotals)
                {
                    <li class="prol-row">
                        <div class="prol-name">
                            <span class="prol-heading">
                                <a asp-page="/Projects/Overview" asp-route-id="@project.ProjectId">
                                    @project.ProjectName
                                </a>
                                @if (!string.IsNullOrWhiteSpace(project.ProjectCode))
                                {
                                    <span class="prol-code">(@project.ProjectCode)</span>
                                }
                            </span>
                            <span class="prol-meta">515 ABW: @project.Totals.Abw515.ToString("N0") · SDD: @project.Totals.Sdd.ToString("N0")</span>
                        </div>
                        <span class="prol-badge">@project.Totals.Total.ToString("N0")</span>
                    </li>
                }
                @if (projectsByTotals.Count == 0)
                {
                    <li class="prol-meta">None</li>
                }
            </ol>
        </section>

        @{
            var yearSummaries = Model.Summary.ByYear
                .ToDictionary(row => row.Year, row => row);
            var projectGroups = Model.Summary.ByProjectYear
                .GroupBy(row => row.Year)
                .ToDictionary(
                    group => group.Key,
                    group => group
                        .OrderByDescending(row => row.Totals.Total)
                        .ThenBy(row => row.ProjectName, StringComparer.OrdinalIgnoreCase)
                        .ToList());
            var allYears = yearSummaries.Keys
                .Concat(projectGroups.Keys)
                .Distinct()
                .OrderByDescending(year => year)
                .ToList();
        }

        <section class="prol-card">
            <div class="prol-yr__header">
                <h2 class="h5 prol-heading">Project breakdown by year</h2>
                @if (allYears.Count > 0)
                {
                    <div class="prol-yr__actions">
                        <a asp-route-expand="true">Expand all</a>
                        <span aria-hidden="true" class="prol-yr__divider">/</span>
                        <a asp-route-expand="false" asp-route-open="">Collapse all</a>
                    </div>
                }
            </div>

            <ul class="prol-yr__list list-unstyled mb-0">
                @foreach (var year in allYears)
                {
                    var hasSummary = yearSummaries.TryGetValue(year, out var yearRow);
                    var projects = projectGroups.TryGetValue(year, out var breakdown)
                        ? breakdown
                        : new List<ProliferationSummaryProjectYearRow>();
                    var yearTotal = hasSummary
                        ? yearRow!.Totals.Total
                        : projects.Sum(row => row.Totals.Total);
                    var yearAbw = hasSummary
                        ? yearRow!.Totals.Abw515
                        : projects.Sum(row => row.Totals.Abw515);
                    var yearSdd = hasSummary
                        ? yearRow!.Totals.Sdd
                        : projects.Sum(row => row.Totals.Sdd);
                    var isOpen = Model.OpenYears.Contains(year);

                    <li>
                        <details class="prol-yr" @(isOpen ? "open" : "")>
                            <summary class="prol-yr__summary">
                                <span class="prol-yr__title">@year</span>
                                <span class="prol-yr__totals">
                                    <span class="prol-yr__total">@yearTotal.ToString("N0") total</span>
                                    <span class="prol-yr__meta">515 ABW: @yearAbw.ToString("N0") · SDD: @yearSdd.ToString("N0")</span>
                                </span>
                            </summary>

                            <ol class="prol-ol prol-yr__list">
                                @foreach (var project in projects)
                                {
                                    <li class="prol-row">
                                        <div class="prol-name">
                                            <span class="prol-heading">
                                                <a asp-page="/Projects/Overview" asp-route-id="@project.ProjectId">
                                                    @project.ProjectName
                                                </a>
                                                @if (!string.IsNullOrWhiteSpace(project.ProjectCode))
                                                {
                                                    <span class="prol-code">(@project.ProjectCode)</span>
                                                }
                                            </span>
                                            <span class="prol-meta">515 ABW: @project.Totals.Abw515.ToString("N0") · SDD: @project.Totals.Sdd.ToString("N0")</span>
                                        </div>
                                        <span class="prol-badge">@project.Totals.Total.ToString("N0")</span>
                                    </li>
                                }
                                @if (projects.Count == 0)
                                {
                                    <li class="prol-meta">None</li>
                                }
                            </ol>
                        </details>
                    </li>
                }
                @if (allYears.Count == 0)
                {
                    <li class="prol-meta">None</li>
                }
            </ul>
        </section>
    </div>
</div>

@section Scripts {
    <!-- Chart.js already in layout? If not, add this line. If it's already there, remove this line. -->
    <script src="~/lib/chart.js/chart.umd.js"></script>

    <script src="~/js/proliferation-summary-charts.js"></script>
}