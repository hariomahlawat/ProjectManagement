@page
@model ProjectManagement.Areas.ProjectOfficeReports.Pages.Proliferation.SummaryModel
@using System.Text.Json
@using System.Linq
@{
    ViewData["Title"] = "Proliferation dashboard";

    // Ensure yearly data for the chart is ordered from oldest to newest
    var yearlyOrdered = Model.Summary.ByYear
        .OrderBy(row => row.Year)
        .ToList();
}

<div class="container-xxl py-3" data-page="proliferation-summary">
    <!-- breadcrumb -->
    <nav aria-label="Breadcrumb" class="mb-2">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a asp-area="" asp-page="/Dashboard/Index">Dashboard</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                Proliferation tracker
            </li>
        </ol>
    </nav>

    <!-- header -->
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
        <div>
            <h1 class="h3 mb-1">Proliferation summary</h1>
            <p class="text-muted mb-0">@Model.Lede</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <!-- SECTION: Reports navigation -->
            <a asp-area="ProjectOfficeReports"
               asp-page="/Proliferation/Reports"
               class="btn btn-outline-primary d-inline-flex align-items-center gap-1">
                <i class="bi bi-clipboard-data" aria-hidden="true"></i>
                <span>Reports</span>
            </a>
            <a asp-area="ProjectOfficeReports"
               asp-page="/Proliferation/Index"
               class="btn btn-outline-secondary d-inline-flex align-items-center gap-1">
                <i class="bi bi-table" aria-hidden="true"></i>
                <span>View records</span>
            </a>
            <a asp-area="ProjectOfficeReports"
               asp-page="/Proliferation/Manage"
               class="btn btn-primary d-inline-flex align-items-center gap-1">
                <i class="bi bi-gear" aria-hidden="true"></i>
                <span>Manage records</span>
            </a>
        </div>
    </div>

    <!-- totals -->
    <section class="prol-card mb-4">
        <dl class="totals-dl">
            <div class="totals-dl__item">
                <dt>Projects</dt>
                <dd class="prol-total">@Model.ProjectsTotal.ToString("N0")</dd>
            </div>
            <div class="totals-dl__item">
                <dt>Years</dt>
                <dd class="prol-total">@Model.YearsTotal.ToString("N0")</dd>
            </div>
            <div class="totals-dl__item">
                <dt>Proliferations</dt>
                <dd class="prol-total">@Model.GrandTotal.ToString("N0")</dd>
            </div>
            <div class="totals-dl__item">
                <dt>515 ABW totals</dt>
                <dd class="prol-total">@Model.GrandAbw.ToString("N0")</dd>
            </div>
            <div class="totals-dl__item">
                <dt>SDD totals</dt>
                <dd class="prol-total">@Model.GrandSdd.ToString("N0")</dd>
            </div>
        </dl>
    </section>

    <!-- chart: yearly trend -->
    <section class="mb-4">
        <div class="bg-white rounded-3 shadow-sm border p-4">
            <div class="d-flex justify-content-between align-items-start mb-3 gap-3">
                <div>
                    <h2 class="h6 mb-1">Yearly proliferation trend</h2>
                    <p class="text-muted small mb-0">
                        Bars show SDD vs 515 ABW for every year. Line shows total proliferations for that year.
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button"
                            class="btn btn-light btn-sm"
                            data-action="download-png"
                            data-target="proliferation-yearly-chart-canvas"
                            title="Download chart"
                            aria-label="Download chart as PNG">
                        <i class="bi bi-download" aria-hidden="true"></i>
                    </button>
                </div>
            </div>

            <div id="proliferation-yearly-chart"
                 data-yearly='@JsonSerializer.Serialize(yearlyOrdered, new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase })'>
                <div class="ratio ratio-21x9">
                    <canvas id="proliferation-yearly-chart-canvas"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- chart: by technical category -->
    <section class="mb-4">
        <div class="bg-white rounded-3 shadow-sm border p-4">
            <div class="d-flex justify-content-between align-items-start mb-3 gap-3">
                <div>
                    <h2 class="h6 mb-1">Proliferations by technical category</h2>
                    <p class="text-muted small mb-0">
                        Sorted by highest proliferation count. Only categories that have projects in this summary are shown.
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button"
                            class="btn btn-light btn-sm"
                            data-action="download-png"
                            data-target="proliferation-techcat-chart-canvas"
                            title="Download chart"
                            aria-label="Download chart as PNG">
                        <i class="bi bi-download" aria-hidden="true"></i>
                    </button>
                </div>
            </div>

            <div id="proliferation-techcat-chart"
                 data-categories='@JsonSerializer.Serialize(Model.TechnicalCategoryBreakdown, new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase })'>
                <div class="ratio pm-util-aspect-60">
                    <canvas id="proliferation-techcat-chart-canvas"></canvas>
                </div>
            </div>
        </div>
    </section>

    @{
        // pre-compute for lower cards
        var projectsByTotals = Model.Summary.ByProject
        .OrderByDescending(row => row.Totals.Total)
        .ThenBy(row => row.ProjectName, StringComparer.OrdinalIgnoreCase)
        .ToList();
        var topProjects = projectsByTotals.Take(10).ToList();
        var hasMoreProjects = projectsByTotals.Count > topProjects.Count;

        var yearSummaries = Model.Summary.ByYear.ToDictionary(row => row.Year, row => row);

        var projectGroups = Model.Summary.ByProjectYear
        .GroupBy(row => row.Year)
        .ToDictionary(
        group => group.Key,
        group => group
        .OrderByDescending(row => row.Totals.Total)
        .ThenBy(row => row.ProjectName, StringComparer.OrdinalIgnoreCase)
        .ToList()
        );

        var allYears = yearSummaries.Keys
        .Concat(projectGroups.Keys)
        .Distinct()
        .OrderByDescending(year => year)
        .ToList();
    }

    <!-- two-column layout -->
    <div class="row g-4 mb-4">
        <!-- left: projects ranked -->
        <div class="col-lg-5">
            <section class="prol-card h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h5 prol-heading mb-0">Projects ranked by proliferations</h2>
                    <div class="d-flex gap-2">
                        <!-- export as Excel -->
                        <a asp-area="ProjectOfficeReports"
                           asp-page="/Proliferation/Summary"
                           asp-page-handler="ExportProjects"
                           class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center justify-content-center"
                           title="Export ranked projects to Excel"
                           aria-label="Export ranked projects to Excel">
                            <i class="bi bi-download"></i>
                        </a>
                        @if (hasMoreProjects)
                        {
                            <a asp-area="ProjectOfficeReports"
                               asp-page="/Proliferation/Index"
                               class="small text-decoration-none align-self-center">View all</a>
                        }
                    </div>
                </div>
                <ol class="prol-ol mb-0">
                    @foreach (var project in topProjects)
                    {
                        <li class="prol-row">
                            <div class="prol-name">
                                <span class="prol-heading">
                                    <a asp-page="/Projects/Overview" asp-route-id="@project.ProjectId">
                                        @project.ProjectName
                                    </a>
                                    @if (!string.IsNullOrWhiteSpace(project.ProjectCode))
                                    {
                                        <span class="prol-code">(@project.ProjectCode)</span>
                                    }
                                </span>
                                <span class="prol-meta">
                                    515 ABW: @project.Totals.Abw515.ToString("N0") ·
                                    SDD: @project.Totals.Sdd.ToString("N0")
                                </span>
                            </div>
                            <span class="prol-badge">@project.Totals.Total.ToString("N0")</span>
                        </li>
                    }
                    @if (topProjects.Count == 0)
                    {
                        <li class="prol-meta">No projects in the current view.</li>
                    }
                </ol>
            </section>
        </div>

        <!-- right: breakdown by year -->
        <div class="col-lg-7">
            <section class="prol-card h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h5 prol-heading mb-0">Project breakdown by year</h2>
                    <div class="d-flex gap-2 align-items-center">
                        <!-- export as Excel -->
                        <a asp-area="ProjectOfficeReports"
                           asp-page="/Proliferation/Summary"
                           asp-page-handler="ExportYearBreakdown"
                           class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center justify-content-center"
                           title="Export yearly breakdown to Excel"
                           aria-label="Export yearly breakdown to Excel">
                            <i class="bi bi-download"></i>
                        </a>

                        @if (allYears.Count > 0)
                        {
                            <div class="prol-yr__actions small d-flex gap-2">
                                <button type="button" class="btn btn-link btn-sm p-0" data-prol-action="expand-all">
                                    Expand all
                                </button>
                                <span aria-hidden="true" class="text-muted">/</span>
                                <button type="button" class="btn btn-link btn-sm p-0" data-prol-action="collapse-all">
                                    Collapse all
                                </button>
                            </div>
                        }
                    </div>
                </div>

                <ul class="list-unstyled mb-0" data-prol-year-list>
                    @foreach (var year in allYears)
                    {
                        var hasSummary = yearSummaries.TryGetValue(year, out var yearRow);
                        var projects = projectGroups.TryGetValue(year, out var breakdown)
                        ? breakdown
                        : new List<ProjectManagement.Areas.ProjectOfficeReports.Proliferation.ViewModels.ProliferationSummaryProjectYearRow>();

                        var yearTotal = hasSummary ? yearRow!.Totals.Total : projects.Sum(row => row.Totals.Total);
                        var yearAbw = hasSummary ? yearRow!.Totals.Abw515 : projects.Sum(row => row.Totals.Abw515);
                        var yearSdd = hasSummary ? yearRow!.Totals.Sdd : projects.Sum(row => row.Totals.Sdd);
                        var isOpen = Model.OpenYears.Contains(year);

                        <li class="mb-2">
                            <details class="prol-yr" @(isOpen ? "open" : "")>
                                <summary class="prol-yr__summary">
                                    <span class="prol-yr__title">@year</span>
                                    <span class="prol-yr__totals">
                                        <span class="prol-yr__total">@yearTotal.ToString("N0") total</span>
                                        <span class="prol-yr__meta">
                                            515 ABW: @yearAbw.ToString("N0") · SDD: @yearSdd.ToString("N0")
                                        </span>
                                    </span>
                                </summary>

                                <ol class="prol-ol prol-yr__list mb-2">
                                    @foreach (var project in projects)
                                    {
                                        <li class="prol-row">
                                            <div class="prol-name">
                                                <span class="prol-heading">
                                                    <a asp-page="/Projects/Overview" asp-route-id="@project.ProjectId">
                                                        @project.ProjectName
                                                    </a>
                                                    @if (!string.IsNullOrWhiteSpace(project.ProjectCode))
                                                    {
                                                        <span class="prol-code">(@project.ProjectCode)</span>
                                                    }
                                                </span>
                                                <span class="prol-meta">
                                                    515 ABW: @project.Totals.Abw515.ToString("N0") ·
                                                    SDD: @project.Totals.Sdd.ToString("N0")
                                                </span>
                                            </div>
                                            <span class="prol-badge">@project.Totals.Total.ToString("N0")</span>
                                        </li>
                                    }
                                    @if (projects.Count == 0)
                                    {
                                        <li class="prol-meta">No projects for this year.</li>
                                    }
                                </ol>
                            </details>
                        </li>
                    }
                    @if (allYears.Count == 0)
                    {
                        <li class="prol-meta">No yearly data available.</li>
                    }
                </ul>
            </section>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/chart.js/chart.umd.js"></script>
    <script src="~/js/pages/project-office-reports/proliferation-summary-charts.js" asp-append-version="true"></script>
}
