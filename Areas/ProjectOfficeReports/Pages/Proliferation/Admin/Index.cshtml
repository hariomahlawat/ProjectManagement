@page
@model ProjectManagement.Areas.ProjectOfficeReports.Pages.Proliferation.Admin.IndexModel
@{
    ViewData["Title"] = "Proliferation data administration";
    string? toast = TempData["ToastMessage"] as string;
    string? toastWarning = TempData["ToastWarning"] as string;
    string? toastError = TempData["ToastError"] as string;
    var hasRejection = Model.PendingRejectionDownload is not null;
    const int importPipelines = 2;
    const int exportFilters = 6;
}

@section Styles {
    <link rel="stylesheet" href="~/css/project-office-reports/proliferation-management.css" asp-append-version="true" />
}

<section class="pro-shell container-xxl">
    <header class="pro-hero pro-hero--admin">
        <div class="pro-hero__content">
            <span class="pro-hero__eyebrow">Proliferation operations</span>
            <h1 class="pro-hero__title">Proliferation data administration</h1>
            <p class="pro-hero__subtitle">
                Upload yearly and granular source feeds, monitor rejection files, and generate tracker exports for offline analysis.
            </p>
        </div>
        <dl class="pro-hero__stats">
            <div class="pro-hero__stat">
                <dt class="pro-hero__stat-label">Import pipelines</dt>
                <dd class="pro-hero__stat-value">@importPipelines</dd>
            </div>
            <div class="pro-hero__stat">
                <dt class="pro-hero__stat-label">Rejection files ready</dt>
                <dd class="pro-hero__stat-value">@(hasRejection ? "1" : "0")</dd>
            </div>
            <div class="pro-hero__stat">
                <dt class="pro-hero__stat-label">Export filters</dt>
                <dd class="pro-hero__stat-value">@exportFilters</dd>
            </div>
        </dl>
    </header>

    <section class="pro-section">
        @if (!string.IsNullOrWhiteSpace(toast))
        {
            <div class="alert alert-success" role="status">@toast</div>
        }

        @if (!string.IsNullOrWhiteSpace(toastWarning))
        {
            <div class="alert alert-warning" role="status">@toastWarning</div>
        }

        @if (!string.IsNullOrWhiteSpace(toastError))
        {
            <div class="alert alert-danger" role="status">@toastError</div>
        }

        @if (Model.PendingRejectionDownload is not null)
        {
            <div class="alert alert-info d-flex flex-wrap justify-content-between align-items-center gap-2" role="status">
                <span>Some rows were rejected during the last import. Download the rejection report to review the errors.</span>
                <a class="btn btn-outline-primary"
                   asp-page-handler="DownloadRejection"
                   asp-route-token="@Model.PendingRejectionDownload.Token">
                    Download @Model.PendingRejectionDownload.FileName
                </a>
            </div>
        }
    </section>

    <section class="pro-section">
        <div class="row g-4">
            <div class="col-12 col-lg-6">
                <div class="card pro-card pro-card--form h-100">
                    <div class="card-header pro-card__header">
                        <h2 class="h5 mb-0">Import yearly totals</h2>
                    </div>
                    <div class="card-body pro-card__body">
                        <p class="text-muted mb-0">
                            Upload CSV files from SDD or 515 ABW systems. Files must include ProjectId, Year, DirectBeneficiaries,
                            IndirectBeneficiaries, InvestmentValue, and optional Notes columns.
                        </p>
                        <form method="post" enctype="multipart/form-data" asp-page-handler="ImportYearly" class="pro-form mt-3">
                            <div>
                                <label class="form-label" for="yearly-source">Source</label>
                                <select class="form-select" asp-for="Yearly.Source" id="yearly-source">
                                    <option value="@ProjectManagement.Areas.ProjectOfficeReports.Domain.ProliferationSource.Sdd">SDD</option>
                                    <option value="@ProjectManagement.Areas.ProjectOfficeReports.Domain.ProliferationSource.Abw515">515 ABW</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label" asp-for="Yearly.File">Upload CSV file</label>
                                <input class="form-control" asp-for="Yearly.File" type="file" accept=".csv" />
                                <span class="text-danger" asp-validation-for="Yearly.File"></span>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">Import yearly data</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="card pro-card pro-card--form h-100">
                    <div class="card-header pro-card__header">
                        <h2 class="h5 mb-0">Import granular metrics (SDD)</h2>
                    </div>
                    <div class="card-body pro-card__body">
                        <p class="text-muted mb-0">
                            Upload monthly or quarterly totals from SDD. Files must include ProjectId, Year, Granularity, Period, and optional metric columns.
                        </p>
                        <form method="post" enctype="multipart/form-data" asp-page-handler="ImportGranular" class="pro-form mt-3">
                            <div>
                                <label class="form-label" asp-for="Granular.File">Upload CSV file</label>
                                <input class="form-control" asp-for="Granular.File" type="file" accept=".csv" />
                                <span class="text-danger" asp-validation-for="Granular.File"></span>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">Import granular data</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card pro-card pro-card--form">
                    <div class="card-header pro-card__header">
                        <h2 class="h5 mb-0">Download tracker export</h2>
                    </div>
                    <div class="card-body pro-card__body">
                        <p class="text-muted mb-0">
                            Generate an Excel workbook summarising yearly, granular, effective, and variance metrics for the selected filters.
                        </p>
                        <form method="post" asp-page-handler="Export" class="pro-form mt-3">
                            <div class="row g-3">
                                <div class="col-12 col-md-4">
                                    <label class="form-label" asp-for="Export.Source">Source</label>
                                    <select class="form-select" asp-for="Export.Source">
                                        <option value="">All sources</option>
                                        <option value="@ProjectManagement.Areas.ProjectOfficeReports.Domain.ProliferationSource.Sdd">SDD</option>
                                        <option value="@ProjectManagement.Areas.ProjectOfficeReports.Domain.ProliferationSource.Abw515">515 ABW</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-4">
                                    <label class="form-label" asp-for="Export.YearFrom">Year from</label>
                                    <input class="form-control" asp-for="Export.YearFrom" type="number" min="2000" max="9999" />
                                </div>
                                <div class="col-12 col-md-4">
                                    <label class="form-label" asp-for="Export.YearTo">Year to</label>
                                    <input class="form-control" asp-for="Export.YearTo" type="number" min="2000" max="9999" />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label" asp-for="Export.SponsoringUnitId">Sponsoring unit ID</label>
                                    <input class="form-control" asp-for="Export.SponsoringUnitId" type="number" min="1" />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label" asp-for="Export.SimulatorUserId">Simulator user ID</label>
                                    <input class="form-control" asp-for="Export.SimulatorUserId" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label" asp-for="Export.SearchTerm">Project search</label>
                                    <input class="form-control" asp-for="Export.SearchTerm" placeholder="Search by project or unit" />
                                </div>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-success">Download export</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
