@page
@model ProjectManagement.Areas.ProjectOfficeReports.Pages.FFC.Records.Projects.ManageModel
@{
    ViewData["Title"] = "FFC Projects";
}

<section class="pm-page">
    <header class="pm-page-header">
        <div>
            <span class="pm-pill">FFC records</span>
            <h1 class="pm-page-title">Projects for @Model.Record.Country.Name (@Model.Record.Year)</h1>
            <p class="pm-page-subtitle">Coordinate simulator delivery workstreams by linking internal projects and capturing context for each relationship.</p>
        </div>
        <div class="pm-page-actions">
            <a asp-page="../Manage" asp-route-editId="@Model.Record.Id" class="pm-button pm-button-ghost">
                <i class="bi bi-arrow-left" aria-hidden="true"></i>
                Back to record
            </a>
        </div>
    </header>

    <partial name="~/Areas/ProjectOfficeReports/Pages/Shared/_StatusMessage.cshtml" />

    <div class="pm-split">
        <div class="pm-table-card">
            <div class="pm-table-scroll">
                <table class="pm-data-table">
                    <thead>
                        <tr><th>Name</th><th>Linked project</th><th>Remarks</th><th class="text-end">Actions</th></tr>
                    </thead>
                    <tbody>
                    @if (!Model.Items.Any())
                    {
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">No projects linked yet.</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var p in Model.Items)
                        {
                            <tr>
                                <td class="fw-semibold">@p.Name</td>
                                <td>@(p.LinkedProject?.Name ?? "— none —")</td>
                                <td>@(string.IsNullOrWhiteSpace(p.Remarks) ? "—" : p.Remarks)</td>
                                <td class="text-end">
                                    <div class="d-inline-flex flex-wrap justify-content-end gap-1">
                                        <authorize roles="Admin,HoD">
                                            <a asp-page="./Manage" asp-route-recordId="@Model.Record.Id" asp-route-id="@p.Id" class="pm-button pm-button-ghost pm-button-sm">Edit</a>
                                        </authorize>
                                        @if (!(User.IsInRole("Admin") || User.IsInRole("HoD")))
                                        {
                                            <span class="text-muted small">Read only</span>
                                        }
                                        <authorize roles="Admin,HoD">
                                            <form method="post" asp-page-handler="Delete" asp-route-recordId="@Model.Record.Id" asp-route-id="@p.Id" class="d-inline">
                                                <button class="pm-button pm-button-secondary pm-button-sm" type="submit">Delete</button>
                                            </form>
                                        </authorize>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    </tbody>
                </table>
            </div>
        </div>

        <authorize roles="Admin,HoD">
            <div class="pm-form-card">
                <div class="pm-card-header">@(Model.Input.Id.HasValue ? "Edit project" : "Add project")</div>
                <div class="pm-card-body">
                    <form method="post" class="pm-form">
                        @if (Model.Input.Id.HasValue)
                        {
                            <input type="hidden" asp-for="Input.Id" />
                            <button type="submit" asp-page-handler="Update" asp-route-recordId="@Model.Record.Id" class="d-none"></button>
                        }
                        <div class="pm-form-field">
                            <label asp-for="Input.Name" class="form-label">Name</label>
                            <input asp-for="Input.Name" class="form-control" />
                            <span asp-validation-for="Input.Name" class="text-danger"></span>
                        </div>
                        <div class="pm-form-field">
                            <label asp-for="Input.LinkedProjectId" class="form-label">Link to project (optional)</label>
                            <select asp-for="Input.LinkedProjectId" class="form-select" asp-items="Model.LinkedProjects">
                                <option value="">-- none --</option>
                            </select>
                        </div>
                        <div class="pm-form-field">
                            <label asp-for="Input.Remarks" class="form-label">Remarks</label>
                            <input asp-for="Input.Remarks" class="form-control" placeholder="Context or handover notes" />
                        </div>

                        <div class="pm-form-footer">
                            @if (Model.Input.Id.HasValue)
                            {
                                <button type="submit" asp-page-handler="Update" asp-route-recordId="@Model.Record.Id" class="pm-button pm-button-primary">Save changes</button>
                                <a asp-page="./Manage" asp-route-recordId="@Model.Record.Id" class="pm-button pm-button-ghost">Cancel</a>
                            }
                            else
                            {
                                <button type="submit" asp-page-handler="Create" asp-route-recordId="@Model.Record.Id" class="pm-button pm-button-primary">Add project</button>
                            }
                        </div>
                    </form>
                </div>
            </div>
        </authorize>
    </div>
</section>
