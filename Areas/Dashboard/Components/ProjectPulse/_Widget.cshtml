@model ProjectManagement.Areas.Dashboard.Components.ProjectPulse.ProjectPulseVm
@using System
@using System.Collections.Generic
@using System.Linq
@using System.Text.Json
@using ProjectManagement.Areas.Dashboard.Components.ProjectPulse

@* SECTION: Serialization helpers *@
@{
    var jsonOptions = new JsonSerializerOptions(JsonSerializerDefaults.Web);
    string Serialize<T>(IReadOnlyList<T> source) => JsonSerializer.Serialize(source, jsonOptions);

    string DescribeCategories(string heading, IReadOnlyList<CategorySlice> slices)
    {
        if (slices.Count == 0)
        {
            return $"{heading} data is not available";
        }

        var details = string.Join(", ", slices.Select(slice => $"{slice.Label} {slice.Count}"));
        return $"{heading}: {details}";
    }

    IReadOnlyList<CategorySlice> AsSlices(IEnumerable<TreemapNode> nodes)
    {
        return nodes.Select(node => new CategorySlice(node.Label, node.Count)).ToList();
    }

    string SerializeObject<T>(T source) => JsonSerializer.Serialize(source, jsonOptions);
}
@* END SECTION *@

<section class="ppulse dashboard-project-pulse-card" data-project-pulse>
  @* SECTION: Header *@
  <div class="ppulse__head">
    <div class="ppulse__title">
            <img src="~/img/logos/sdd.png" class="pm-powered-by__logo" alt="SDD logo" />
      <span class="ppulse__pulse" aria-hidden="true">
        <i class="bi bi-activity" aria-hidden="true"></i>
      </span>
      <h2 class="ppulse__h">Project pulse</h2>
    </div>
    <div class="ppulse__actions" role="group" aria-label="Project pulse actions">
      <span
        class="ppulse__pill"
        role="button"
        tabindex="0"
        title="Projects eligible for proliferation"
        aria-label="Projects available for proliferation"
      >
        Available for proliferation <strong>@Model.ProliferationEligible</strong>
      </span>
      <a
        class="btn btn-primary btn-sm ppulse__analytics"
        href="@Model.AnalyticsUrl"
        aria-label="Open analytics dashboard"
        title="Open analytics dashboard"
      >
        Open analytics
      </a>
    </div>
  </div>
  @* END SECTION *@

  @* SECTION: Content cards *@
  <div class="ppulse__grid">
    <article class="ppulse__card pulse-item-card">
      <div class="ppulse__link">
        @* SECTION: Ongoing header *@
        <header class="ppulse__card-head">
          <h3>Ongoing <small>@Model.OngoingCount</small></h3>
        </header>
        @* END SECTION *@

        @* SECTION: Ongoing content *@
        @if (Model.OngoingCount == 0)
        {
          <div class="ppulse__empty">No ongoing projects</div>
        }
        else
        {
          var stageLabels = Model.OngoingStageDistributionTotal.Items
              .Select(item => item.StageCode)
              .ToList();
          var stackedSeries = Model.OngoingStageDistributionByCategory
              .Select(category =>
              {
                  var stageMap = category.StageDistribution.Items
                      .GroupBy(item => item.StageCode, StringComparer.OrdinalIgnoreCase)
                      .ToDictionary(group => group.Key, group => group.Sum(item => item.Count), StringComparer.OrdinalIgnoreCase);
                  var aligned = stageLabels
                      .Select(label => stageMap.TryGetValue(label, out var value) ? value : 0)
                      .ToList();
                  return new
                  {
                      label = category.Label,
                      data = aligned
                  };
              })
              .ToList();
          var stackedPayload = new
          {
              labels = stageLabels,
              series = stackedSeries
          };
          var stackedPayloadJson = SerializeObject(stackedPayload);
          var ongoingBucketsJson = SerializeObject(Model.OngoingBucketsByKey);

          <div class="ppulse__ongoing-grid">
            <div class="ppulse__ongoing-panel">
              @if (Model.OngoingByProjectCategory.Count == 0)
              {
                <div class="ppulse__empty">No category data available</div>
              }
              else
              {
                <div
                  class="ppulse__chart ppulse__chart--compact"
                  data-chart="donut"
                  data-series='@Html.Raw(Serialize(Model.OngoingByProjectCategory))'
                  role="img"
                  aria-label='@DescribeCategories("Ongoing projects by category", Model.OngoingByProjectCategory)'
                >
                  <canvas aria-hidden="true"></canvas>
                </div>
              }
            </div>

            <div class="ppulse__ongoing-panel">
              @if (stageLabels.Count == 0 || stackedSeries.Count == 0)
              {
                <div class="ppulse__empty">No stage data available</div>
              }
              else
              {
                <div
                  class="ppulse__chart ppulse__chart--stacked"
                  data-chart="stacked-bar"
                  data-chart-json='@Html.Raw(stackedPayloadJson)'
                  role="img"
                  aria-label="Ongoing projects by stage with category breakdown"
                >
                  <canvas aria-hidden="true"></canvas>
                </div>
              }
            </div>
          </div>

          <div
            class="ppulse__ongoing-buckets"
            data-ppulse-ongoing-buckets
            data-default-key="total"
            data-buckets-json='@Html.Raw(ongoingBucketsJson)'
          >
            <div class="ppulse__bucket-head">
              <span class="ppulse__bucket-title">Buckets</span>
              <div class="ppulse__bucket-filters" role="tablist" aria-label="Ongoing bucket filters">
                @foreach (var filter in Model.OngoingBucketFilters)
                {
                  var isActive = filter.Key == "total";
                  <button
                    type="button"
                    class="ppulse__bucket-filter@(isActive ? " is-active" : string.Empty)"
                    data-bucket-key="@filter.Key"
                    role="tab"
                    aria-selected="@(isActive ? "true" : "false")"
                  >
                    @filter.Label
                  </button>
                }
              </div>
            </div>

            <div class="ppulse__bucket-bar" role="list">
              <div class="ppulse__bucket-seg ppulse__bucket-seg--apvl" data-bucket="apvl" role="listitem">
                <span>Apvl</span>
                <strong data-bucket-value>0</strong>
              </div>
              <div class="ppulse__bucket-seg ppulse__bucket-seg--aon" data-bucket="aon" role="listitem">
                <span>AoN</span>
                <strong data-bucket-value>0</strong>
              </div>
              <div class="ppulse__bucket-seg ppulse__bucket-seg--tender" data-bucket="tender" role="listitem">
                <span>Tender</span>
                <strong data-bucket-value>0</strong>
              </div>
              <div class="ppulse__bucket-seg ppulse__bucket-seg--devp" data-bucket="devp" role="listitem">
                <span>Devp</span>
                <strong data-bucket-value>0</strong>
              </div>
              <div class="ppulse__bucket-seg ppulse__bucket-seg--other" data-bucket="other" role="listitem">
                <span>Other</span>
                <strong data-bucket-value>0</strong>
              </div>
            </div>
          </div>
        }
        @* END SECTION *@

        @* SECTION: Ongoing footer *@
        <footer class="ppulse__foot">
          <a class="ppulse__inline-link" href="@Model.OngoingUrl">View ongoing →</a>
        </footer>
        @* END SECTION *@
      </div>
    </article>

    <article class="ppulse__card pulse-item-card ppulse__card--completed">
      <div class="ppulse__link">
        @{
            var techSeriesJson = Html.Raw(Serialize(Model.UniqueCompletedByTechnicalCategory));
            var typeSeriesJson = Html.Raw(Serialize(Model.UniqueCompletedByProjectType));

            var techCount = Model.UniqueCompletedByTechnicalCategory.Count;
            var typeCount = Model.UniqueCompletedByProjectType.Count;

            var tabSuffix = Guid.NewGuid().ToString("N");
            var techTabId = $"ppulse-completed-tab-tech-{tabSuffix}";
            var typeTabId = $"ppulse-completed-tab-type-{tabSuffix}";
            var techPanelId = $"ppulse-completed-panel-tech-{tabSuffix}";
            var typePanelId = $"ppulse-completed-panel-type-{tabSuffix}";
        }

        <div class="ppulse__completed" data-ppulse-tabs="completed">
          @* SECTION: Completed header with tabs *@
          <header class="ppulse__card-head ppulse__completed-head">
            <div class="ppulse__completed-title">
              <h3>Completed <small>@Model.CompletedCount</small></h3>

              <span
                class="ppulse__info"
                title="Excludes archived and deleted"
                aria-label="Excludes archived and deleted"
              >
                <i class="bi bi-info-circle" aria-hidden="true"></i>
              </span>
            </div>

            <div class="ppulse__completed-tabs">
              <div class="ppulse__tablist" role="tablist" aria-label="Completed treemap views">
                <button
                  type="button"
                  class="ppulse__tab"
                  role="tab"
                  id="@techTabId"
                  aria-controls="@techPanelId"
                  aria-selected="true"
                  tabindex="0"
                  data-tab="tech"
                >
                  Technical category
                </button>

                <button
                  type="button"
                  class="ppulse__tab"
                  role="tab"
                  id="@typeTabId"
                  aria-controls="@typePanelId"
                  aria-selected="false"
                  tabindex="-1"
                  data-tab="type"
                >
                  Project type
                </button>
              </div>
            </div>
          </header>
          @* END SECTION *@

          @* SECTION: Compact 2-column body (KPI left 20%, Treemap right) *@
          <div class="ppulse__completed-main">
            <div class="ppulse__completed-kpis" role="group" aria-label="Completed projects breakdown">
              <div class="ppulse__kpi-row">
                <span class="ppulse__kpi-row-label">Unique</span>
                <strong class="ppulse__kpi-row-value">@Model.CompletedUniqueCount</strong>
              </div>

              <div class="ppulse__kpi-row">
                <span class="ppulse__kpi-row-label">Rebuild</span>
                <strong class="ppulse__kpi-row-value">@Model.CompletedRebuildCount</strong>
              </div>
            </div>

            <div class="ppulse__completed-panels">
              <div
                class="ppulse__tabpanel ppulse__tabpanel--compact"
                role="tabpanel"
                id="@techPanelId"
                aria-labelledby="@techTabId"
                data-panel="tech"
              >
                @if (techCount == 0)
                {
                  <div class="ppulse__empty ppulse__empty--compact">No data available</div>
                }
                else
                {
                  <div
                    class="ppulse__chart ppulse__treemap"
                    data-chart="treemap"
                    data-series='@techSeriesJson'
                    role="img"
                    aria-label='@DescribeCategories("Unique completed by technical category", AsSlices(Model.UniqueCompletedByTechnicalCategory))'
                  >
                  </div>
                }
              </div>

              <div
                class="ppulse__tabpanel ppulse__tabpanel--compact"
                role="tabpanel"
                id="@typePanelId"
                aria-labelledby="@typeTabId"
                data-panel="type"
                hidden
              >
                @if (typeCount == 0)
                {
                  <div class="ppulse__empty ppulse__empty--compact">No data available</div>
                }
                else
                {
                  <div
                    class="ppulse__chart ppulse__treemap"
                    data-chart="treemap"
                    data-series='@typeSeriesJson'
                    role="img"
                    aria-label='@DescribeCategories("Unique completed by project type", AsSlices(Model.UniqueCompletedByProjectType))'
                  >
                  </div>
                }
              </div>
            </div>
          </div>
          @* END SECTION *@

          @* SECTION: Footer *@
          <footer class="ppulse__foot">
            <a class="ppulse__inline-link" href="@Model.CompletedUrl">View completed →</a>
          </footer>
          @* END SECTION *@
        </div>
      </div>
    </article>
  </div>
  @* END SECTION *@
</section>
