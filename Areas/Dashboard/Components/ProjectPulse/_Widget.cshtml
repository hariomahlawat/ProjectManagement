@model ProjectManagement.Areas.Dashboard.Components.ProjectPulse.ProjectPulseVm
@using System
@using System.Collections.Generic
@using System.Globalization
@using System.Linq
@using System.Text.Json
@using ProjectManagement.Areas.Dashboard.Components.ProjectPulse
@using ProjectManagement.Services.Analytics

@* SECTION: Serialization helpers *@
@{
    var jsonOptions = new JsonSerializerOptions(JsonSerializerDefaults.Web);
    Dictionary<string, int> BuildStageMap(StageDistributionResult distribution)
    {
        return distribution.Items
            .GroupBy(item => item.StageCode ?? string.Empty, StringComparer.OrdinalIgnoreCase)
            .Where(group => !string.IsNullOrWhiteSpace(group.Key))
            .ToDictionary(
                group => group.Key,
                group => group.Sum(item => item.Count),
                StringComparer.OrdinalIgnoreCase);
    }

    string SerializeObject<T>(T source) => JsonSerializer.Serialize(source, jsonOptions);
}
@* END SECTION *@

<section class="ppulse dashboard-project-pulse-card" data-project-pulse>
  @* SECTION: Header *@
  <div class="ppulse__head">
    <div class="ppulse__title">
            <img src="~/img/logos/sdd.png" class="pm-powered-by__logo" alt="SDD logo" />
      <span class="ppulse__pulse" aria-hidden="true">
        <i class="bi bi-activity" aria-hidden="true"></i>
      </span>
      <h2 class="ppulse__h">Project pulse</h2>
    </div>
    <div class="ppulse__actions" role="group" aria-label="Project pulse actions">
      <a
        class="ppulse__pill ppulse__pill--link"
        href="@Model.ProliferationEligibleUrl"
        title="View projects available for proliferation"
      >
        Available for proliferation <strong>@Model.ProliferationEligible</strong>
      </a>
      <a
        class="btn btn-primary btn-sm ppulse__analytics"
        href="@Model.AnalyticsUrl"
        aria-label="Open analytics dashboard"
        title="Open analytics dashboard"
      >
        Open analytics
      </a>
    </div>
  </div>
  @* END SECTION *@

  @* SECTION: Content cards *@
  <div class="ppulse__grid">
    @* SECTION: Ongoing defaults *@
    @{
        var defaultOngoingKey = Model.OngoingBucketFilters.FirstOrDefault()?.Key ?? "total";
        var ongoingBucketsJson = SerializeObject(Model.OngoingBucketsByKey);
    }
    @* END SECTION *@

    <article
      class="ppulse__card pulse-item-card ppulse__ongoing"
      data-ppulse-ongoing-buckets
      data-default-key="@defaultOngoingKey"
      data-buckets-json='@Html.Raw(ongoingBucketsJson)'
    >
      <div class="ppulse__link">
        @* SECTION: Ongoing header *@
        <header class="ppulse__card-head ppulse__ongoing-head">
          <h3 class="ppulse__card-title">
            <a
              class="ppulse__title-link"
              href="@Model.OngoingUrl"
              title="Open ongoing projects"
            >
              <span>Ongoing</span>
              <small>@Model.OngoingCount</small>
            </a>
          </h3>
          @* SECTION: Ongoing category filters *@
          <div class="ppulse__ongoing-head-filters">
            @if (Model.OngoingBucketFilters.Count == 0)
            {
              <span class="ppulse__subtle">No category data available</span>
            }
            else
            {
              <div class="ppulse__bucket-filters" role="tablist" aria-label="Category distribution">
                @foreach (var filter in Model.OngoingBucketFilters)
                {
                  var isActive = filter.Key == defaultOngoingKey;
                  <button
                    type="button"
                    class="ppulse__bucket-filter@(isActive ? " is-active" : string.Empty)"
                    data-bucket-key="@filter.Key"
                    role="tab"
                    aria-selected="@(isActive ? "true" : "false")"
                  >
                    <span class="ppulse__bucket-filter-label">@filter.Label</span>
                    <span class="ppulse__bucket-filter-count">@filter.Count</span>
                  </button>
                }
              </div>
            }
          </div>
          @* END SECTION *@
        </header>
        @* END SECTION *@

        @* SECTION: Ongoing content *@
        @if (Model.OngoingCount == 0)
        {
          <div class="ppulse__empty">No ongoing projects</div>
        }
        else
        {
          var stageOrder = new List<string>();
          var stageOrderSet = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

          void AppendStageOrder(StageDistributionResult distribution)
          {
              foreach (var item in distribution.Items)
              {
                  var code = item.StageCode ?? string.Empty;
                  if (string.IsNullOrWhiteSpace(code))
                  {
                      continue;
                  }

                  if (stageOrderSet.Add(code))
                  {
                      stageOrder.Add(code);
                  }
              }
          }

          AppendStageOrder(Model.OngoingStageDistributionTotal);

          var stageDistributionByKey = new Dictionary<string, IReadOnlyDictionary<string, int>>(StringComparer.OrdinalIgnoreCase)
          {
              ["total"] = BuildStageMap(Model.OngoingStageDistributionTotal)
          };

          foreach (var category in Model.OngoingStageDistributionByCategory)
          {
              AppendStageOrder(category.StageDistribution);
              stageDistributionByKey[$"cat-{category.ParentCategoryId}"] = BuildStageMap(category.StageDistribution);
          }

          var stageOrderJson = SerializeObject(stageOrder);
          var stageDistributionJson = SerializeObject(stageDistributionByKey);

          <div class="ppulse__ongoing-buckets">

            @* SECTION: Bucket bar *@
            <div class="ppulse__bucket-head">
              <span class="ppulse__bucket-title">Buckets</span>
            </div>

            <div class="ppulse__bucket-bar" role="list">
              <div class="ppulse__bucket-seg ppulse__bucket-seg--apvl" data-ppulse-bucket-seg="apvl" role="listitem">
                <span class="ppulse__bucket-seg-label">Apvl</span>
                <span class="ppulse__bucket-seg-metrics">
                  <strong class="ppulse__bucket-seg-value" data-ppulse-bucket-seg-value>0</strong>
                  <span class="ppulse__bucket-seg-percent" data-ppulse-bucket-seg-percent>0%</span>
                </span>
              </div>
              <div class="ppulse__bucket-seg ppulse__bucket-seg--aon" data-ppulse-bucket-seg="aon" role="listitem">
                <span class="ppulse__bucket-seg-label">AoN</span>
                <span class="ppulse__bucket-seg-metrics">
                  <strong class="ppulse__bucket-seg-value" data-ppulse-bucket-seg-value>0</strong>
                  <span class="ppulse__bucket-seg-percent" data-ppulse-bucket-seg-percent>0%</span>
                </span>
              </div>
              <div class="ppulse__bucket-seg ppulse__bucket-seg--tender" data-ppulse-bucket-seg="tender" role="listitem">
                <span class="ppulse__bucket-seg-label">Tender</span>
                <span class="ppulse__bucket-seg-metrics">
                  <strong class="ppulse__bucket-seg-value" data-ppulse-bucket-seg-value>0</strong>
                  <span class="ppulse__bucket-seg-percent" data-ppulse-bucket-seg-percent>0%</span>
                </span>
              </div>
              <div class="ppulse__bucket-seg ppulse__bucket-seg--devp" data-ppulse-bucket-seg="devp" role="listitem">
                <span class="ppulse__bucket-seg-label">Devp</span>
                <span class="ppulse__bucket-seg-metrics">
                  <strong class="ppulse__bucket-seg-value" data-ppulse-bucket-seg-value>0</strong>
                  <span class="ppulse__bucket-seg-percent" data-ppulse-bucket-seg-percent>0%</span>
                </span>
              </div>
            </div>
            @* END SECTION *@

            @* SECTION: Stage distribution *@
            <div class="ppulse__summary-block ppulse__summary-block--stage">
              <p class="ppulse__summary-title">Stage distribution</p>
              <div
                class="ppulse__stage-pills ppulse__stage-pills--below"
                data-ppulse-stage-pills
                data-default-key="total"
                data-stage-order='@Html.Raw(stageOrderJson)'
                data-stage-json='@Html.Raw(stageDistributionJson)'
              >
                <div class="ppulse__stage-pill-row ppulse__stage-pill-list" role="list" data-stage-row></div>
                <div class="ppulse__empty ppulse__empty--compact ppulse__stage-empty" data-stage-empty hidden>
                  No stage data available
                </div>
              </div>
            </div>
            @* END SECTION *@
          </div>
        }
        @* END SECTION *@

        @* SECTION: Ongoing footer *@
        <footer class="ppulse__foot">
          <a class="ppulse__inline-link" href="@Model.OngoingUrl">View ongoing →</a>
        </footer>
        @* END SECTION *@
      </div>
    </article>

    <article class="ppulse__card pulse-item-card ppulse__card--completed">
      <div class="ppulse__link">
        @{
            var techCount = Model.UniqueCompletedByTechnicalCategory.Count;
            var typeCount = Model.UniqueCompletedByProjectType.Count;

            var tabSuffix = Guid.NewGuid().ToString("N");
            var techTabId = $"ppulse-completed-tab-tech-{tabSuffix}";
            var typeTabId = $"ppulse-completed-tab-type-{tabSuffix}";
            var techPanelId = $"ppulse-completed-panel-tech-{tabSuffix}";
            var typePanelId = $"ppulse-completed-panel-type-{tabSuffix}";
        }

        <div class="ppulse__completed" data-ppulse-tabs="completed">
          @* SECTION: Completed header with tabs *@
          <header class="ppulse__card-head ppulse__completed-head">
            <div class="ppulse__completed-title">
              <h3>Completed <small>@Model.CompletedCount</small></h3>

              <span
                class="ppulse__info"
                title="Excludes archived and deleted"
                aria-label="Excludes archived and deleted"
              >
                <i class="bi bi-info-circle" aria-hidden="true"></i>
              </span>
            </div>

            <div class="ppulse__completed-tabs">
              <div class="ppulse__tablist" role="tablist" aria-label="Completed breakdown views">
                <button
                  type="button"
                  class="ppulse__tab"
                  role="tab"
                  id="@techTabId"
                  aria-controls="@techPanelId"
                  aria-selected="true"
                  tabindex="0"
                  data-tab="tech"
                >
                  Technical category
                </button>

                <button
                  type="button"
                  class="ppulse__tab"
                  role="tab"
                  id="@typeTabId"
                  aria-controls="@typePanelId"
                  aria-selected="false"
                  tabindex="-1"
                  data-tab="type"
                >
                  Project type
                </button>
              </div>
            </div>
          </header>
          @* END SECTION *@

          @* SECTION: Compact 2-column body (KPI left 20%, Treemap right) *@
          <div class="ppulse__completed-main">
            <div class="ppulse__completed-kpis" role="group" aria-label="Completed projects breakdown">
              <div class="ppulse__kpi-row">
                <span class="ppulse__kpi-row-label">Unique</span>
                <strong class="ppulse__kpi-row-value">@Model.CompletedUniqueCount</strong>
              </div>

              <div class="ppulse__kpi-row">
                <span class="ppulse__kpi-row-label">Rebuild</span>
                <strong class="ppulse__kpi-row-value">@Model.CompletedRebuildCount</strong>
              </div>
            </div>

            <div class="ppulse__completed-panels">
              <div
                class="ppulse__tabpanel ppulse__tabpanel--compact"
                role="tabpanel"
                id="@techPanelId"
                aria-labelledby="@techTabId"
                data-panel="tech"
              >
                @* SECTION: Completed bar list (technical category) *@
                @{
                    var techSeries = Model.UniqueCompletedByTechnicalCategory ?? new List<TreemapNode>();
                    var techTotal = techSeries.Sum(item => item.Count);
                    var techMax = techSeries.Count > 0 ? techSeries.Max(item => item.Count) : 0;
                }

                <div class="ppulse__barlist-wrap">
                  @if (techCount == 0)
                  {
                    <div class="ppulse__empty ppulse__empty--compact">No data available</div>
                  }
                  else
                  {
                    <div class="ppulse__barlist" role="list" aria-label="Completed projects breakdown by technical category">
                      @foreach (var item in techSeries)
                      {
                        var pctOfMax = techMax > 0 ? (item.Count * 100.0 / techMax) : 0;
                        var pctOfTotal = techTotal > 0 ? (item.Count * 100.0 / techTotal) : 0;
                        var pctLabel = Math.Round(pctOfTotal);
                        var pctWidth = pctOfMax.ToString("0.##", CultureInfo.InvariantCulture);

                        <div
                          class="ppulse__barrow"
                          role="listitem"
                          title="@item.Label (@item.Count, @pctLabel%)"
                          aria-label="@item.Label: @item.Count projects, @pctLabel%"
                        >
                          <div class="ppulse__barlabel">@item.Label</div>

                          <div class="ppulse__bartrack">
                            <div class="ppulse__barfill" style="width:@pctWidth%"></div>
                          </div>

                          <div class="ppulse__barvalue">
                            <span class="ppulse__barcount">@item.Count</span>
                            <span class="ppulse__barpct">@($"{pctLabel}%")</span>
                          </div>
                        </div>
                      }
                    </div>
                  }
                </div>
                @* END SECTION *@
              </div>

              <div
                class="ppulse__tabpanel ppulse__tabpanel--compact"
                role="tabpanel"
                id="@typePanelId"
                aria-labelledby="@typeTabId"
                data-panel="type"
                hidden
              >
                @* SECTION: Completed bar list (project type) *@
                @{
                    var typeSeries = Model.UniqueCompletedByProjectType ?? new List<TreemapNode>();
                    var typeTotal = typeSeries.Sum(item => item.Count);
                    var typeMax = typeSeries.Count > 0 ? typeSeries.Max(item => item.Count) : 0;
                }

                <div class="ppulse__barlist-wrap">
                  @if (typeCount == 0)
                  {
                    <div class="ppulse__empty ppulse__empty--compact">No data available</div>
                  }
                  else
                  {
                    <div class="ppulse__barlist" role="list" aria-label="Completed projects breakdown by project type">
                      @foreach (var item in typeSeries)
                      {
                        var pctOfMax = typeMax > 0 ? (item.Count * 100.0 / typeMax) : 0;
                        var pctOfTotal = typeTotal > 0 ? (item.Count * 100.0 / typeTotal) : 0;
                        var pctLabel = Math.Round(pctOfTotal);
                        var pctWidth = pctOfMax.ToString("0.##", CultureInfo.InvariantCulture);

                        <div
                          class="ppulse__barrow"
                          role="listitem"
                          title="@item.Label (@item.Count, @pctLabel%)"
                          aria-label="@item.Label: @item.Count projects, @pctLabel%"
                        >
                          <div class="ppulse__barlabel">@item.Label</div>

                          <div class="ppulse__bartrack">
                            <div class="ppulse__barfill" style="width:@pctWidth%"></div>
                          </div>

                          <div class="ppulse__barvalue">
                            <span class="ppulse__barcount">@item.Count</span>
                            <span class="ppulse__barpct">@($"{pctLabel}%")</span>
                          </div>
                        </div>
                      }
                    </div>
                  }
                </div>
                @* END SECTION *@
              </div>
            </div>
          </div>
          @* END SECTION *@

          @* SECTION: Footer *@
          <footer class="ppulse__foot">
            <a class="ppulse__inline-link" href="@Model.CompletedUrl">View completed →</a>
          </footer>
          @* END SECTION *@
        </div>
      </div>
    </article>
  </div>
  @* END SECTION *@
</section>
