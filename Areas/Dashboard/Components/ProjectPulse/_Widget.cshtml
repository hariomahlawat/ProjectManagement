@model ProjectManagement.Areas.Dashboard.Components.ProjectPulse.ProjectPulseVm
@using System
@using System.Collections.Generic
@using System.Linq
@using System.Text.Json
@using ProjectManagement.Areas.Dashboard.Components.ProjectPulse

@* SECTION: Serialization helpers *@
@{
    var jsonOptions = new JsonSerializerOptions(JsonSerializerDefaults.Web);
    string projectPulseJson = JsonSerializer.Serialize(Model, jsonOptions);

    string DescribeCategories(string heading, IReadOnlyList<CategorySlice> slices)
    {
        if (slices.Count == 0)
        {
            return $"{heading} data is not available";
        }

        var details = string.Join(", ", slices.Select(slice => $"{slice.Label} {slice.Count}"));
        return $"{heading}: {details}";
    }

    string DescribeOngoingCategories(string heading, IReadOnlyList<OngoingCategorySlice> slices)
    {
        if (slices.Count == 0)
        {
            return $"{heading} data is not available";
        }

        var details = string.Join(", ", slices.Select(slice => $"{slice.CategoryName} {slice.ProjectCount}"));
        return $"{heading}: {details}";
    }

    string DescribeYearlyCounts(string heading, IReadOnlyList<BarPoint> points)
    {
        if (points.Count == 0)
        {
            return $"{heading} data is not available";
        }

        var details = string.Join(", ", points.Select(point => $"{point.Label} {point.Count}"));
        return $"{heading}: {details}";
    }

}
@* END SECTION *@

<section
    id="project-pulse-root"
    class="pm-card dashboard-pulse ppulse"
    data-project-pulse='@Html.Raw(projectPulseJson)'>
  @* SECTION: Header *@
  <div class="ppulse__head">
    <div class="ppulse__title">
            <img src="~/img/logos/sdd.png" class="pm-powered-by__logo" alt="SDD logo" />
      <span class="ppulse__pulse" aria-hidden="true">
        <i class="bi bi-activity" aria-hidden="true"></i>
      </span>
      <h2 class="ppulse__h">Project pulse</h2>
    </div>
    <div class="ppulse__actions" role="group" aria-label="Project pulse actions">
      <span
        class="ppulse__pill"
        role="button"
        tabindex="0"
        title="Projects eligible for proliferation"
        aria-label="Projects available for proliferation"
      >
        Available for proliferation <strong>@Model.ProliferationEligible</strong>
      </span>
      <a
        class="btn btn-primary btn-sm ppulse__analytics"
        href="@Model.AnalyticsUrl"
        aria-label="Open analytics dashboard"
        title="Open analytics dashboard"
      >
        Open analytics
      </a>
    </div>
  </div>
  @* END SECTION *@

  @* SECTION: Content cards *@
  <div class="ppulse__grid">
    <article class="ppulse__card pulse-item-card">
      <a class="ppulse__link" href="@Model.CompletedUrl" title="View completed projects">
        <header class="ppulse__card-head">
          <h3>Completed <small>@Model.CompletedCount</small></h3>
        </header>
        <div
          class="ppulse__chart pulse-chart-container"
          data-chart-role="completed"
          role="img"
          aria-label='@DescribeYearlyCounts("Completed projects by year", Model.CompletedByYear)'
        >
          <canvas aria-hidden="true"></canvas>
        </div>
        <footer class="ppulse__foot">View completed →</footer>
      </a>
    </article>

    <article class="ppulse__card pulse-item-card">
      <a class="ppulse__link" href="@Model.OngoingUrl" title="View ongoing projects">
        <header class="ppulse__card-head">
          <h3>Ongoing <small>@Model.OngoingCount</small></h3>
        </header>
        <div
          class="ppulse__chart pulse-chart-container"
          data-chart-role="ongoing"
          role="img"
          aria-label='@DescribeOngoingCategories("Ongoing projects split", Model.OngoingByCategory)'
        >
          <canvas aria-hidden="true"></canvas>
        </div>
        @if (Model.OngoingByCategory?.Any() == true)
        {
            <div class="ppulse__breakdown" aria-label="Ongoing projects by category">
                @foreach (var slice in Model.OngoingByCategory)
                {
                    <span class="ppulse__breakdown-item">@slice.CategoryName: @slice.ProjectCount</span>
                }
            </div>
        }
        <footer class="ppulse__foot">View ongoing →</footer>
      </a>
    </article>

    <article class="ppulse__card pulse-item-card">
      <a class="ppulse__link" href="@Model.RepositoryUrl" title="Explore project repository">
        <header class="ppulse__card-head">
          <h3>All projects <small>@Model.TotalProjects</small></h3>
        </header>
        <div
          class="ppulse__chart pulse-chart-container"
          data-chart-role="all-projects"
          role="img"
          aria-label='@DescribeCategories("Top technical categories", Model.AllByTechnicalCategoryTop)'
        >
          <canvas aria-hidden="true"></canvas>
        </div>
        @if (Model.RemainingTechCategories > 0)
        {
          <div class="ppulse__hint">+@Model.RemainingTechCategories more categories</div>
        }
        <footer class="ppulse__foot">Explore repository →</footer>
      </a>
    </article>
  </div>
  @* END SECTION *@
</section>
