@page
@model ProjectManagement.Areas.DocumentRepository.Pages.Documents.IndexModel
@{
    ViewData["Title"] = "Document repository";
}

@section Styles {
    <link rel="stylesheet" href="~/css/docrepo-ui.css" asp-append-version="true" />
}

@section Scripts {
    <!-- SECTION: Document repository UI -->
    <script src="~/js/docrepo-ui.js" asp-append-version="true"></script>
}

<div class="container-fluid py-2">

    <nav aria-label="breadcrumb" class="mb-2">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a asp-area="" asp-page="/Index">Dashboard</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Documents</li>
        </ol>
    </nav>

    @if (Model.EnableListViewUxUpgrade)
    {
        <!-- SECTION: Shell layout -->
        <div class="docrepo-shell">
            <!-- SECTION: Filters panel -->
            <aside class="docrepo-filters" id="docrepoFilters">
                <div class="docrepo-filters__header">
                    <div class="docrepo-filters__title">Filters</div>
                    <button type="button"
                            class="btn btn-sm btn-light docrepo-filters__toggle"
                            id="docrepoFiltersToggle"
                            title="Collapse filters"
                            aria-label="Collapse filters">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                </div>

                <form method="get" asp-page="./Index" class="docrepo-facets" id="docrepoFacetsForm">
                    <!-- SECTION: Apply-only params -->
                    <input type="hidden" name="q" value="@Model.Q" />
                    <input type="hidden" name="view" value="@Model.ViewMode" />
                    <input type="hidden" name="page" value="1" />
                    <input type="hidden" name="pageSize" value="@Model.PageSize" />

                    <!-- SECTION: Facet hidden inputs -->
                    <input type="hidden" name="officeCategoryId" id="officeCategoryIdHidden" value="@(Model.OfficeCategoryId?.ToString() ?? string.Empty)" />
                    <input type="hidden" name="documentCategoryId" id="documentCategoryIdHidden" value="@(Model.DocumentCategoryId?.ToString() ?? string.Empty)" />
                    <input type="hidden" name="year" id="yearHidden" value="@(Model.Year?.ToString() ?? string.Empty)" />

                    <!-- SECTION: Office facet -->
                    <div class="docrepo-facet">
                        <div class="docrepo-facet__title">OFFICE</div>
                        <div class="docrepo-facet__list" data-facet-single="office" data-target-hidden="#officeCategoryIdHidden">
                            <label class="docrepo-check">
                                <input type="checkbox"
                                       class="docrepo-check__input"
                                       data-value=""
                                       @(Model.OfficeCategoryId.HasValue ? null : "checked") />
                                <span class="docrepo-check__label">All offices</span>
                            </label>
                            @foreach (var office in Model.OfficeCategories)
                            {
                                var isChecked = Model.OfficeCategoryId.HasValue && Model.OfficeCategoryId.Value == office.Id;
                                <label class="docrepo-check">
                                    <input type="checkbox"
                                           class="docrepo-check__input"
                                           data-value="@office.Id"
                                           @(isChecked ? "checked" : null) />
                                    <span class="docrepo-check__label">@office.Name</span>
                                </label>
                            }
                        </div>
                    </div>

                    <!-- SECTION: Document type facet -->
                    <div class="docrepo-facet">
                        <div class="docrepo-facet__title">DOCUMENT TYPE</div>
                        <div class="docrepo-facet__list" data-facet-single="doctype" data-target-hidden="#documentCategoryIdHidden">
                            <label class="docrepo-check">
                                <input type="checkbox"
                                       class="docrepo-check__input"
                                       data-value=""
                                       @(Model.DocumentCategoryId.HasValue ? null : "checked") />
                                <span class="docrepo-check__label">All document types</span>
                            </label>
                            @foreach (var docCat in Model.DocumentCategories)
                            {
                                var isChecked = Model.DocumentCategoryId.HasValue && Model.DocumentCategoryId.Value == docCat.Id;
                                <label class="docrepo-check">
                                    <input type="checkbox"
                                           class="docrepo-check__input"
                                           data-value="@docCat.Id"
                                           @(isChecked ? "checked" : null) />
                                    <span class="docrepo-check__label">@docCat.Name</span>
                                </label>
                            }
                        </div>
                    </div>

                    <!-- SECTION: Year facet -->
                    <div class="docrepo-facet">
                        <div class="docrepo-facet__title">YEAR</div>
                        @{
                            var currentYear = DateTime.UtcNow.Year;
                            var yearsToShow = new[] { currentYear, currentYear - 1, currentYear - 2, currentYear - 3, currentYear - 4, currentYear - 5 };
                            var isYearInList = Model.Year.HasValue && yearsToShow.Contains(Model.Year.Value);
                            var customYearValue = isYearInList ? string.Empty : (Model.Year?.ToString() ?? string.Empty);
                        }
                        <div class="docrepo-facet__list" data-facet-single="year" data-target-hidden="#yearHidden">
                            <label class="docrepo-check">
                                <input type="checkbox"
                                       class="docrepo-check__input"
                                       data-value=""
                                       @(!Model.Year.HasValue ? "checked" : null) />
                                <span class="docrepo-check__label">All years</span>
                            </label>
                            @foreach (var year in yearsToShow)
                            {
                                var isChecked = Model.Year.HasValue && Model.Year.Value == year;
                                <label class="docrepo-check">
                                    <input type="checkbox"
                                           class="docrepo-check__input"
                                           data-value="@year"
                                           @(isChecked ? "checked" : null) />
                                    <span class="docrepo-check__label">@year</span>
                                </label>
                            }
                        </div>
                        <div class="docrepo-facet__sub">
                            <label class="form-label small mb-1" for="customYearInput">Custom year</label>
                            <input class="form-control form-control-sm"
                                   id="customYearInput"
                                   type="number"
                                   min="1900"
                                   max="2100"
                                   value="@customYearValue"
                                   placeholder="yyyy"
                                   data-custom-year />
                            <div class="form-text">If filled, it overrides the year selection.</div>
                        </div>
                    </div>

                    <!-- SECTION: Tag facet -->
                    <div class="docrepo-facet">
                        <div class="docrepo-facet__title">TAG</div>
                        <input class="form-control form-control-sm"
                               name="tag"
                               value="@Model.Tag"
                               placeholder="e.g. sow, contract" />
                    </div>

                    <!-- SECTION: Include inactive -->
                    <div class="docrepo-facet">
                        <label class="form-check docrepo-inline-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   name="includeInactive"
                                   value="true"
                                   @(Model.IncludeInactive ? "checked" : null) />
                            <span class="form-check-label">Include inactive</span>
                        </label>
                    </div>

                    <!-- SECTION: Facet actions -->
                    <div class="docrepo-facet__actions">
                        <button type="submit" class="btn btn-primary btn-sm w-100">Apply</button>
                        <a class="btn btn-outline-secondary btn-sm w-100"
                           asp-page="./Index"
                           asp-route-page="1"
                           asp-route-pageSize="@Model.PageSize"
                           asp-route-view="@Model.ViewMode">
                            Clear filters
                        </a>
                    </div>
                </form>

                <div class="docrepo-filters__collapsedHint">
                    <button type="button"
                            class="btn btn-sm btn-light"
                            id="docrepoFiltersExpandBtn"
                            title="Expand filters"
                            aria-label="Expand filters">
                        <i class="bi bi-funnel"></i>
                    </button>
                </div>
            </aside>

            <!-- SECTION: Content -->
            <main class="docrepo-main">
                <!-- SECTION: Toolbar -->
                <div class="docrepo-main__toolbar">
                    <form method="get" asp-page="./Index" class="docrepo-searchbar docrepo-searchbar--toolbar" data-docrepo-filter>
                        <div class="docrepo-searchbar__input">
                            <i class="bi bi-search"></i>
                            <input type="search"
                                   name="q"
                                   value="@Model.Q"
                                   placeholder="Search documents (subject, sender, tags)…"
                                   aria-label="Search documents" />
                        </div>
                        <div class="docrepo-searchbar__actions">
                            <button type="submit" class="btn btn-primary">Search</button>
                        </div>

                        <input type="hidden" name="page" value="1" />
                        <input type="hidden" name="pageSize" value="@Model.PageSize" />
                        <input type="hidden" name="view" value="@Model.ViewMode" />
                        <input type="hidden" name="tag" value="@Model.Tag" />
                        <input type="hidden" name="officeCategoryId" value="@(Model.OfficeCategoryId?.ToString() ?? string.Empty)" />
                        <input type="hidden" name="documentCategoryId" value="@(Model.DocumentCategoryId?.ToString() ?? string.Empty)" />
                        <input type="hidden" name="year" value="@(Model.Year?.ToString() ?? string.Empty)" />
                        @if (Model.IncludeInactive)
                        {
                            <input type="hidden" name="includeInactive" value="true" />
                        }
                    </form>

                    <div class="btn-group docrepo-view-toggle" role="group" aria-label="View mode">
                        <a class="btn btn-sm @(Model.IsListView ? "btn-primary" : "btn-outline-primary")"
                           href="@Model.UrlForView("list")">
                            <i class="bi bi-list"></i>
                            <span class="d-none d-sm-inline">List</span>
                        </a>
                        <a class="btn btn-sm @(!Model.IsListView ? "btn-primary" : "btn-outline-primary")"
                           href="@Model.UrlForView("cards")">
                            <i class="bi bi-grid-3x3-gap"></i>
                            <span class="d-none d-sm-inline">Cards</span>
                        </a>
                    </div>
                </div>

                <partial name="_Pager" model="new PagerModel(Model.PageNumber, Model.PageSize, Model.TotalCount, Request)" />

                @if (Model.IsSearchActive && Model.HasTagMatch)
                {
                    <div class="alert alert-secondary alert-dismissible fade show d-flex align-items-center gap-2 small" role="alert">
                        <i class="bi bi-bookmark-fill text-muted"></i>
                        <span>
                            Also found a tag with this name. You can filter by this tag.
                            <a class="alert-link"
                               asp-page="./Index"
                               asp-route-q="@Model.Q"
                               asp-route-tag="@Model.Q"
                               asp-route-officeCategoryId="@Model.OfficeCategoryId"
                               asp-route-documentCategoryId="@Model.DocumentCategoryId"
                               asp-route-year="@Model.Year"
                               asp-route-includeInactive="@Model.IncludeInactive"
                               asp-route-page="1"
                               asp-route-pageSize="@Model.PageSize"
                               asp-route-view="@Model.ViewMode">
                                Apply tag filter
                            </a>
                        </span>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                @if ((Model.IsListView && !Model.ListItems.Any()) ||
                     (!Model.IsListView && !Model.Items.Any()))
                {
                    if (Model.IsSearchActive)
                    {
                        <div class="alert alert-info">
                            No documents matched "@Model.Q".
                            <a asp-page="./Index" asp-route-view="@Model.ViewMode">Show all active documents</a>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-light border">No documents found.</div>
                    }
                }
                else
                {
                    if (Model.IsListView)
                    {
                        <div class="table-responsive docrepo-list-wrapper">
                            <table class="table docrepo-list">
                                <thead>
                                    <tr>
                                        <th>Subject</th>
                                        <th>Document Category</th>
                                        <th>Office</th>
                                        <th>Document Date</th>
                                        <th>OCR Status</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var d in Model.ListItems)
                                    {
                                        @await Html.PartialAsync("_DocumentList", d)
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
                            @foreach (var d in Model.Items)
                            {
                                <div class="col">
                                    @await Html.PartialAsync("_DocumentCard", d)
                                </div>
                            }
                        </div>
                    }
                }

                <partial name="_Pager" model="new PagerModel(Model.PageNumber, Model.PageSize, Model.TotalCount, Request)" />
            </main>
        </div>
    }
    else
    {
        <!-- SECTION: Search bar -->
        <div class="docrepo-search-shell">
            <form method="get" class="docrepo-searchbar" data-docrepo-filter>
                <div class="docrepo-search-input">
                    <i class="bi bi-search"></i>
                    <input type="search"
                           name="q"
                           value="@Model.Q"
                           placeholder="Search documents (subject, sender, tags)…"
                           aria-label="Search documents" />
                </div>
                <div class="docrepo-search-actions">
                    <button type="submit" class="btn btn-primary px-4">Search</button>
                    <button type="button"
                            class="btn btn-outline-secondary"
                            data-bs-toggle="modal"
                            data-bs-target="#docrepoFilterModal">
                        <i class="bi bi-funnel"></i>
                        <span class="d-none d-sm-inline">More filters</span>
                    </button>
                </div>

                <input type="hidden" name="page" value="1" />
                <input type="hidden" name="pageSize" value="@Model.PageSize" />
                <input type="hidden" name="tag" value="@Model.Tag" />
                <input type="hidden" name="officeCategoryId" value="@Model.OfficeCategoryId" />
                <input type="hidden" name="documentCategoryId" value="@Model.DocumentCategoryId" />
                <input type="hidden" name="year" value="@Model.Year" />
                @if (Model.IncludeInactive)
                {
                    <input type="hidden" name="includeInactive" value="true" />
                }
            </form>
        </div>

        <partial name="_Pager" model="new PagerModel(Model.PageNumber, Model.PageSize, Model.TotalCount, Request)" />

        @if (Model.IsSearchActive && Model.HasTagMatch)
        {
            <div class="alert alert-secondary alert-dismissible fade show d-flex align-items-center gap-2 small" role="alert">
                <i class="bi bi-bookmark-fill text-muted"></i>
                <span>
                    Also found a tag with this name. You can filter by this tag.
                    <a class="alert-link"
                       asp-page="./Index"
                       asp-route-q="@Model.Q"
                       asp-route-tag="@Model.Q"
                       asp-route-officeCategoryId="@Model.OfficeCategoryId"
                       asp-route-documentCategoryId="@Model.DocumentCategoryId"
                       asp-route-year="@Model.Year"
                       asp-route-includeInactive="@Model.IncludeInactive"
                       asp-route-page="1"
                       asp-route-pageSize="@Model.PageSize">
                        Apply tag filter
                    </a>
                </span>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        @if (!Model.Items.Any())
        {
            if (Model.IsSearchActive)
            {
                <div class="alert alert-info">
                    No documents matched "@Model.Q".
                    <a asp-page="./Index">Show all active documents</a>
                </div>
            }
            else
            {
                <div class="alert alert-light border">No documents found.</div>
            }
        }
        else
        {
            <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
                @foreach (var d in Model.Items)
                {
                    <div class="col">
                        @await Html.PartialAsync("_DocumentCard", d)
                    </div>
                }
            </div>
        }

        <partial name="_Pager" model="new PagerModel(Model.PageNumber, Model.PageSize, Model.TotalCount, Request)" />
    }
</div>

@if (!Model.EnableListViewUxUpgrade)
{
    <!-- SECTION: filter modal -->
    <div class="modal fade" id="docrepoFilterModal" tabindex="-1" aria-labelledby="docrepoFilterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="get" asp-route-q="@Model.Q">
                    <div class="modal-header">
                        <h5 class="modal-title" id="docrepoFilterModalLabel">Filters</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="q" value="@Model.Q" />
                        <input type="hidden" name="page" value="1" />
                        <input type="hidden" name="pageSize" value="@Model.PageSize" />

                        <div class="mb-3">
                            <label class="form-label" for="tagInput">Tag</label>
                            <input class="form-control" id="tagInput" name="tag" value="@Model.Tag" placeholder="e.g. sow, contract" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="officeSelect">Office</label>
                            <select class="form-select" id="officeSelect" name="officeCategoryId">
                                <option value="">All offices</option>
                                @foreach (var office in Model.OfficeCategories)
                                {
                                    if (Model.OfficeCategoryId == office.Id)
                                    {
                                        <option value="@office.Id" selected>@office.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@office.Id">@office.Name</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="docTypeSelect">Document type</label>
                            <select class="form-select" id="docTypeSelect" name="documentCategoryId">
                                <option value="">All document types</option>
                                @foreach (var docCat in Model.DocumentCategories)
                                {
                                    if (Model.DocumentCategoryId == docCat.Id)
                                    {
                                        <option value="@docCat.Id" selected>@docCat.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@docCat.Id">@docCat.Name</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="yearInput">Year</label>
                            <input class="form-control"
                                   id="yearInput"
                                   type="number"
                                   name="year"
                                   value="@(Model.Year?.ToString() ?? string.Empty)"
                                   min="1900"
                                   max="2100" />
                        </div>

                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   id="includeInactiveChk"
                                   name="includeInactive"
                                   value="true"
                                   @(Model.IncludeInactive ? "checked" : null) />
                            <label class="form-check-label" for="includeInactiveChk">
                                Include inactive
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Apply</button>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}
