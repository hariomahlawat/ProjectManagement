@page
@model ProjectManagement.Areas.DocumentRepository.Pages.Documents.IndexModel
@using Microsoft.AspNetCore.Authorization
@inject IAuthorizationService AuthorizationService
@{
    ViewData["Title"] = "Document repository";

    var canUpload = (await AuthorizationService.AuthorizeAsync(User, "DocRepo.Upload")).Succeeded;
    var canSeeDeleteRequests = (await AuthorizationService.AuthorizeAsync(User, "DocRepo.DeleteApprove")).Succeeded;
}

<div class="container-fluid pt-3 pb-4">

    <!-- top bar: breadcrumb + title + actions in one line -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <nav aria-label="breadcrumb" class="mb-0">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a asp-area="" asp-page="/Index">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Documents</li>
                </ol>
            </nav>
        </div>
        <div class="d-flex gap-2">
            @if (canSeeDeleteRequests)
            {
                <a asp-area="DocumentRepository"
                   asp-page="/Admin/DeleteRequests/Index"
                   class="btn btn-outline-danger">
                    Delete requests
                </a>
            }
            @if (canUpload)
            {
                <a asp-page="./Upload" class="btn btn-primary">
                    <i class="bi bi-upload me-1"></i>Upload
                </a>
            }
        </div>
    </div>

    <!-- search row -->
    <form method="get" class="d-flex gap-2 align-items-center mb-3">
        <div class="flex-grow-1">
            <div class="input-group input-group-lg shadow-sm rounded-3 bg-white">
                <span class="input-group-text bg-white border-0">
                    <i class="bi bi-search"></i>
                </span>
                <input name="q"
                       value="@Model.Q"
                       type="search"
                       class="form-control border-0"
                       placeholder="Search documents (subject, sender, tags)â€¦" />
                <button class="btn btn-primary px-4 rounded-end-3" type="submit">Search</button>
            </div>
        </div>

        <button type="button"
                class="btn btn-outline-secondary d-flex align-items-center gap-1"
                data-bs-toggle="modal"
                data-bs-target="#docFilterModal">
            <i class="bi bi-funnel"></i>
            Filters
        </button>

        <input type="hidden" name="page" value="@Model.PageNumber" />
        <input type="hidden" name="pageSize" value="@Model.PageSize" />
    </form>

    <partial name="_Pager" model="new PagerModel(Model.PageNumber, Model.PageSize, Model.TotalCount, Request)" />

    @if (!Model.Items.Any())
    {
        <div class="alert alert-light border">No documents found.</div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
            @foreach (var d in Model.Items)
            {
                <div class="col">
                    @await Html.PartialAsync("_DocumentCard", d)
                </div>
            }
        </div>
    }

    <partial name="_Pager" model="new PagerModel(Model.PageNumber, Model.PageSize, Model.TotalCount, Request)" />
</div>

<!-- FILTER MODAL (same as last time, just pasted again so you have single file) -->
<div class="modal fade" id="docFilterModal" tabindex="-1" aria-labelledby="docFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="get">
                <div class="modal-header">
                    <h5 class="modal-title" id="docFilterModalLabel">Filter documents</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="q" value="@Model.Q" />
                    <input type="hidden" name="page" value="1" />
                    <input type="hidden" name="pageSize" value="@Model.PageSize" />

                    <div class="mb-3">
                        <label class="form-label" for="tagInput">Tag</label>
                        <input class="form-control" id="tagInput" name="tag" value="@Model.Tag" placeholder="e.g. sow, contract" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="officeSelect">Office</label>
                        <select class="form-select" id="officeSelect" name="officeCategoryId">
                            <option value="">All offices</option>
                            @foreach (var office in Model.OfficeCategories)
                            {
                                if (Model.OfficeCategoryId == office.Id)
                                {
                                    <option value="@office.Id" selected="selected">@office.Name</option>
                                }
                                else
                                {
                                    <option value="@office.Id">@office.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="docTypeSelect">Document type</label>
                        <select class="form-select" id="docTypeSelect" name="documentCategoryId">
                            <option value="">All document types</option>
                            @foreach (var docCat in Model.DocumentCategories)
                            {
                                if (Model.DocumentCategoryId == docCat.Id)
                                {
                                    <option value="@docCat.Id" selected="selected">@docCat.Name</option>
                                }
                                else
                                {
                                    <option value="@docCat.Id">@docCat.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="yearInput">Year</label>
                        <input class="form-control" id="yearInput" name="year" type="number" min="1900" max="2100" value="@(Model.Year?.ToString() ?? string.Empty)" />
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeInactiveCheck" name="includeInactive" value="true" @(Model.IncludeInactive ? "checked" : null) />
                        <label class="form-check-label" for="includeInactiveCheck">
                            Include inactive documents
                        </label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Apply filters</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </form>
        </div>
    </div>
</div>
