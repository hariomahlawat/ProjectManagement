@page
@model ProjectManagement.Areas.DocumentRepository.Pages.Documents.IndexModel
@{
    ViewData["Title"] = "Document repository";
}

@section Styles {
    <link rel="stylesheet" href="~/css/docrepo-ui.css" asp-append-version="true" />
}

<div class="container-fluid py-2">

    <nav aria-label="breadcrumb" class="mb-2">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a asp-area="" asp-page="/Index">Dashboard</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Documents</li>
        </ol>
    </nav>

    <!-- SECTION: Search bar -->
    <div class="docrepo-search-shell">
        <form method="get" class="docrepo-searchbar" data-docrepo-filter>
            <div class="docrepo-search-input">
                <i class="bi bi-search"></i>
                <input type="search"
                       name="q"
                       value="@Model.Q"
                       placeholder="Search documents (subject, sender, tags)â€¦"
                       aria-label="Search documents" />
            </div>
            <div class="docrepo-search-actions">
                <button type="submit" class="btn btn-primary px-4">Search</button>
                <button type="button"
                        class="btn btn-outline-secondary"
                        data-bs-toggle="modal"
                        data-bs-target="#docrepoFilterModal">
                    <i class="bi bi-funnel"></i>
                    <span class="d-none d-sm-inline">More filters</span>
                </button>
            </div>

            <input type="hidden" name="page" value="@Model.PageNumber" />
            <input type="hidden" name="pageSize" value="@Model.PageSize" />
            @if (Model.EnableListViewUxUpgrade)
            {
                <input type="hidden" name="view" value="@Model.ViewMode" />
            }
        </form>
    </div>

    @if (Model.EnableListViewUxUpgrade)
    {
        <!-- SECTION: View toggle -->
        <div class="docrepo-toolbar">
            <div class="btn-group docrepo-view-toggle" role="group" aria-label="View mode">
                <a class="btn btn-sm @(Model.IsListView ? "btn-primary" : "btn-outline-primary")"
                   href="@Model.UrlForView("list")">
                    <i class="bi bi-list"></i>
                    <span class="d-none d-sm-inline">List</span>
                </a>
                <a class="btn btn-sm @(!Model.IsListView ? "btn-primary" : "btn-outline-primary")"
                   href="@Model.UrlForView("cards")">
                    <i class="bi bi-grid-3x3-gap"></i>
                    <span class="d-none d-sm-inline">Cards</span>
                </a>
            </div>
        </div>

        <!-- SECTION: Filter chips -->
        <div class="docrepo-chipbar">
            <div class="docrepo-chip">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#docrepoFilterModal">
                    Office: @(Model.OfficeCategoryId.HasValue ? Model.OfficeCategories.FirstOrDefault(office => office.Id == Model.OfficeCategoryId)?.Name : "All")
                </button>
                @if (Model.OfficeCategoryId.HasValue)
                {
                    <a class="btn btn-sm btn-outline-secondary docrepo-chip__clear"
                       asp-page="./Index"
                       asp-route-q="@Model.Q"
                       asp-route-tag="@Model.Tag"
                       asp-route-documentCategoryId="@Model.DocumentCategoryId"
                       asp-route-year="@Model.Year"
                       asp-route-includeInactive="@Model.IncludeInactive"
                       asp-route-page="@Model.PageNumber"
                       asp-route-pageSize="@Model.PageSize"
                       asp-route-view="@Model.ViewMode">
                        <i class="bi bi-x"></i>
                    </a>
                }
            </div>
            <div class="docrepo-chip">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#docrepoFilterModal">
                    Type: @(Model.DocumentCategoryId.HasValue ? Model.DocumentCategories.FirstOrDefault(category => category.Id == Model.DocumentCategoryId)?.Name : "All")
                </button>
                @if (Model.DocumentCategoryId.HasValue)
                {
                    <a class="btn btn-sm btn-outline-secondary docrepo-chip__clear"
                       asp-page="./Index"
                       asp-route-q="@Model.Q"
                       asp-route-tag="@Model.Tag"
                       asp-route-officeCategoryId="@Model.OfficeCategoryId"
                       asp-route-year="@Model.Year"
                       asp-route-includeInactive="@Model.IncludeInactive"
                       asp-route-page="@Model.PageNumber"
                       asp-route-pageSize="@Model.PageSize"
                       asp-route-view="@Model.ViewMode">
                        <i class="bi bi-x"></i>
                    </a>
                }
            </div>
            <div class="docrepo-chip">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#docrepoFilterModal">
                    Year: @(Model.Year.HasValue ? Model.Year.Value.ToString() : "All")
                </button>
                @if (Model.Year.HasValue)
                {
                    <a class="btn btn-sm btn-outline-secondary docrepo-chip__clear"
                       asp-page="./Index"
                       asp-route-q="@Model.Q"
                       asp-route-tag="@Model.Tag"
                       asp-route-officeCategoryId="@Model.OfficeCategoryId"
                       asp-route-documentCategoryId="@Model.DocumentCategoryId"
                       asp-route-includeInactive="@Model.IncludeInactive"
                       asp-route-page="@Model.PageNumber"
                       asp-route-pageSize="@Model.PageSize"
                       asp-route-view="@Model.ViewMode">
                        <i class="bi bi-x"></i>
                    </a>
                }
            </div>
            <div class="docrepo-chip">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#docrepoFilterModal">
                    Tag: @(string.IsNullOrWhiteSpace(Model.Tag) ? "All" : Model.Tag)
                </button>
                @if (!string.IsNullOrWhiteSpace(Model.Tag))
                {
                    <a class="btn btn-sm btn-outline-secondary docrepo-chip__clear"
                       asp-page="./Index"
                       asp-route-q="@Model.Q"
                       asp-route-officeCategoryId="@Model.OfficeCategoryId"
                       asp-route-documentCategoryId="@Model.DocumentCategoryId"
                       asp-route-year="@Model.Year"
                       asp-route-includeInactive="@Model.IncludeInactive"
                       asp-route-page="@Model.PageNumber"
                       asp-route-pageSize="@Model.PageSize"
                       asp-route-view="@Model.ViewMode">
                        <i class="bi bi-x"></i>
                    </a>
                }
            </div>
            <div class="docrepo-chip">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#docrepoFilterModal">
                    Inactive: @(Model.IncludeInactive ? "Included" : "Excluded")
                </button>
                @if (Model.IncludeInactive)
                {
                    <a class="btn btn-sm btn-outline-secondary docrepo-chip__clear"
                       asp-page="./Index"
                       asp-route-q="@Model.Q"
                       asp-route-tag="@Model.Tag"
                       asp-route-officeCategoryId="@Model.OfficeCategoryId"
                       asp-route-documentCategoryId="@Model.DocumentCategoryId"
                       asp-route-year="@Model.Year"
                       asp-route-page="@Model.PageNumber"
                       asp-route-pageSize="@Model.PageSize"
                       asp-route-view="@Model.ViewMode">
                        <i class="bi bi-x"></i>
                    </a>
                }
            </div>
            <a class="btn btn-sm btn-link docrepo-chip__clear-all"
               asp-page="./Index"
               asp-route-view="@Model.ViewMode">
                Clear all
            </a>
        </div>
    }

    <partial name="_Pager" model="new PagerModel(Model.PageNumber, Model.PageSize, Model.TotalCount, Request)" />

    @if (Model.IsSearchActive && Model.HasTagMatch)
    {
        <div class="alert alert-secondary alert-dismissible fade show d-flex align-items-center gap-2 small" role="alert">
            <i class="bi bi-bookmark-fill text-muted"></i>
            <span>
                Also found a tag with this name. You can filter by this tag.
                <a class="alert-link"
                   asp-page="./Index"
                   asp-route-q="@Model.Q"
                   asp-route-tag="@Model.Q"
                   asp-route-officeCategoryId="@Model.OfficeCategoryId"
                   asp-route-documentCategoryId="@Model.DocumentCategoryId"
                   asp-route-year="@Model.Year"
                   asp-route-includeInactive="@Model.IncludeInactive"
                   asp-route-view="@Model.ViewMode">
                    Apply tag filter
                </a>
            </span>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if ((Model.IsListView && Model.EnableListViewUxUpgrade && !Model.ListItems.Any()) ||
         (!Model.IsListView && !Model.Items.Any()))
    {
        if (Model.IsSearchActive)
        {
            <div class="alert alert-info">
                No documents matched "@Model.Q".
                <a asp-page="./Index" asp-route-view="@Model.ViewMode">Show all active documents</a>
            </div>
        }
        else
        {
            <div class="alert alert-light border">No documents found.</div>
        }
    }
    else
    {
        if (Model.IsListView && Model.EnableListViewUxUpgrade)
        {
            <div class="table-responsive docrepo-list-wrapper">
                <table class="table docrepo-list">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Document Category</th>
                            <th>Office</th>
                            <th>Document Date</th>
                            <th>OCR Status</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var d in Model.ListItems)
                        {
                            @await Html.PartialAsync("_DocumentList", d)
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3">
                @foreach (var d in Model.Items)
                {
                    <div class="col">
                        @await Html.PartialAsync("_DocumentCard", d)
                    </div>
                }
            </div>
        }
    }

    <partial name="_Pager" model="new PagerModel(Model.PageNumber, Model.PageSize, Model.TotalCount, Request)" />
</div>

<!-- filter modal -->
<div class="modal fade" id="docrepoFilterModal" tabindex="-1" aria-labelledby="docrepoFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="get" asp-route-q="@Model.Q">
                <div class="modal-header">
                    <h5 class="modal-title" id="docrepoFilterModalLabel">Filters</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="q" value="@Model.Q" />
                    @if (Model.EnableListViewUxUpgrade)
                    {
                        <input type="hidden" name="view" value="@Model.ViewMode" />
                    }

                    <div class="mb-3">
                        <label class="form-label" for="tagInput">Tag</label>
                        <input class="form-control" id="tagInput" name="tag" value="@Model.Tag" placeholder="e.g. sow, contract" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="officeSelect">Office</label>
                        <select class="form-select" id="officeSelect" name="officeCategoryId">
                            <option value="">All offices</option>
                            @foreach (var office in Model.OfficeCategories)
                            {
                                if (Model.OfficeCategoryId == office.Id)
                                {
                                    <option value="@office.Id" selected>@office.Name</option>
                                }
                                else
                                {
                                    <option value="@office.Id">@office.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="docTypeSelect">Document type</label>
                        <select class="form-select" id="docTypeSelect" name="documentCategoryId">
                            <option value="">All document types</option>
                            @foreach (var docCat in Model.DocumentCategories)
                            {
                                if (Model.DocumentCategoryId == docCat.Id)
                                {
                                    <option value="@docCat.Id" selected>@docCat.Name</option>
                                }
                                else
                                {
                                    <option value="@docCat.Id">@docCat.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="yearInput">Year</label>
                        <input class="form-control"
                               id="yearInput"
                               type="number"
                               name="year"
                               value="@(Model.Year?.ToString() ?? string.Empty)"
                               min="1900"
                               max="2100" />
                    </div>

                    <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               id="includeInactiveChk"
                               name="includeInactive"
                               value="true"
                               @(Model.IncludeInactive ? "checked" : null) />
                        <label class="form-check-label" for="includeInactiveChk">
                            Include inactive
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Apply</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </form>
        </div>
    </div>
</div>
