@model ProjectManagement.Data.DocRepo.Document
@using ProjectManagement.Data.DocRepo

<div class="doc-card card h-100 shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start">
      <div class="me-3 flex-grow-1">
        <h3 class="h6 mb-1 text-truncate-2">@Model.Subject</h3>
        <div class="doc-meta text-muted small d-flex flex-wrap align-items-center gap-2">
          @if (!string.IsNullOrWhiteSpace(Model.ReceivedFrom))
          { <span>@Model.ReceivedFrom</span> }
          @if (Model.OfficeCategory is not null)
          { <span>· @Model.OfficeCategory.Name</span> }
          @if (Model.DocumentCategory is not null)
          { <span>· @Model.DocumentCategory.Name</span> }
          @if (Model.DocumentDate.HasValue)
          { <span>· @Model.DocumentDate.Value.ToString("dd MMM yyyy")</span> }
        </div>
      </div>

      <div class="text-end">
        <span class="badge @(Model.OcrStatus switch
           { OcrStatus.Queued => "bg-secondary",
             OcrStatus.Succeeded => "bg-success",
             OcrStatus.Failed => "bg-danger",
             _ => "bg-light text-dark" })">
          OCR: @Model.OcrStatus
        </span>
        @if (!Model.IsActive)
        {
          <div class="badge bg-warning text-dark mt-1">Inactive</div>
        }
      </div>
    </div>

    @if (Model.DocumentTags?.Any() == true)
    {
      <div class="doc-tags mt-2">
        @foreach (var t in Model.DocumentTags.Select(x => x.Tag))
        {
          <span class="badge doc-chip me-1 mb-1">@t.Name</span>
        }
      </div>
    }
  </div>

  <div class="card-footer">
    <div class="doc-actions d-flex align-items-center flex-wrap gap-2">
      <!-- Primary actions (left) -->
      <a class="btn btn-sm btn-outline-primary"
         asp-page="./Reader" asp-route-id="@Model.Id" target="_blank" rel="noopener">
        <i class="bi bi-box-arrow-up-right"></i> View
      </a>
      <a class="btn btn-sm btn-outline-secondary"
         asp-page="./Download" asp-route-id="@Model.Id">
        <i class="bi bi-download"></i> Download
      </a>

      <authorize policy="DocRepo.EditMetadata">
        <a class="btn btn-sm btn-outline-dark" asp-page="./Edit" asp-route-id="@Model.Id">Edit</a>
      </authorize>

      <!-- Lifecycle actions (right, wraps nicely) -->
      <authorize policy="DocRepo.SoftDelete">
        <div class="ms-auto d-flex align-items-center flex-wrap gap-2">
          <form method="post" asp-page="./Manage" asp-page-handler="Deactivate" asp-route-id="@Model.Id" class="m-0 d-inline-block">
            <button class="btn btn-sm btn-outline-warning" type="submit" @(Model.IsActive ? null : "disabled")>Deactivate</button>
          </form>
          <form method="post" asp-page="./Manage" asp-page-handler="Activate" asp-route-id="@Model.Id" class="m-0 d-inline-block">
            <button class="btn btn-sm btn-outline-success" type="submit" @(!Model.IsActive ? null : "disabled")>Activate</button>
          </form>
          <form method="post" asp-page="./Manage" asp-page-handler="RequestDelete" asp-route-id="@Model.Id" class="m-0 d-inline-block">
            <input type="hidden" name="reason" value="Obsolete" />
            <button class="btn btn-sm btn-outline-danger" type="submit">Request Delete</button>
          </form>
        </div>
      </authorize>
    </div>
  </div>
</div>
