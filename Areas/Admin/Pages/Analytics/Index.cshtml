@page
@model ProjectManagement.Areas.Admin.Pages.Analytics.IndexModel
@using System.Text.Json
@{
  ViewData["Title"] = "Analytics";
}
<nav aria-label="breadcrumb" class="mb-2">
  <ol class="breadcrumb small mb-0">
    <li class="breadcrumb-item"><a asp-area="Admin" asp-page="/Index">Admin</a></li>
    <li class="breadcrumb-item active" aria-current="page">Analytics</li>
  </ol>
</nav>
<h3 class="mb-3">Analytics
  <a class="ms-1 text-decoration-none" asp-area="Admin" asp-page="/Help/Index" asp-fragment="analytics" title="Help">
    <i class="bi bi-question-circle"></i>
  </a>
</h3>
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="pm-card pm-shadow p-3">
      <div class="text-muted">Logins today</div>
      <div class="d-flex justify-content-between align-items-end">
        <div class="fs-3">
          @{ var loginsToday = Model.LoginsLast30Days[^1]; var loginsYesterday = Model.LoginsLast30Days.Length > 1 ? Model.LoginsLast30Days[^2] : 0; var diff = loginsToday - loginsYesterday; }
          @loginsToday
          <span class="fs-6 text-muted">@(diff >= 0 ? "▲" : "▼")@Math.Abs(diff)</span>
        </div>
        <div class="sparkline" data-points="@string.Join(',', Model.LoginsLast30Days.Skip(Math.Max(0, Model.LoginsLast30Days.Length-7)))"></div>
      </div>
    </div>
  </div>
  <div class="col-md-3"><div class="pm-card pm-shadow p-3"><div class="text-muted">Total users</div><div class="fs-3">@Model.TotalUsers</div></div></div>
  <div class="col-md-3"><div class="pm-card pm-shadow p-3"><div class="text-muted">Active</div><div class="fs-3">@Model.ActiveUsers</div></div></div>
  <div class="col-md-3"><div class="pm-card pm-shadow p-3"><div class="text-muted">Disabled</div><div class="fs-3">@Model.DisabledUsers</div></div></div>
</div>

  <div class="pm-card pm-shadow p-3 mb-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h5 class="mb-0">Logins per day (last 30 days)</h5>
      <small class="text-muted">IST</small>
    </div>

  <div class="chart-container-240">
    <canvas id="loginsPerDayChart"
            data-labels='@JsonSerializer.Serialize(Model.LoginsPerDay.Select(x => x.Date.ToString("dd MMM yyyy")))'
            data-values='@JsonSerializer.Serialize(Model.LoginsPerDay.Select(x => x.Count))'>
    </canvas>
  </div>
</div>

<div class="pm-card pm-shadow p-3">
  <h5 class="mb-3">Top users by logins</h5>
  <table class="table table-sm">
    <thead><tr><th>User</th><th>Last login</th><th>Total logins</th></tr></thead>
    <tbody>
      @foreach (var u in Model.TopUsers)
      { <tr><td>@u.UserName</td><td>@TimeFmt.ToIst(u.LastLogin)</td><td>@u.Count</td></tr> }
    </tbody>
  </table>
</div>

@section Scripts {
  <script src="~/lib/chart.js/chart.umd.js"></script>
  <script type="module" src="~/js/charts/analytics.js"></script>
}
