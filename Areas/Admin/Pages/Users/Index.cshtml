@page
@model ProjectManagement.Areas.Admin.Pages.Users.IndexModel
<h3>Users
  <a class="ms-1 text-decoration-none" asp-area="Admin" asp-page="/Help/Index" asp-fragment="user-lifecycle" title="Help">
    <i class="bi bi-question-circle"></i>
  </a>
</h3>
<p><a class="btn btn-primary" asp-page="Create">Create user</a></p>
<input id="userSearch" class="form-control mb-3" type="search" placeholder="Search by username or role" />
<table class="table table-sm" id="usersTable">
  <thead>
    <tr>
      <th scope="col">UserName</th>
      <th scope="col">Rank</th>
      <th scope="col">Full Name</th>
      <th scope="col">Roles</th>
      <th scope="col">Last login</th>
      <th scope="col">Total logins</th>
      <th scope="col">Status</th>
      <th scope="col" class="text-end">Actions</th>
    </tr>
  </thead>
  <tbody>
  @foreach (var row in Model.Users)
  {
    <tr>
      <td class="text-start">@row.UserName</td>
      <td>@row.Rank</td>
      <td>@row.FullName</td>
      <td class="text-start">
        @foreach (var r in row.Roles)
        {
          <span class="badge bg-secondary me-1">@r</span>
        }
      </td>
      <td>@(row.LastLogin?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
      <td>@row.LoginCount</td>
      <td>
        @if (row.PendingDeletion && row.DeletionRequestedUtc.HasValue)
        {
            var due = row.DeletionRequestedUtc.Value.AddMinutes(Model.Options.UndoWindowMinutes);
            <span class="badge bg-warning">Pending deletion</span>
            <small class="text-muted">@due.ToString("yyyy-MM-dd HH:mm")</small>
        }
        else if (row.IsActive)
        {
            <span class="badge bg-success">Active</span>
        }
        else
        {
            <span class="badge bg-danger">Disabled</span>
        }
      </td>
      <td class="text-end">
        <div class="d-flex justify-content-end gap-1">
          <a asp-page="Edit" asp-route-id="@row.Id" class="btn btn-sm btn-outline-secondary" title="Edit user">Edit</a>
          <a asp-page="Reset" asp-route-id="@row.Id" class="btn btn-sm btn-outline-secondary" title="Reset password">Reset</a>
          @if (!row.PendingDeletion)
          {
            if (row.IsActive)
            {
                <a asp-page="Disable" asp-route-id="@row.Id" class="btn btn-sm btn-outline-warning" title="Disable user">Disable</a>
            }
            else
            {
                <a asp-page="Enable" asp-route-id="@row.Id" class="btn btn-sm btn-outline-success" title="Enable user">Enable</a>
            }
            if ((DateTime.UtcNow - row.CreatedUtc).TotalHours <= Model.Options.HardDeleteWindowHours)
            {
                <a asp-page="Delete" asp-route-id="@row.Id" class="btn btn-sm btn-outline-danger" title="Delete user">Delete</a>
            }
          }
          else if (row.DeletionRequestedUtc.HasValue)
          {
            var due = row.DeletionRequestedUtc.Value.AddMinutes(Model.Options.UndoWindowMinutes);
            if (DateTime.UtcNow < due)
            {
                <form method="post" asp-page="Delete" asp-page-handler="Undo" asp-route-id="@row.Id" class="d-inline">
                  <button type="submit" class="btn btn-sm btn-outline-danger" title="Undo delete">Undo</button>
                </form>
            }
          }
        </div>
      </td>
    </tr>
  }
  </tbody>
</table>

@section Scripts {
    <script type="module" src="~/js/users/index.js" asp-append-version="true"></script>
}
