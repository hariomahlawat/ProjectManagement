@page
@model ProjectManagement.Areas.Admin.Pages.Users.IndexModel

<nav aria-label="breadcrumb" class="mb-2">
  <ol class="breadcrumb small mb-0">
    <li class="breadcrumb-item"><a asp-area="Admin" asp-page="/Index">Admin</a></li>
    <li class="breadcrumb-item active" aria-current="page">Users</li>
  </ol>
</nav>
<h3 class="mb-2">Users
  <a class="ms-1 text-decoration-none" asp-area="Admin" asp-page="/Help/Index" asp-fragment="user-lifecycle" title="Help">
    <i class="bi bi-question-circle"></i>
  </a>
</h3>

<form method="get" class="row g-2 align-items-end mb-2">
  <div class="col-md-5">
    <label class="form-label small">Search</label>
    <input name="q" value="@Model.Q" class="form-control form-control-sm" placeholder="Name or email">
  </div>
  <div class="col-md-3">
    <label class="form-label small">Role</label>
    <select name="role" class="form-select form-select-sm">
      <option value="">All</option>
      @foreach (var r in Model.AllRoles) {
        <option value="@r" selected="@(Model.Role==r)">@r</option>
      }
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label small">Status</label>
    <select name="status" class="form-select form-select-sm">
      <option value="">All</option>
      <option value="active" selected="@(Model.Status=="active")">Active</option>
      <option value="disabled" selected="@(Model.Status=="disabled")">Disabled</option>
    </select>
  </div>
  <div class="col-md-2 d-grid">
    <button class="btn btn-sm btn-primary">Apply</button>
  </div>
</form>

<div class="d-flex justify-content-between mb-2">
  <a class="btn btn-primary btn-sm" asp-page="Create">Create user</a>
  <a class="btn btn-sm btn-outline-secondary"
     asp-page-handler="Export" asp-route-q="@Model.Q" asp-route-role="@Model.Role" asp-route-status="@Model.Status">
    Export CSV
  </a>
</div>

<table class="table table-sm">
  <thead>
    <tr>
      <th scope="col">UserName</th>
      <th scope="col">Rank</th>
      <th scope="col">Full Name</th>
      <th scope="col">Roles</th>
      <th scope="col">Last login</th>
      <th scope="col">Total logins</th>
      <th scope="col">Status</th>
      <th scope="col" class="text-end">Actions</th>
    </tr>
  </thead>
  <tbody>
  @foreach (var row in Model.Users)
  {
    <tr>
      <td class="text-start">@row.UserName</td>
      <td>@row.Rank</td>
      <td>@row.FullName</td>
      <td class="text-start">
        @foreach (var r in row.Roles)
        {
          <span class="badge bg-light text-dark border me-1">@r</span>
        }
      </td>
      <td>@TimeFmt.ToIst(row.LastLogin)</td>
      <td>@row.LoginCount</td>
      <td>
        @if (row.IsDisabled)
        { <span class="badge bg-danger">Disabled</span> }
        else
        { <span class="badge bg-success">Active</span> }
      </td>
      <td class="text-end">
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">Actions</button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" asp-page="Edit" asp-route-id="@row.Id">Edit</a></li>
            <li><a class="dropdown-item" asp-page="Reset" asp-route-id="@row.Id">Reset password</a></li>
            @if (row.IsDisabled)
            {
              <li><a class="dropdown-item" asp-page="Enable" asp-route-id="@row.Id">Enable</a></li>
            }
            else
            {
              <li><a class="dropdown-item" asp-page="Disable" asp-route-id="@row.Id">Disable</a></li>
            }
            @if ((DateTime.UtcNow - row.CreatedUtc).TotalHours <= Model.Options.HardDeleteWindowHours)
            {
              <li><hr class="dropdown-divider" /></li>
              <li><a class="dropdown-item text-danger" asp-page="Delete" asp-route-id="@row.Id">Delete</a></li>
            }
          </ul>
        </div>
      </td>
    </tr>
  }
  @if (!Model.Users.Any())
  {
    <tr>
      <td colspan="8" class="text-center text-muted py-4">
        No users match your filters. Adjust filters or <a asp-page="Create">create a user</a>.
      </td>
    </tr>
  }
  </tbody>
</table>
